
> @spooky/spooky-ts@0.0.0 test /Users/khadim/dev/spooky/packages/spooky-ts
> vitest "test/sync.test.ts"


 DEV  v3.2.4 /Users/khadim/dev/spooky/packages/spooky-ts

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:42:38.761Z] [INFO] [Provisioning] Starting provision check...

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:42:38.764Z] [DEBUG] [Provisioning] Schema hash: 36219f6c156e8612442cf558e26fc4750fa5daf8
[2025-11-30T13:42:38.764Z] [DEBUG] [Provisioning] Schema up to date: false
[2025-11-30T13:42:38.764Z] [DEBUG] [Provisioning] Should migrate: true
[2025-11-30T13:42:38.764Z] [INFO] [Provisioning] Initializing internal database schema...

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:42:38.764Z] [INFO] [Provisioning] Starting schema migration...

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:42:38.769Z] [DEBUG] [Provisioning] Recording schema hash...

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:42:38.769Z] [INFO] [Provisioning] Database schema provisioned successfully

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[buildQuery] Generated SELECT query: SELECT * FROM thread;
[buildQuery] Query vars: {}
[buildQuery] Generated SELECT query: SELECT * FROM thread;
[buildQuery] Query vars: {}
[buildQuery] Generated LIVE SELECT query: LIVE SELECT * FROM thread;
[buildQuery] Query vars: {}
[2025-11-30T13:42:38.810Z] [DEBUG] [QueryManager] Run - Cache miss { queryHash: [33m5287015697723528[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:42:38.811Z] [DEBUG] [QueryManager] Run - Initialize query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:42:38.811Z] [DEBUG] [QueryManager] Run - Refresh query locally { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:42:38.811Z] [DEBUG] [QueryManager] Local Query Refresh - Starting { queryHash: [33m5287015697723528[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:42:38.811Z] [DEBUG] [Database] Query Local Database - Result { sql: [32m'SELECT * FROM thread;'[39m, vars: [90mundefined[39m, result: [ [] ] }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:42:38.811Z] [DEBUG] [QueryManager] Local Query Refresh - Done { queryHash: [33m5287015697723528[39m, resultLength: [33m0[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:42:38.812Z] [DEBUG] [Database] Query Local Database - Result {
  sql: [32m'RETURN crypto::blake3($data)'[39m,
  vars: { data: [32m'[]'[39m },
  result: [
    [32m'd53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab'[39m
  ]
}

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:42:38.812Z] [DEBUG] [QueryManager] Local Query Refresh - Decoded results { decodedResults: [] }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:42:38.812Z] [DEBUG] [QueryManager] Run - Hydrate remote query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:42:38.812Z] [DEBUG] [QueryManager] Remote Query Hydration - Starting { queryHash: [33m5287015697723528[39m, query: [32m'SELECT * FROM thread;'[39m }
[DEBUG] Fetching remote hash with query: RETURN crypto::blake3({ SELECT * FROM thread })

stderr | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[DEBUG] Remote hash fetch failed: RemoteDatabaseError: Failed to execute query on remote database
    at Object.queryRemote [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/database.ts:110:13[90m)[39m
    at QueryManagerService.queryRemoteHydration [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:378:22[90m)[39m
    at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:628:9[90m)[39m {
  cause: ResponseError: Incorrect arguments for function crypto::blake3(). Argument 1 was the wrong type. Expected a string but found NONE
      at Query.collect (file:///Users/khadim/dev/spooky/node_modules/[4m.pnpm[24m/surrealdb@2.0.0-alpha.14_tslib@2.8.1_typescript@5.9.3/node_modules/[4msurrealdb[24m/dist/surrealdb.mjs:3135:27)
      at Object.queryRemote [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/database.ts:89:11[90m)[39m
      at QueryManagerService.queryRemoteHydration [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:378:22[90m)[39m
      at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:628:9[90m)[39m {
    code: [33m0[39m
  }
}

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:42:38.815Z] [WARN] [QueryManager] Remote Query Hydration - Failed to get remote hash (falling back to full fetch) RemoteDatabaseError: Failed to execute query on remote database
    at Object.queryRemote [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/database.ts:110:13[90m)[39m
    at QueryManagerService.queryRemoteHydration [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:378:22[90m)[39m
    at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:628:9[90m)[39m {
  cause: ResponseError: Incorrect arguments for function crypto::blake3(). Argument 1 was the wrong type. Expected a string but found NONE
      at Query.collect (file:///Users/khadim/dev/spooky/node_modules/[4m.pnpm[24m/surrealdb@2.0.0-alpha.14_tslib@2.8.1_typescript@5.9.3/node_modules/[4msurrealdb[24m/dist/surrealdb.mjs:3135:27)
      at Object.queryRemote [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/database.ts:89:11[90m)[39m
      at QueryManagerService.queryRemoteHydration [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:378:22[90m)[39m
      at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:628:9[90m)[39m {
    code: [33m0[39m
  }
}
[DEBUG] Comparing hashes. Local: d53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab Remote: [90mundefined[39m
[2025-11-30T13:42:38.815Z] [DEBUG] [QueryManager] Remote Query Hydration - Hash mismatch or missing, fetching data {
  queryHash: [33m5287015697723528[39m,
  localHash: [32m'd53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab'[39m,
  remoteHash: [90mundefined[39m
}

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:42:38.815Z] [DEBUG] [Database] Query Remote Database - Result { sql: [32m'SELECT * FROM thread;'[39m, vars: [90mundefined[39m, result: [ [] ] }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:42:38.815Z] [DEBUG] [QueryManager] Remote Query Hydration - Remote query done { queryHash: [33m5287015697723528[39m, resultLength: [33m0[39m }
[2025-11-30T13:42:38.815Z] [DEBUG] [QueryManager] Materialize remote record update - Starting { records: [33m0[39m }
[2025-11-30T13:42:38.815Z] [DEBUG] [QueryManager] Materialize remote record update - Updating local cache { records: [33m0[39m, materializeQuery: [32m''[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:42:38.815Z] [DEBUG] [Database] Query Local Database - Result { sql: [32m''[39m, vars: [90mundefined[39m, result: [] }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:42:38.815Z] [DEBUG] [QueryManager] Materialize remote record update - Done { records: [33m0[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:42:38.815Z] [DEBUG] [QueryManager] Remote Query Hydration - Local cache updated { queryHash: [33m5287015697723528[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:42:38.816Z] [DEBUG] [Database] Query Local Database - Result { sql: [32m'SELECT * FROM thread;'[39m, vars: [90mundefined[39m, result: [ [] ] }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:42:38.816Z] [DEBUG] [QueryManager] Remote Query Hydration - Local cache updated { queryHash: [33m5287015697723528[39m, resultLength: [33m0[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:42:38.816Z] [DEBUG] [QueryManager] Run - Subscribe to remote query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:42:38.816Z] [DEBUG] [QueryManager] Subscribe Remote Query - Starting { queryHash: [33m5287015697723528[39m, query: [32m'LIVE SELECT * FROM thread;'[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:42:38.816Z] [DEBUG] [Database] Query Remote Database - Result {
  sql: [32m'LIVE SELECT * FROM thread;'[39m,
  vars: [90mundefined[39m,
  result: [ Uuid {} ]
}

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:42:38.816Z] [DEBUG] [QueryManager] Subscribe Remote Query - Created Live UUID { queryHash: [33m5287015697723528[39m, liveUuid: Uuid {} }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:42:38.816Z] [WARN] [QueryManager] Remote subscription failed (continuing with local data) RemoteDatabaseError: Failed to execute live on remote database
    at Object.subscribeLiveOfRemote [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/database.ts:177:13[90m)[39m
    at QueryManagerService.subscribeRemoteQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:586:32[90m)[39m
    at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:642:9[90m)[39m {
  cause: TypeError: db.liveQuery is not a function
      at Object.subscribeLiveOfRemote [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/database.ts:161:36[90m)[39m
      at QueryManagerService.subscribeRemoteQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:586:32[90m)[39m
      at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:642:9[90m)[39m
}
[2025-11-30T13:42:38.816Z] [DEBUG] [QueryManager] Run - Initialize subqueries [33m5287015697723528[39m

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:42:48.756Z] [INFO] [Provisioning] Starting provision check...

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:42:48.756Z] [DEBUG] [Provisioning] Schema hash: 36219f6c156e8612442cf558e26fc4750fa5daf8
[2025-11-30T13:42:48.756Z] [DEBUG] [Provisioning] Schema up to date: false
[2025-11-30T13:42:48.756Z] [DEBUG] [Provisioning] Should migrate: true
[2025-11-30T13:42:48.756Z] [INFO] [Provisioning] Initializing internal database schema...

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:42:48.757Z] [INFO] [Provisioning] Starting schema migration...

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:42:48.763Z] [DEBUG] [Provisioning] Recording schema hash...

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:42:48.763Z] [INFO] [Provisioning] Database schema provisioned successfully

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[buildQuery] Generated SELECT query: SELECT * FROM thread;
[buildQuery] Query vars: {}
[buildQuery] Generated SELECT query: SELECT * FROM thread;
[buildQuery] Query vars: {}
[buildQuery] Generated LIVE SELECT query: LIVE SELECT * FROM thread;
[buildQuery] Query vars: {}
[2025-11-30T13:42:48.816Z] [DEBUG] [QueryManager] Run - Cache miss { queryHash: [33m5287015697723528[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:42:48.816Z] [DEBUG] [QueryManager] Run - Initialize query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:42:48.816Z] [DEBUG] [QueryManager] Run - Refresh query locally { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:42:48.816Z] [DEBUG] [QueryManager] Local Query Refresh - Starting { queryHash: [33m5287015697723528[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:42:48.816Z] [DEBUG] [Database] Query Local Database - Result { sql: [32m'SELECT * FROM thread;'[39m, vars: [90mundefined[39m, result: [ [] ] }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:42:48.816Z] [DEBUG] [QueryManager] Local Query Refresh - Done { queryHash: [33m5287015697723528[39m, resultLength: [33m0[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:42:48.816Z] [DEBUG] [Database] Query Local Database - Result {
  sql: [32m'RETURN crypto::blake3($data)'[39m,
  vars: { data: [32m'[]'[39m },
  result: [
    [32m'd53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab'[39m
  ]
}

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:42:48.817Z] [DEBUG] [QueryManager] Local Query Refresh - Decoded results { decodedResults: [] }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:42:48.817Z] [DEBUG] [QueryManager] Run - Hydrate remote query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:42:48.817Z] [DEBUG] [QueryManager] Remote Query Hydration - Starting { queryHash: [33m5287015697723528[39m, query: [32m'SELECT * FROM thread;'[39m }
[DEBUG] Fetching remote hash with query: RETURN crypto::blake3({ SELECT * FROM thread })

stderr | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[DEBUG] Remote hash fetch failed: RemoteDatabaseError: Failed to execute query on remote database
    at Object.queryRemote [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/database.ts:110:13[90m)[39m
    at QueryManagerService.queryRemoteHydration [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:378:22[90m)[39m
    at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:628:9[90m)[39m {
  cause: ResponseError: Incorrect arguments for function crypto::blake3(). Argument 1 was the wrong type. Expected a string but found NONE
      at Query.collect (file:///Users/khadim/dev/spooky/node_modules/[4m.pnpm[24m/surrealdb@2.0.0-alpha.14_tslib@2.8.1_typescript@5.9.3/node_modules/[4msurrealdb[24m/dist/surrealdb.mjs:3135:27)
      at Object.queryRemote [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/database.ts:89:11[90m)[39m
      at QueryManagerService.queryRemoteHydration [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:378:22[90m)[39m
      at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:628:9[90m)[39m {
    code: [33m0[39m
  }
}

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:42:48.817Z] [WARN] [QueryManager] Remote Query Hydration - Failed to get remote hash (falling back to full fetch) RemoteDatabaseError: Failed to execute query on remote database
    at Object.queryRemote [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/database.ts:110:13[90m)[39m
    at QueryManagerService.queryRemoteHydration [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:378:22[90m)[39m
    at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:628:9[90m)[39m {
  cause: ResponseError: Incorrect arguments for function crypto::blake3(). Argument 1 was the wrong type. Expected a string but found NONE
      at Query.collect (file:///Users/khadim/dev/spooky/node_modules/[4m.pnpm[24m/surrealdb@2.0.0-alpha.14_tslib@2.8.1_typescript@5.9.3/node_modules/[4msurrealdb[24m/dist/surrealdb.mjs:3135:27)
      at Object.queryRemote [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/database.ts:89:11[90m)[39m
      at QueryManagerService.queryRemoteHydration [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:378:22[90m)[39m
      at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:628:9[90m)[39m {
    code: [33m0[39m
  }
}
[DEBUG] Comparing hashes. Local: d53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab Remote: [90mundefined[39m
[2025-11-30T13:42:48.817Z] [DEBUG] [QueryManager] Remote Query Hydration - Hash mismatch or missing, fetching data {
  queryHash: [33m5287015697723528[39m,
  localHash: [32m'd53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab'[39m,
  remoteHash: [90mundefined[39m
}

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:42:48.817Z] [DEBUG] [Database] Query Remote Database - Result { sql: [32m'SELECT * FROM thread;'[39m, vars: [90mundefined[39m, result: [ [] ] }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:42:48.817Z] [DEBUG] [QueryManager] Remote Query Hydration - Remote query done { queryHash: [33m5287015697723528[39m, resultLength: [33m0[39m }
[2025-11-30T13:42:48.817Z] [DEBUG] [QueryManager] Materialize remote record update - Starting { records: [33m0[39m }
[2025-11-30T13:42:48.817Z] [DEBUG] [QueryManager] Materialize remote record update - Updating local cache { records: [33m0[39m, materializeQuery: [32m''[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:42:48.818Z] [DEBUG] [Database] Query Local Database - Result { sql: [32m''[39m, vars: [90mundefined[39m, result: [] }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:42:48.818Z] [DEBUG] [QueryManager] Materialize remote record update - Done { records: [33m0[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:42:48.818Z] [DEBUG] [QueryManager] Remote Query Hydration - Local cache updated { queryHash: [33m5287015697723528[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:42:48.818Z] [DEBUG] [Database] Query Local Database - Result { sql: [32m'SELECT * FROM thread;'[39m, vars: [90mundefined[39m, result: [ [] ] }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:42:48.818Z] [DEBUG] [QueryManager] Remote Query Hydration - Local cache updated { queryHash: [33m5287015697723528[39m, resultLength: [33m0[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:42:48.818Z] [DEBUG] [QueryManager] Run - Subscribe to remote query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:42:48.818Z] [DEBUG] [QueryManager] Subscribe Remote Query - Starting { queryHash: [33m5287015697723528[39m, query: [32m'LIVE SELECT * FROM thread;'[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:42:48.818Z] [DEBUG] [Database] Query Remote Database - Result {
  sql: [32m'LIVE SELECT * FROM thread;'[39m,
  vars: [90mundefined[39m,
  result: [ Uuid {} ]
}

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:42:48.818Z] [DEBUG] [QueryManager] Subscribe Remote Query - Created Live UUID { queryHash: [33m5287015697723528[39m, liveUuid: Uuid {} }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:42:48.818Z] [WARN] [QueryManager] Remote subscription failed (continuing with local data) RemoteDatabaseError: Failed to execute live on remote database
    at Object.subscribeLiveOfRemote [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/database.ts:177:13[90m)[39m
    at QueryManagerService.subscribeRemoteQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:586:32[90m)[39m
    at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:642:9[90m)[39m {
  cause: TypeError: db.liveQuery is not a function
      at Object.subscribeLiveOfRemote [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/database.ts:161:36[90m)[39m
      at QueryManagerService.subscribeRemoteQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:586:32[90m)[39m
      at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:642:9[90m)[39m
}
[2025-11-30T13:42:48.819Z] [DEBUG] [QueryManager] Run - Initialize subqueries [33m5287015697723528[39m

 â¯ test/sync.test.ts (2 tests | 2 failed) 20006ms
   Ã— Sync Protocol > should fetch data on initial sync (hash mismatch) 10003ms
     â†’ Test timed out in 10000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".
   Ã— Sync Protocol > should NOT fetch data if hashes match 10002ms
     â†’ Test timed out in 10000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".

â¯â¯â¯â¯â¯â¯â¯ Failed Tests 2 â¯â¯â¯â¯â¯â¯â¯

 FAIL  test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
Error: Test timed out in 10000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".
 â¯ test/sync.test.ts:22:5
     20| 
     21| describe("Sync Protocol", () => {
     22|     it("should fetch data on initial sync (hash mismatch)", async () =â€¦
       |     ^
     23|         const { spooky, dbContext } = await createMockSpooky(mockConfiâ€¦
     24|         try {

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[1/2]â¯

 FAIL  test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
Error: Test timed out in 10000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".
 â¯ test/sync.test.ts:74:5
     72|     }, 10000);
     73| 
     74|     it("should NOT fetch data if hashes match", async () => {
       |     ^
     75|         const { spooky, dbContext } = await createMockSpooky(mockConfiâ€¦
     76|         try {

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[2/2]â¯


 Test Files  1 failed (1)
      Tests  2 failed (2)
   Start at  14:42:38
   Duration  20.42s (transform 82ms, setup 120ms, collect 118ms, tests 20.01s, environment 0ms, prepare 38ms)

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  src/services/query-manager.ts x1 
        Filename pattern: test/sync.test.ts


â¯â¯â¯â¯â¯â¯ Failed Suites 1 â¯â¯â¯â¯â¯â¯â¯

 FAIL  test/sync.test.ts [ test/sync.test.ts ]
Error: Transform failed with 1 error:
/Users/khadim/dev/spooky/packages/spooky-ts/src/services/query-manager.ts:397:10: ERROR: Expected ";" but found "async"
  Plugin: vite:esbuild
  File: /Users/khadim/dev/spooky/packages/spooky-ts/src/services/query-manager.ts:397:10
  
  Expected ";" but found "async"
  395|      // ...
  396|  
  397|    private async subscribeRemoteQuery<
     |            ^
  398|        T extends { columns: Record<string, ColumnSchema> }
  399|      >(query: InnerQuery<T, boolean>): Promise<void> {
  
 â¯ failureErrorWithLog ../../node_modules/.pnpm/esbuild@0.21.5/node_modules/esbuild/lib/main.js:1472:15
 â¯ ../../node_modules/.pnpm/esbuild@0.21.5/node_modules/esbuild/lib/main.js:755:50
 â¯ responseCallbacks.<computed> ../../node_modules/.pnpm/esbuild@0.21.5/node_modules/esbuild/lib/main.js:622:9
 â¯ handleIncomingPacket ../../node_modules/.pnpm/esbuild@0.21.5/node_modules/esbuild/lib/main.js:677:12
 â¯ Socket.readFromStdout ../../node_modules/.pnpm/esbuild@0.21.5/node_modules/esbuild/lib/main.js:600:7

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[1/1]â¯


 Test Files  1 failed (1)
      Tests  no tests
   Start at  14:44:43
   Duration  147ms

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  src/services/query-manager.ts x2 
        Filename pattern: test/sync.test.ts

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:45:50.718Z] [INFO] [Provisioning] Starting provision check...

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:45:50.727Z] [DEBUG] [Provisioning] Schema hash: 36219f6c156e8612442cf558e26fc4750fa5daf8
[2025-11-30T13:45:50.727Z] [DEBUG] [Provisioning] Schema up to date: false
[2025-11-30T13:45:50.727Z] [DEBUG] [Provisioning] Should migrate: true
[2025-11-30T13:45:50.727Z] [INFO] [Provisioning] Initializing internal database schema...

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:45:50.729Z] [INFO] [Provisioning] Starting schema migration...

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:45:50.734Z] [DEBUG] [Provisioning] Recording schema hash...

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:45:50.736Z] [INFO] [Provisioning] Database schema provisioned successfully

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[buildQuery] Generated SELECT query: SELECT * FROM thread;
[buildQuery] Query vars: {}
[buildQuery] Generated SELECT query: SELECT * FROM thread;
[buildQuery] Query vars: {}
[buildQuery] Generated LIVE SELECT query: LIVE SELECT * FROM thread;
[buildQuery] Query vars: {}
[2025-11-30T13:45:50.778Z] [DEBUG] [QueryManager] Run - Cache miss { queryHash: [33m5287015697723528[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:45:50.779Z] [DEBUG] [QueryManager] Run - Initialize query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:45:50.779Z] [DEBUG] [QueryManager] Run - Refresh query locally { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:45:50.779Z] [DEBUG] [QueryManager] Local Query Refresh - Starting { queryHash: [33m5287015697723528[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:45:50.780Z] [DEBUG] [Database] Query Local Database - Result { sql: [32m'SELECT * FROM thread;'[39m, vars: [90mundefined[39m, result: [ [] ] }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:45:50.780Z] [DEBUG] [QueryManager] Local Query Refresh - Done { queryHash: [33m5287015697723528[39m, resultLength: [33m0[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:45:50.780Z] [DEBUG] [Database] Query Local Database - Result {
  sql: [32m'RETURN crypto::blake3($data)'[39m,
  vars: { data: [32m'[]'[39m },
  result: [
    [32m'd53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab'[39m
  ]
}

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:45:50.780Z] [DEBUG] [QueryManager] Local Query Refresh - Decoded results { decodedResults: [] }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:45:50.780Z] [DEBUG] [QueryManager] Run - Hydrate remote query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:45:50.780Z] [DEBUG] [QueryManager] Remote Query Hydration - Starting { queryHash: [33m5287015697723528[39m, query: [32m'SELECT * FROM thread;'[39m }
[DEBUG] Fetching remote hash with query: RETURN crypto::blake3(string::json({ SELECT * FROM thread }))

stderr | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[DEBUG] Remote hash fetch failed: RemoteDatabaseError: Failed to execute query on remote database
    at Object.queryRemote [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/database.ts:110:13[90m)[39m
    at QueryManagerService.queryRemoteHydration [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:379:22[90m)[39m
    at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:629:9[90m)[39m {
  cause: [Error: There was a problem with the database: Parse error: Invalid function/constant path, did you maybe mean `string::join`
   --> [1:23]
    |
  1 | RETURN crypto::blake3(string::json({ SELECT * FROM thread }))
    |                       ^^^^^^^^^^^^ 
  ] {
    code: [32m'GenericFailure'[39m
  }
}

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:45:50.782Z] [WARN] [QueryManager] Remote Query Hydration - Failed to get remote hash (falling back to full fetch) RemoteDatabaseError: Failed to execute query on remote database
    at Object.queryRemote [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/database.ts:110:13[90m)[39m
    at QueryManagerService.queryRemoteHydration [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:379:22[90m)[39m
    at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:629:9[90m)[39m {
  cause: [Error: There was a problem with the database: Parse error: Invalid function/constant path, did you maybe mean `string::join`
   --> [1:23]
    |
  1 | RETURN crypto::blake3(string::json({ SELECT * FROM thread }))
    |                       ^^^^^^^^^^^^ 
  ] {
    code: [32m'GenericFailure'[39m
  }
}
[DEBUG] Comparing hashes. Local: d53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab Remote: [90mundefined[39m
[2025-11-30T13:45:50.782Z] [DEBUG] [QueryManager] Remote Query Hydration - Hash mismatch or missing, fetching data {
  queryHash: [33m5287015697723528[39m,
  localHash: [32m'd53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab'[39m,
  remoteHash: [90mundefined[39m
}

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:45:50.782Z] [DEBUG] [Database] Query Remote Database - Result { sql: [32m'SELECT * FROM thread;'[39m, vars: [90mundefined[39m, result: [ [] ] }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:45:50.783Z] [DEBUG] [QueryManager] Remote Query Hydration - Remote query done { queryHash: [33m5287015697723528[39m, resultLength: [33m0[39m }
[2025-11-30T13:45:50.783Z] [DEBUG] [QueryManager] Materialize remote record update - Starting { records: [33m0[39m }
[2025-11-30T13:45:50.783Z] [DEBUG] [QueryManager] Materialize remote record update - Updating local cache { records: [33m0[39m, materializeQuery: [32m''[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:45:50.783Z] [DEBUG] [Database] Query Local Database - Result { sql: [32m''[39m, vars: [90mundefined[39m, result: [] }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:45:50.783Z] [DEBUG] [QueryManager] Materialize remote record update - Done { records: [33m0[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:45:50.783Z] [DEBUG] [QueryManager] Remote Query Hydration - Local cache updated { queryHash: [33m5287015697723528[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:45:50.783Z] [DEBUG] [Database] Query Local Database - Result { sql: [32m'SELECT * FROM thread;'[39m, vars: [90mundefined[39m, result: [ [] ] }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:45:50.783Z] [DEBUG] [QueryManager] Remote Query Hydration - Local cache updated { queryHash: [33m5287015697723528[39m, resultLength: [33m0[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:45:50.783Z] [DEBUG] [QueryManager] Run - Subscribe to remote query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:45:50.783Z] [DEBUG] [QueryManager] Subscribe Remote Query - Starting { queryHash: [33m5287015697723528[39m, query: [32m'LIVE SELECT * FROM thread;'[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:45:50.783Z] [DEBUG] [Database] Query Remote Database - Result {
  sql: [32m'LIVE SELECT * FROM thread;'[39m,
  vars: [90mundefined[39m,
  result: [ Uuid {} ]
}

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:45:50.783Z] [DEBUG] [QueryManager] Subscribe Remote Query - Created Live UUID { queryHash: [33m5287015697723528[39m, liveUuid: Uuid {} }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:45:50.784Z] [WARN] [QueryManager] Remote subscription failed (continuing with local data) RemoteDatabaseError: Failed to execute live on remote database
    at Object.subscribeLiveOfRemote [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/database.ts:177:13[90m)[39m
    at QueryManagerService.subscribeRemoteQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:587:32[90m)[39m
    at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:643:9[90m)[39m {
  cause: TypeError: db.liveQuery is not a function
      at Object.subscribeLiveOfRemote [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/database.ts:161:36[90m)[39m
      at QueryManagerService.subscribeRemoteQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:587:32[90m)[39m
      at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:643:9[90m)[39m
}
[2025-11-30T13:45:50.784Z] [DEBUG] [QueryManager] Run - Initialize subqueries [33m5287015697723528[39m

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:46:00.711Z] [INFO] [Provisioning] Starting provision check...

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:46:00.714Z] [DEBUG] [Provisioning] Schema hash: 36219f6c156e8612442cf558e26fc4750fa5daf8
[2025-11-30T13:46:00.714Z] [DEBUG] [Provisioning] Schema up to date: false
[2025-11-30T13:46:00.714Z] [DEBUG] [Provisioning] Should migrate: true
[2025-11-30T13:46:00.714Z] [INFO] [Provisioning] Initializing internal database schema...

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:46:00.715Z] [INFO] [Provisioning] Starting schema migration...

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:46:00.726Z] [DEBUG] [Provisioning] Recording schema hash...

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:46:00.727Z] [INFO] [Provisioning] Database schema provisioned successfully

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[buildQuery] Generated SELECT query: SELECT * FROM thread;
[buildQuery] Query vars: {}
[buildQuery] Generated SELECT query: SELECT * FROM thread;
[buildQuery] Query vars: {}
[buildQuery] Generated LIVE SELECT query: LIVE SELECT * FROM thread;
[buildQuery] Query vars: {}
[2025-11-30T13:46:00.786Z] [DEBUG] [QueryManager] Run - Cache miss { queryHash: [33m5287015697723528[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:46:00.787Z] [DEBUG] [QueryManager] Run - Initialize query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:46:00.787Z] [DEBUG] [QueryManager] Run - Refresh query locally { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:46:00.787Z] [DEBUG] [QueryManager] Local Query Refresh - Starting { queryHash: [33m5287015697723528[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:46:00.787Z] [DEBUG] [Database] Query Local Database - Result { sql: [32m'SELECT * FROM thread;'[39m, vars: [90mundefined[39m, result: [ [] ] }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:46:00.787Z] [DEBUG] [QueryManager] Local Query Refresh - Done { queryHash: [33m5287015697723528[39m, resultLength: [33m0[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:46:00.787Z] [DEBUG] [Database] Query Local Database - Result {
  sql: [32m'RETURN crypto::blake3($data)'[39m,
  vars: { data: [32m'[]'[39m },
  result: [
    [32m'd53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab'[39m
  ]
}

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:46:00.787Z] [DEBUG] [QueryManager] Local Query Refresh - Decoded results { decodedResults: [] }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:46:00.787Z] [DEBUG] [QueryManager] Run - Hydrate remote query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:46:00.787Z] [DEBUG] [QueryManager] Remote Query Hydration - Starting { queryHash: [33m5287015697723528[39m, query: [32m'SELECT * FROM thread;'[39m }
[DEBUG] Fetching remote hash with query: RETURN crypto::blake3(string::json({ SELECT * FROM thread }))

stderr | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[DEBUG] Remote hash fetch failed: RemoteDatabaseError: Failed to execute query on remote database
    at Object.queryRemote [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/database.ts:110:13[90m)[39m
    at QueryManagerService.queryRemoteHydration [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:379:22[90m)[39m
    at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:629:9[90m)[39m {
  cause: [Error: There was a problem with the database: Parse error: Invalid function/constant path, did you maybe mean `string::join`
   --> [1:23]
    |
  1 | RETURN crypto::blake3(string::json({ SELECT * FROM thread }))
    |                       ^^^^^^^^^^^^ 
  ] {
    code: [32m'GenericFailure'[39m
  }
}

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:46:00.788Z] [WARN] [QueryManager] Remote Query Hydration - Failed to get remote hash (falling back to full fetch) RemoteDatabaseError: Failed to execute query on remote database
    at Object.queryRemote [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/database.ts:110:13[90m)[39m
    at QueryManagerService.queryRemoteHydration [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:379:22[90m)[39m
    at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:629:9[90m)[39m {
  cause: [Error: There was a problem with the database: Parse error: Invalid function/constant path, did you maybe mean `string::join`
   --> [1:23]
    |
  1 | RETURN crypto::blake3(string::json({ SELECT * FROM thread }))
    |                       ^^^^^^^^^^^^ 
  ] {
    code: [32m'GenericFailure'[39m
  }
}
[DEBUG] Comparing hashes. Local: d53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab Remote: [90mundefined[39m
[2025-11-30T13:46:00.788Z] [DEBUG] [QueryManager] Remote Query Hydration - Hash mismatch or missing, fetching data {
  queryHash: [33m5287015697723528[39m,
  localHash: [32m'd53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab'[39m,
  remoteHash: [90mundefined[39m
}

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:46:00.788Z] [DEBUG] [Database] Query Remote Database - Result { sql: [32m'SELECT * FROM thread;'[39m, vars: [90mundefined[39m, result: [ [] ] }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:46:00.788Z] [DEBUG] [QueryManager] Remote Query Hydration - Remote query done { queryHash: [33m5287015697723528[39m, resultLength: [33m0[39m }
[2025-11-30T13:46:00.788Z] [DEBUG] [QueryManager] Materialize remote record update - Starting { records: [33m0[39m }
[2025-11-30T13:46:00.788Z] [DEBUG] [QueryManager] Materialize remote record update - Updating local cache { records: [33m0[39m, materializeQuery: [32m''[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:46:00.789Z] [DEBUG] [Database] Query Local Database - Result { sql: [32m''[39m, vars: [90mundefined[39m, result: [] }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:46:00.789Z] [DEBUG] [QueryManager] Materialize remote record update - Done { records: [33m0[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:46:00.789Z] [DEBUG] [QueryManager] Remote Query Hydration - Local cache updated { queryHash: [33m5287015697723528[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:46:00.789Z] [DEBUG] [Database] Query Local Database - Result { sql: [32m'SELECT * FROM thread;'[39m, vars: [90mundefined[39m, result: [ [] ] }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:46:00.789Z] [DEBUG] [QueryManager] Remote Query Hydration - Local cache updated { queryHash: [33m5287015697723528[39m, resultLength: [33m0[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:46:00.789Z] [DEBUG] [QueryManager] Run - Subscribe to remote query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:46:00.789Z] [DEBUG] [QueryManager] Subscribe Remote Query - Starting { queryHash: [33m5287015697723528[39m, query: [32m'LIVE SELECT * FROM thread;'[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:46:00.789Z] [DEBUG] [Database] Query Remote Database - Result {
  sql: [32m'LIVE SELECT * FROM thread;'[39m,
  vars: [90mundefined[39m,
  result: [ Uuid {} ]
}

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:46:00.789Z] [DEBUG] [QueryManager] Subscribe Remote Query - Created Live UUID { queryHash: [33m5287015697723528[39m, liveUuid: Uuid {} }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:46:00.789Z] [WARN] [QueryManager] Remote subscription failed (continuing with local data) RemoteDatabaseError: Failed to execute live on remote database
    at Object.subscribeLiveOfRemote [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/database.ts:177:13[90m)[39m
    at QueryManagerService.subscribeRemoteQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:587:32[90m)[39m
    at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:643:9[90m)[39m {
  cause: TypeError: db.liveQuery is not a function
      at Object.subscribeLiveOfRemote [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/database.ts:161:36[90m)[39m
      at QueryManagerService.subscribeRemoteQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:587:32[90m)[39m
      at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:643:9[90m)[39m
}
[2025-11-30T13:46:00.790Z] [DEBUG] [QueryManager] Run - Initialize subqueries [33m5287015697723528[39m

 â¯ test/sync.test.ts (2 tests | 2 failed) 20011ms
   Ã— Sync Protocol > should fetch data on initial sync (hash mismatch) 10006ms
     â†’ Test timed out in 10000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".
   Ã— Sync Protocol > should NOT fetch data if hashes match 10004ms
     â†’ Test timed out in 10000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".

â¯â¯â¯â¯â¯â¯â¯ Failed Tests 2 â¯â¯â¯â¯â¯â¯â¯

 FAIL  test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
Error: Test timed out in 10000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".
 â¯ test/sync.test.ts:22:5
     20| 
     21| describe("Sync Protocol", () => {
     22|     it("should fetch data on initial sync (hash mismatch)", async () =â€¦
       |     ^
     23|         const { spooky, dbContext } = await createMockSpooky(mockConfiâ€¦
     24|         try {

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[1/2]â¯

 FAIL  test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
Error: Test timed out in 10000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".
 â¯ test/sync.test.ts:74:5
     72|     }, 10000);
     73| 
     74|     it("should NOT fetch data if hashes match", async () => {
       |     ^
     75|         const { spooky, dbContext } = await createMockSpooky(mockConfiâ€¦
     76|         try {

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[2/2]â¯


 Test Files  1 failed (1)
      Tests  2 failed (2)
   Start at  14:45:50
   Duration  20.24s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  src/services/database.ts x3 
        Filename pattern: test/sync.test.ts

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:47:14.523Z] [INFO] [Provisioning] Starting provision check...

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:47:14.532Z] [DEBUG] [Provisioning] Schema hash: 36219f6c156e8612442cf558e26fc4750fa5daf8
[2025-11-30T13:47:14.532Z] [DEBUG] [Provisioning] Schema up to date: false
[2025-11-30T13:47:14.532Z] [DEBUG] [Provisioning] Should migrate: true
[2025-11-30T13:47:14.532Z] [INFO] [Provisioning] Initializing internal database schema...

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:47:14.534Z] [INFO] [Provisioning] Starting schema migration...

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:47:14.539Z] [DEBUG] [Provisioning] Recording schema hash...

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:47:14.540Z] [INFO] [Provisioning] Database schema provisioned successfully

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[buildQuery] Generated SELECT query: SELECT * FROM thread;
[buildQuery] Query vars: {}
[buildQuery] Generated SELECT query: SELECT * FROM thread;
[buildQuery] Query vars: {}
[buildQuery] Generated LIVE SELECT query: LIVE SELECT * FROM thread;
[buildQuery] Query vars: {}
[2025-11-30T13:47:14.582Z] [DEBUG] [QueryManager] Run - Cache miss { queryHash: [33m5287015697723528[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:47:14.583Z] [DEBUG] [QueryManager] Run - Initialize query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:47:14.583Z] [DEBUG] [QueryManager] Run - Refresh query locally { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:47:14.583Z] [DEBUG] [QueryManager] Local Query Refresh - Starting { queryHash: [33m5287015697723528[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:47:14.583Z] [DEBUG] [Database] Query Local Database - Result { sql: [32m'SELECT * FROM thread;'[39m, vars: [90mundefined[39m, result: [ [] ] }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:47:14.584Z] [DEBUG] [QueryManager] Local Query Refresh - Done { queryHash: [33m5287015697723528[39m, resultLength: [33m0[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:47:14.584Z] [DEBUG] [Database] Query Local Database - Result {
  sql: [32m'RETURN crypto::blake3($data)'[39m,
  vars: { data: [32m'[]'[39m },
  result: [
    [32m'd53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab'[39m
  ]
}

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:47:14.584Z] [DEBUG] [QueryManager] Local Query Refresh - Decoded results { decodedResults: [] }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:47:14.584Z] [DEBUG] [QueryManager] Run - Hydrate remote query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:47:14.585Z] [DEBUG] [QueryManager] Remote Query Hydration - Starting { queryHash: [33m5287015697723528[39m, query: [32m'SELECT * FROM thread;'[39m }
[DEBUG] Fetching remote hash with query: RETURN crypto::blake3(string::json({ SELECT * FROM thread }))

stderr | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[DEBUG] Remote hash fetch failed: RemoteDatabaseError: Failed to execute query on remote database
    at Object.queryRemote [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/database.ts:110:13[90m)[39m
    at QueryManagerService.queryRemoteHydration [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:379:22[90m)[39m
    at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:629:9[90m)[39m {
  cause: [Error: There was a problem with the database: Parse error: Invalid function/constant path, did you maybe mean `string::join`
   --> [1:23]
    |
  1 | RETURN crypto::blake3(string::json({ SELECT * FROM thread }))
    |                       ^^^^^^^^^^^^ 
  ] {
    code: [32m'GenericFailure'[39m
  }
}

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:47:14.586Z] [WARN] [QueryManager] Remote Query Hydration - Failed to get remote hash (falling back to full fetch) RemoteDatabaseError: Failed to execute query on remote database
    at Object.queryRemote [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/database.ts:110:13[90m)[39m
    at QueryManagerService.queryRemoteHydration [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:379:22[90m)[39m
    at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:629:9[90m)[39m {
  cause: [Error: There was a problem with the database: Parse error: Invalid function/constant path, did you maybe mean `string::join`
   --> [1:23]
    |
  1 | RETURN crypto::blake3(string::json({ SELECT * FROM thread }))
    |                       ^^^^^^^^^^^^ 
  ] {
    code: [32m'GenericFailure'[39m
  }
}
[DEBUG] Comparing hashes. Local: d53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab Remote: [90mundefined[39m
[2025-11-30T13:47:14.586Z] [DEBUG] [QueryManager] Remote Query Hydration - Hash mismatch or missing, fetching data {
  queryHash: [33m5287015697723528[39m,
  localHash: [32m'd53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab'[39m,
  remoteHash: [90mundefined[39m
}

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:47:14.587Z] [DEBUG] [Database] Query Remote Database - Result { sql: [32m'SELECT * FROM thread;'[39m, vars: [90mundefined[39m, result: [ [] ] }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:47:14.587Z] [DEBUG] [QueryManager] Remote Query Hydration - Remote query done { queryHash: [33m5287015697723528[39m, resultLength: [33m0[39m }
[2025-11-30T13:47:14.587Z] [DEBUG] [QueryManager] Materialize remote record update - Starting { records: [33m0[39m }
[2025-11-30T13:47:14.587Z] [DEBUG] [QueryManager] Materialize remote record update - Updating local cache { records: [33m0[39m, materializeQuery: [32m''[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:47:14.587Z] [DEBUG] [Database] Query Local Database - Result { sql: [32m''[39m, vars: [90mundefined[39m, result: [] }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:47:14.587Z] [DEBUG] [QueryManager] Materialize remote record update - Done { records: [33m0[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:47:14.587Z] [DEBUG] [QueryManager] Remote Query Hydration - Local cache updated { queryHash: [33m5287015697723528[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:47:14.587Z] [DEBUG] [Database] Query Local Database - Result { sql: [32m'SELECT * FROM thread;'[39m, vars: [90mundefined[39m, result: [ [] ] }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:47:14.587Z] [DEBUG] [QueryManager] Remote Query Hydration - Local cache updated { queryHash: [33m5287015697723528[39m, resultLength: [33m0[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:47:14.587Z] [DEBUG] [QueryManager] Run - Subscribe to remote query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:47:14.587Z] [DEBUG] [QueryManager] Subscribe Remote Query - Starting { queryHash: [33m5287015697723528[39m, query: [32m'LIVE SELECT * FROM thread;'[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:47:14.588Z] [DEBUG] [Database] Query Remote Database - Result {
  sql: [32m'LIVE SELECT * FROM thread;'[39m,
  vars: [90mundefined[39m,
  result: [ Uuid {} ]
}

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:47:14.588Z] [DEBUG] [QueryManager] Subscribe Remote Query - Created Live UUID { queryHash: [33m5287015697723528[39m, liveUuid: Uuid {} }

stderr | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[Database] liveQuery method not found on Surreal instance. Live updates will not work.

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:47:14.588Z] [DEBUG] [QueryManager] Subscribe Remote Query - Subscribed to Live UUID { queryHash: [33m5287015697723528[39m, liveUuid: Uuid {} }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:47:14.588Z] [DEBUG] [QueryManager] Run - Initialize subqueries [33m5287015697723528[39m

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:47:24.521Z] [INFO] [Provisioning] Starting provision check...

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:47:24.522Z] [DEBUG] [Provisioning] Schema hash: 36219f6c156e8612442cf558e26fc4750fa5daf8
[2025-11-30T13:47:24.523Z] [DEBUG] [Provisioning] Schema up to date: false
[2025-11-30T13:47:24.523Z] [DEBUG] [Provisioning] Should migrate: true
[2025-11-30T13:47:24.523Z] [INFO] [Provisioning] Initializing internal database schema...

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:47:24.524Z] [INFO] [Provisioning] Starting schema migration...

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:47:24.534Z] [DEBUG] [Provisioning] Recording schema hash...

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:47:24.534Z] [INFO] [Provisioning] Database schema provisioned successfully

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[buildQuery] Generated SELECT query: SELECT * FROM thread;
[buildQuery] Query vars: {}
[buildQuery] Generated SELECT query: SELECT * FROM thread;
[buildQuery] Query vars: {}
[buildQuery] Generated LIVE SELECT query: LIVE SELECT * FROM thread;
[buildQuery] Query vars: {}
[2025-11-30T13:47:24.593Z] [DEBUG] [QueryManager] Run - Cache miss { queryHash: [33m5287015697723528[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:47:24.593Z] [DEBUG] [QueryManager] Run - Initialize query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:47:24.593Z] [DEBUG] [QueryManager] Run - Refresh query locally { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:47:24.593Z] [DEBUG] [QueryManager] Local Query Refresh - Starting { queryHash: [33m5287015697723528[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:47:24.593Z] [DEBUG] [Database] Query Local Database - Result { sql: [32m'SELECT * FROM thread;'[39m, vars: [90mundefined[39m, result: [ [] ] }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:47:24.593Z] [DEBUG] [QueryManager] Local Query Refresh - Done { queryHash: [33m5287015697723528[39m, resultLength: [33m0[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:47:24.593Z] [DEBUG] [Database] Query Local Database - Result {
  sql: [32m'RETURN crypto::blake3($data)'[39m,
  vars: { data: [32m'[]'[39m },
  result: [
    [32m'd53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab'[39m
  ]
}

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:47:24.594Z] [DEBUG] [QueryManager] Local Query Refresh - Decoded results { decodedResults: [] }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:47:24.594Z] [DEBUG] [QueryManager] Run - Hydrate remote query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:47:24.594Z] [DEBUG] [QueryManager] Remote Query Hydration - Starting { queryHash: [33m5287015697723528[39m, query: [32m'SELECT * FROM thread;'[39m }
[DEBUG] Fetching remote hash with query: RETURN crypto::blake3(string::json({ SELECT * FROM thread }))

stderr | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[DEBUG] Remote hash fetch failed: RemoteDatabaseError: Failed to execute query on remote database
    at Object.queryRemote [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/database.ts:110:13[90m)[39m
    at QueryManagerService.queryRemoteHydration [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:379:22[90m)[39m
    at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:629:9[90m)[39m {
  cause: [Error: There was a problem with the database: Parse error: Invalid function/constant path, did you maybe mean `string::join`
   --> [1:23]
    |
  1 | RETURN crypto::blake3(string::json({ SELECT * FROM thread }))
    |                       ^^^^^^^^^^^^ 
  ] {
    code: [32m'GenericFailure'[39m
  }
}

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:47:24.594Z] [WARN] [QueryManager] Remote Query Hydration - Failed to get remote hash (falling back to full fetch) RemoteDatabaseError: Failed to execute query on remote database
    at Object.queryRemote [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/database.ts:110:13[90m)[39m
    at QueryManagerService.queryRemoteHydration [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:379:22[90m)[39m
    at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:629:9[90m)[39m {
  cause: [Error: There was a problem with the database: Parse error: Invalid function/constant path, did you maybe mean `string::join`
   --> [1:23]
    |
  1 | RETURN crypto::blake3(string::json({ SELECT * FROM thread }))
    |                       ^^^^^^^^^^^^ 
  ] {
    code: [32m'GenericFailure'[39m
  }
}
[DEBUG] Comparing hashes. Local: d53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab Remote: [90mundefined[39m
[2025-11-30T13:47:24.594Z] [DEBUG] [QueryManager] Remote Query Hydration - Hash mismatch or missing, fetching data {
  queryHash: [33m5287015697723528[39m,
  localHash: [32m'd53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab'[39m,
  remoteHash: [90mundefined[39m
}

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:47:24.595Z] [DEBUG] [Database] Query Remote Database - Result { sql: [32m'SELECT * FROM thread;'[39m, vars: [90mundefined[39m, result: [ [] ] }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:47:24.595Z] [DEBUG] [QueryManager] Remote Query Hydration - Remote query done { queryHash: [33m5287015697723528[39m, resultLength: [33m0[39m }
[2025-11-30T13:47:24.595Z] [DEBUG] [QueryManager] Materialize remote record update - Starting { records: [33m0[39m }
[2025-11-30T13:47:24.595Z] [DEBUG] [QueryManager] Materialize remote record update - Updating local cache { records: [33m0[39m, materializeQuery: [32m''[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:47:24.595Z] [DEBUG] [Database] Query Local Database - Result { sql: [32m''[39m, vars: [90mundefined[39m, result: [] }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:47:24.595Z] [DEBUG] [QueryManager] Materialize remote record update - Done { records: [33m0[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:47:24.595Z] [DEBUG] [QueryManager] Remote Query Hydration - Local cache updated { queryHash: [33m5287015697723528[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:47:24.595Z] [DEBUG] [Database] Query Local Database - Result { sql: [32m'SELECT * FROM thread;'[39m, vars: [90mundefined[39m, result: [ [] ] }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:47:24.595Z] [DEBUG] [QueryManager] Remote Query Hydration - Local cache updated { queryHash: [33m5287015697723528[39m, resultLength: [33m0[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:47:24.595Z] [DEBUG] [QueryManager] Run - Subscribe to remote query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:47:24.595Z] [DEBUG] [QueryManager] Subscribe Remote Query - Starting { queryHash: [33m5287015697723528[39m, query: [32m'LIVE SELECT * FROM thread;'[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:47:24.595Z] [DEBUG] [Database] Query Remote Database - Result {
  sql: [32m'LIVE SELECT * FROM thread;'[39m,
  vars: [90mundefined[39m,
  result: [ Uuid {} ]
}

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:47:24.595Z] [DEBUG] [QueryManager] Subscribe Remote Query - Created Live UUID { queryHash: [33m5287015697723528[39m, liveUuid: Uuid {} }

stderr | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[Database] liveQuery method not found on Surreal instance. Live updates will not work.

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:47:24.596Z] [DEBUG] [QueryManager] Subscribe Remote Query - Subscribed to Live UUID { queryHash: [33m5287015697723528[39m, liveUuid: Uuid {} }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:47:24.596Z] [DEBUG] [QueryManager] Run - Initialize subqueries [33m5287015697723528[39m

 â¯ test/sync.test.ts (2 tests | 2 failed) 20012ms
   Ã— Sync Protocol > should fetch data on initial sync (hash mismatch) 10008ms
     â†’ Test timed out in 10000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".
   Ã— Sync Protocol > should NOT fetch data if hashes match 10003ms
     â†’ Test timed out in 10000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".

â¯â¯â¯â¯â¯â¯â¯ Failed Tests 2 â¯â¯â¯â¯â¯â¯â¯

 FAIL  test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
Error: Test timed out in 10000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".
 â¯ test/sync.test.ts:22:5
     20| 
     21| describe("Sync Protocol", () => {
     22|     it("should fetch data on initial sync (hash mismatch)", async () =â€¦
       |     ^
     23|         const { spooky, dbContext } = await createMockSpooky(mockConfiâ€¦
     24|         try {

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[1/2]â¯

 FAIL  test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
Error: Test timed out in 10000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".
 â¯ test/sync.test.ts:74:5
     72|     }, 10000);
     73| 
     74|     it("should NOT fetch data if hashes match", async () => {
       |     ^
     75|         const { spooky, dbContext } = await createMockSpooky(mockConfiâ€¦
     76|         try {

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[2/2]â¯


 Test Files  1 failed (1)
      Tests  2 failed (2)
   Start at  14:47:14
   Duration  20.22s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  test/sync.test.ts x4 
        Filename pattern: test/sync.test.ts

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:47:49.004Z] [INFO] [Provisioning] Starting provision check...

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:47:49.006Z] [DEBUG] [Provisioning] Schema hash: 36219f6c156e8612442cf558e26fc4750fa5daf8
[2025-11-30T13:47:49.006Z] [DEBUG] [Provisioning] Schema up to date: false
[2025-11-30T13:47:49.006Z] [DEBUG] [Provisioning] Should migrate: true
[2025-11-30T13:47:49.006Z] [INFO] [Provisioning] Initializing internal database schema...

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:47:49.007Z] [INFO] [Provisioning] Starting schema migration...

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:47:49.013Z] [DEBUG] [Provisioning] Recording schema hash...

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:47:49.014Z] [INFO] [Provisioning] Database schema provisioned successfully

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
Create Result: [90mundefined[39m

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
Thread Check: [90mundefined[39m

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[buildQuery] Generated SELECT query: SELECT * FROM thread;
[buildQuery] Query vars: {}
[buildQuery] Generated SELECT query: SELECT * FROM thread;
[buildQuery] Query vars: {}
[buildQuery] Generated LIVE SELECT query: LIVE SELECT * FROM thread;
[buildQuery] Query vars: {}
[2025-11-30T13:47:49.055Z] [DEBUG] [QueryManager] Run - Cache miss { queryHash: [33m5287015697723528[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:47:49.055Z] [DEBUG] [QueryManager] Run - Initialize query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:47:49.055Z] [DEBUG] [QueryManager] Run - Refresh query locally { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:47:49.055Z] [DEBUG] [QueryManager] Local Query Refresh - Starting { queryHash: [33m5287015697723528[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:47:49.056Z] [DEBUG] [Database] Query Local Database - Result { sql: [32m'SELECT * FROM thread;'[39m, vars: [90mundefined[39m, result: [ [] ] }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:47:49.056Z] [DEBUG] [QueryManager] Local Query Refresh - Done { queryHash: [33m5287015697723528[39m, resultLength: [33m0[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:47:49.056Z] [DEBUG] [Database] Query Local Database - Result {
  sql: [32m'RETURN crypto::blake3($data)'[39m,
  vars: { data: [32m'[]'[39m },
  result: [
    [32m'd53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab'[39m
  ]
}

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:47:49.057Z] [DEBUG] [QueryManager] Local Query Refresh - Decoded results { decodedResults: [] }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:47:49.057Z] [DEBUG] [QueryManager] Run - Hydrate remote query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:47:49.057Z] [DEBUG] [QueryManager] Remote Query Hydration - Starting { queryHash: [33m5287015697723528[39m, query: [32m'SELECT * FROM thread;'[39m }
[DEBUG] Fetching remote hash with query: RETURN crypto::blake3(string::json({ SELECT * FROM thread }))

stderr | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[DEBUG] Remote hash fetch failed: RemoteDatabaseError: Failed to execute query on remote database
    at Object.queryRemote [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/database.ts:110:13[90m)[39m
    at QueryManagerService.queryRemoteHydration [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:379:22[90m)[39m
    at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:629:9[90m)[39m {
  cause: [Error: There was a problem with the database: Parse error: Invalid function/constant path, did you maybe mean `string::join`
   --> [1:23]
    |
  1 | RETURN crypto::blake3(string::json({ SELECT * FROM thread }))
    |                       ^^^^^^^^^^^^ 
  ] {
    code: [32m'GenericFailure'[39m
  }
}

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:47:49.058Z] [WARN] [QueryManager] Remote Query Hydration - Failed to get remote hash (falling back to full fetch) RemoteDatabaseError: Failed to execute query on remote database
    at Object.queryRemote [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/database.ts:110:13[90m)[39m
    at QueryManagerService.queryRemoteHydration [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:379:22[90m)[39m
    at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:629:9[90m)[39m {
  cause: [Error: There was a problem with the database: Parse error: Invalid function/constant path, did you maybe mean `string::join`
   --> [1:23]
    |
  1 | RETURN crypto::blake3(string::json({ SELECT * FROM thread }))
    |                       ^^^^^^^^^^^^ 
  ] {
    code: [32m'GenericFailure'[39m
  }
}
[DEBUG] Comparing hashes. Local: d53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab Remote: [90mundefined[39m
[2025-11-30T13:47:49.058Z] [DEBUG] [QueryManager] Remote Query Hydration - Hash mismatch or missing, fetching data {
  queryHash: [33m5287015697723528[39m,
  localHash: [32m'd53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab'[39m,
  remoteHash: [90mundefined[39m
}

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:47:49.059Z] [DEBUG] [Database] Query Remote Database - Result { sql: [32m'SELECT * FROM thread;'[39m, vars: [90mundefined[39m, result: [ [] ] }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:47:49.059Z] [DEBUG] [QueryManager] Remote Query Hydration - Remote query done { queryHash: [33m5287015697723528[39m, resultLength: [33m0[39m }
[2025-11-30T13:47:49.059Z] [DEBUG] [QueryManager] Materialize remote record update - Starting { records: [33m0[39m }
[2025-11-30T13:47:49.059Z] [DEBUG] [QueryManager] Materialize remote record update - Updating local cache { records: [33m0[39m, materializeQuery: [32m''[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:47:49.059Z] [DEBUG] [Database] Query Local Database - Result { sql: [32m''[39m, vars: [90mundefined[39m, result: [] }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:47:49.059Z] [DEBUG] [QueryManager] Materialize remote record update - Done { records: [33m0[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:47:49.059Z] [DEBUG] [QueryManager] Remote Query Hydration - Local cache updated { queryHash: [33m5287015697723528[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:47:49.059Z] [DEBUG] [Database] Query Local Database - Result { sql: [32m'SELECT * FROM thread;'[39m, vars: [90mundefined[39m, result: [ [] ] }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:47:49.059Z] [DEBUG] [QueryManager] Remote Query Hydration - Local cache updated { queryHash: [33m5287015697723528[39m, resultLength: [33m0[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:47:49.059Z] [DEBUG] [QueryManager] Run - Subscribe to remote query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:47:49.059Z] [DEBUG] [QueryManager] Subscribe Remote Query - Starting { queryHash: [33m5287015697723528[39m, query: [32m'LIVE SELECT * FROM thread;'[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:47:49.060Z] [DEBUG] [Database] Query Remote Database - Result {
  sql: [32m'LIVE SELECT * FROM thread;'[39m,
  vars: [90mundefined[39m,
  result: [ Uuid {} ]
}

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:47:49.060Z] [DEBUG] [QueryManager] Subscribe Remote Query - Created Live UUID { queryHash: [33m5287015697723528[39m, liveUuid: Uuid {} }

stderr | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[Database] liveQuery method not found on Surreal instance. Live updates will not work.

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:47:49.060Z] [DEBUG] [QueryManager] Subscribe Remote Query - Subscribed to Live UUID { queryHash: [33m5287015697723528[39m, liveUuid: Uuid {} }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:47:49.060Z] [DEBUG] [QueryManager] Run - Initialize subqueries [33m5287015697723528[39m

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:47:58.997Z] [INFO] [Provisioning] Starting provision check...

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:47:58.997Z] [DEBUG] [Provisioning] Schema hash: 36219f6c156e8612442cf558e26fc4750fa5daf8
[2025-11-30T13:47:58.998Z] [DEBUG] [Provisioning] Schema up to date: false
[2025-11-30T13:47:58.998Z] [DEBUG] [Provisioning] Should migrate: true
[2025-11-30T13:47:58.998Z] [INFO] [Provisioning] Initializing internal database schema...

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:47:58.998Z] [INFO] [Provisioning] Starting schema migration...

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:47:59.003Z] [DEBUG] [Provisioning] Recording schema hash...

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:47:59.003Z] [INFO] [Provisioning] Database schema provisioned successfully

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[buildQuery] Generated SELECT query: SELECT * FROM thread;
[buildQuery] Query vars: {}
[buildQuery] Generated SELECT query: SELECT * FROM thread;
[buildQuery] Query vars: {}
[buildQuery] Generated LIVE SELECT query: LIVE SELECT * FROM thread;
[buildQuery] Query vars: {}
[2025-11-30T13:47:59.047Z] [DEBUG] [QueryManager] Run - Cache miss { queryHash: [33m5287015697723528[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:47:59.047Z] [DEBUG] [QueryManager] Run - Initialize query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:47:59.047Z] [DEBUG] [QueryManager] Run - Refresh query locally { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:47:59.047Z] [DEBUG] [QueryManager] Local Query Refresh - Starting { queryHash: [33m5287015697723528[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:47:59.047Z] [DEBUG] [Database] Query Local Database - Result { sql: [32m'SELECT * FROM thread;'[39m, vars: [90mundefined[39m, result: [ [] ] }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:47:59.048Z] [DEBUG] [QueryManager] Local Query Refresh - Done { queryHash: [33m5287015697723528[39m, resultLength: [33m0[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:47:59.048Z] [DEBUG] [Database] Query Local Database - Result {
  sql: [32m'RETURN crypto::blake3($data)'[39m,
  vars: { data: [32m'[]'[39m },
  result: [
    [32m'd53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab'[39m
  ]
}

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:47:59.048Z] [DEBUG] [QueryManager] Local Query Refresh - Decoded results { decodedResults: [] }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:47:59.048Z] [DEBUG] [QueryManager] Run - Hydrate remote query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:47:59.048Z] [DEBUG] [QueryManager] Remote Query Hydration - Starting { queryHash: [33m5287015697723528[39m, query: [32m'SELECT * FROM thread;'[39m }
[DEBUG] Fetching remote hash with query: RETURN crypto::blake3(string::json({ SELECT * FROM thread }))

stderr | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[DEBUG] Remote hash fetch failed: RemoteDatabaseError: Failed to execute query on remote database
    at Object.queryRemote [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/database.ts:110:13[90m)[39m
    at QueryManagerService.queryRemoteHydration [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:379:22[90m)[39m
    at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:629:9[90m)[39m {
  cause: [Error: There was a problem with the database: Parse error: Invalid function/constant path, did you maybe mean `string::join`
   --> [1:23]
    |
  1 | RETURN crypto::blake3(string::json({ SELECT * FROM thread }))
    |                       ^^^^^^^^^^^^ 
  ] {
    code: [32m'GenericFailure'[39m
  }
}

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:47:59.048Z] [WARN] [QueryManager] Remote Query Hydration - Failed to get remote hash (falling back to full fetch) RemoteDatabaseError: Failed to execute query on remote database
    at Object.queryRemote [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/database.ts:110:13[90m)[39m
    at QueryManagerService.queryRemoteHydration [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:379:22[90m)[39m
    at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:629:9[90m)[39m {
  cause: [Error: There was a problem with the database: Parse error: Invalid function/constant path, did you maybe mean `string::join`
   --> [1:23]
    |
  1 | RETURN crypto::blake3(string::json({ SELECT * FROM thread }))
    |                       ^^^^^^^^^^^^ 
  ] {
    code: [32m'GenericFailure'[39m
  }
}
[DEBUG] Comparing hashes. Local: d53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab Remote: [90mundefined[39m
[2025-11-30T13:47:59.048Z] [DEBUG] [QueryManager] Remote Query Hydration - Hash mismatch or missing, fetching data {
  queryHash: [33m5287015697723528[39m,
  localHash: [32m'd53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab'[39m,
  remoteHash: [90mundefined[39m
}

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:47:59.049Z] [DEBUG] [Database] Query Remote Database - Result { sql: [32m'SELECT * FROM thread;'[39m, vars: [90mundefined[39m, result: [ [] ] }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:47:59.049Z] [DEBUG] [QueryManager] Remote Query Hydration - Remote query done { queryHash: [33m5287015697723528[39m, resultLength: [33m0[39m }
[2025-11-30T13:47:59.049Z] [DEBUG] [QueryManager] Materialize remote record update - Starting { records: [33m0[39m }
[2025-11-30T13:47:59.049Z] [DEBUG] [QueryManager] Materialize remote record update - Updating local cache { records: [33m0[39m, materializeQuery: [32m''[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:47:59.049Z] [DEBUG] [Database] Query Local Database - Result { sql: [32m''[39m, vars: [90mundefined[39m, result: [] }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:47:59.049Z] [DEBUG] [QueryManager] Materialize remote record update - Done { records: [33m0[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:47:59.049Z] [DEBUG] [QueryManager] Remote Query Hydration - Local cache updated { queryHash: [33m5287015697723528[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:47:59.049Z] [DEBUG] [Database] Query Local Database - Result { sql: [32m'SELECT * FROM thread;'[39m, vars: [90mundefined[39m, result: [ [] ] }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:47:59.049Z] [DEBUG] [QueryManager] Remote Query Hydration - Local cache updated { queryHash: [33m5287015697723528[39m, resultLength: [33m0[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:47:59.049Z] [DEBUG] [QueryManager] Run - Subscribe to remote query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:47:59.049Z] [DEBUG] [QueryManager] Subscribe Remote Query - Starting { queryHash: [33m5287015697723528[39m, query: [32m'LIVE SELECT * FROM thread;'[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:47:59.049Z] [DEBUG] [Database] Query Remote Database - Result {
  sql: [32m'LIVE SELECT * FROM thread;'[39m,
  vars: [90mundefined[39m,
  result: [ Uuid {} ]
}

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:47:59.049Z] [DEBUG] [QueryManager] Subscribe Remote Query - Created Live UUID { queryHash: [33m5287015697723528[39m, liveUuid: Uuid {} }

stderr | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[Database] liveQuery method not found on Surreal instance. Live updates will not work.

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:47:59.050Z] [DEBUG] [QueryManager] Subscribe Remote Query - Subscribed to Live UUID { queryHash: [33m5287015697723528[39m, liveUuid: Uuid {} }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:47:59.050Z] [DEBUG] [QueryManager] Run - Initialize subqueries [33m5287015697723528[39m

 â¯ test/sync.test.ts (2 tests | 2 failed) 20005ms
   Ã— Sync Protocol > should fetch data on initial sync (hash mismatch) 10003ms
     â†’ Test timed out in 10000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".
   Ã— Sync Protocol > should NOT fetch data if hashes match 10002ms
     â†’ Test timed out in 10000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".

â¯â¯â¯â¯â¯â¯â¯ Failed Tests 2 â¯â¯â¯â¯â¯â¯â¯

 FAIL  test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
Error: Test timed out in 10000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".
 â¯ test/sync.test.ts:22:5
     20| 
     21| describe("Sync Protocol", () => {
     22|     it("should fetch data on initial sync (hash mismatch)", async () =â€¦
       |     ^
     23|         const { spooky, dbContext } = await createMockSpooky(mockConfiâ€¦
     24|         try {

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[1/2]â¯

 FAIL  test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
Error: Test timed out in 10000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".
 â¯ test/sync.test.ts:79:5
     77|     }, 10000);
     78| 
     79|     it("should NOT fetch data if hashes match", async () => {
       |     ^
     80|         const { spooky, dbContext } = await createMockSpooky(mockConfiâ€¦
     81|         try {

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[2/2]â¯


 Test Files  1 failed (1)
      Tests  2 failed (2)
   Start at  14:47:48
   Duration  20.18s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  test/sync.test.ts x5 
        Filename pattern: test/sync.test.ts

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:50:01.553Z] [INFO] [Provisioning] Starting provision check...

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:50:01.556Z] [DEBUG] [Provisioning] Schema hash: 36219f6c156e8612442cf558e26fc4750fa5daf8
[2025-11-30T13:50:01.556Z] [DEBUG] [Provisioning] Schema up to date: false
[2025-11-30T13:50:01.556Z] [DEBUG] [Provisioning] Should migrate: true
[2025-11-30T13:50:01.556Z] [INFO] [Provisioning] Initializing internal database schema...

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:50:01.557Z] [INFO] [Provisioning] Starting schema migration...

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:50:01.562Z] [DEBUG] [Provisioning] Recording schema hash...

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:50:01.563Z] [INFO] [Provisioning] Database schema provisioned successfully

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
Create Result: [90mundefined[39m

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
Thread Check: [90mundefined[39m

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[buildQuery] Generated SELECT query: SELECT * FROM thread;
[buildQuery] Query vars: {}
[buildQuery] Generated SELECT query: SELECT * FROM thread;
[buildQuery] Query vars: {}
[buildQuery] Generated LIVE SELECT query: LIVE SELECT * FROM thread;
[buildQuery] Query vars: {}
[2025-11-30T13:50:01.606Z] [DEBUG] [QueryManager] Run - Cache miss { queryHash: [33m5287015697723528[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:50:01.607Z] [DEBUG] [QueryManager] Run - Initialize query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:50:01.607Z] [DEBUG] [QueryManager] Run - Refresh query locally { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:50:01.607Z] [DEBUG] [QueryManager] Local Query Refresh - Starting { queryHash: [33m5287015697723528[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:50:01.607Z] [DEBUG] [Database] Query Local Database - Result { sql: [32m'SELECT * FROM thread;'[39m, vars: [90mundefined[39m, result: [ [] ] }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:50:01.607Z] [DEBUG] [QueryManager] Local Query Refresh - Done { queryHash: [33m5287015697723528[39m, resultLength: [33m0[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:50:01.608Z] [DEBUG] [Database] Query Local Database - Result {
  sql: [32m'RETURN crypto::blake3($data)'[39m,
  vars: { data: [32m'[]'[39m },
  result: [
    [32m'd53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab'[39m
  ]
}

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:50:01.608Z] [DEBUG] [QueryManager] Local Query Refresh - Decoded results { decodedResults: [] }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:50:01.608Z] [DEBUG] [QueryManager] Run - Hydrate remote query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:50:01.608Z] [DEBUG] [QueryManager] Remote Query Hydration - Starting { queryHash: [33m5287015697723528[39m, query: [32m'SELECT * FROM thread;'[39m }
[DEBUG] Fetching remote hash with query: RETURN crypto::blake3(string::json({ SELECT * FROM thread }))

stderr | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[DEBUG] Remote hash fetch failed: RemoteDatabaseError: Failed to execute query on remote database
    at Object.queryRemote [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/database.ts:110:13[90m)[39m
    at QueryManagerService.queryRemoteHydration [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:379:22[90m)[39m
    at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:629:9[90m)[39m {
  cause: [Error: There was a problem with the database: Parse error: Invalid function/constant path, did you maybe mean `string::join`
   --> [1:23]
    |
  1 | RETURN crypto::blake3(string::json({ SELECT * FROM thread }))
    |                       ^^^^^^^^^^^^ 
  ] {
    code: [32m'GenericFailure'[39m
  }
}

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:50:01.610Z] [WARN] [QueryManager] Remote Query Hydration - Failed to get remote hash (falling back to full fetch) RemoteDatabaseError: Failed to execute query on remote database
    at Object.queryRemote [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/database.ts:110:13[90m)[39m
    at QueryManagerService.queryRemoteHydration [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:379:22[90m)[39m
    at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:629:9[90m)[39m {
  cause: [Error: There was a problem with the database: Parse error: Invalid function/constant path, did you maybe mean `string::join`
   --> [1:23]
    |
  1 | RETURN crypto::blake3(string::json({ SELECT * FROM thread }))
    |                       ^^^^^^^^^^^^ 
  ] {
    code: [32m'GenericFailure'[39m
  }
}
[DEBUG] Comparing hashes. Local: d53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab Remote: [90mundefined[39m
[2025-11-30T13:50:01.610Z] [DEBUG] [QueryManager] Remote Query Hydration - Hash mismatch or missing, fetching data {
  queryHash: [33m5287015697723528[39m,
  localHash: [32m'd53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab'[39m,
  remoteHash: [90mundefined[39m
}

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:50:01.610Z] [DEBUG] [Database] Query Remote Database - Result { sql: [32m'SELECT * FROM thread;'[39m, vars: [90mundefined[39m, result: [ [] ] }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:50:01.610Z] [DEBUG] [QueryManager] Remote Query Hydration - Remote query done { queryHash: [33m5287015697723528[39m, resultLength: [33m0[39m }
[2025-11-30T13:50:01.610Z] [DEBUG] [QueryManager] Materialize remote record update - Starting { records: [33m0[39m }
[2025-11-30T13:50:01.610Z] [DEBUG] [QueryManager] Materialize remote record update - Updating local cache { records: [33m0[39m, materializeQuery: [32m''[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:50:01.610Z] [DEBUG] [Database] Query Local Database - Result { sql: [32m''[39m, vars: [90mundefined[39m, result: [] }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:50:01.610Z] [DEBUG] [QueryManager] Materialize remote record update - Done { records: [33m0[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:50:01.611Z] [DEBUG] [QueryManager] Remote Query Hydration - Local cache updated { queryHash: [33m5287015697723528[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:50:01.611Z] [DEBUG] [Database] Query Local Database - Result { sql: [32m'SELECT * FROM thread;'[39m, vars: [90mundefined[39m, result: [ [] ] }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:50:01.611Z] [DEBUG] [QueryManager] Remote Query Hydration - Local cache updated { queryHash: [33m5287015697723528[39m, resultLength: [33m0[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:50:01.611Z] [DEBUG] [QueryManager] Run - Subscribe to remote query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:50:01.611Z] [DEBUG] [QueryManager] Subscribe Remote Query - Starting { queryHash: [33m5287015697723528[39m, query: [32m'LIVE SELECT * FROM thread;'[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:50:01.611Z] [DEBUG] [Database] Query Remote Database - Result {
  sql: [32m'LIVE SELECT * FROM thread;'[39m,
  vars: [90mundefined[39m,
  result: [ Uuid {} ]
}

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:50:01.611Z] [DEBUG] [QueryManager] Subscribe Remote Query - Created Live UUID { queryHash: [33m5287015697723528[39m, liveUuid: Uuid {} }

stderr | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[Database] liveQuery method not found on Surreal instance. Live updates will not work.

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:50:01.611Z] [DEBUG] [QueryManager] Subscribe Remote Query - Subscribed to Live UUID { queryHash: [33m5287015697723528[39m, liveUuid: Uuid {} }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:50:01.612Z] [DEBUG] [QueryManager] Run - Initialize subqueries [33m5287015697723528[39m

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:50:11.546Z] [INFO] [Provisioning] Starting provision check...

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:50:11.547Z] [DEBUG] [Provisioning] Schema hash: 36219f6c156e8612442cf558e26fc4750fa5daf8
[2025-11-30T13:50:11.547Z] [DEBUG] [Provisioning] Schema up to date: false
[2025-11-30T13:50:11.547Z] [DEBUG] [Provisioning] Should migrate: true
[2025-11-30T13:50:11.547Z] [INFO] [Provisioning] Initializing internal database schema...

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:50:11.547Z] [INFO] [Provisioning] Starting schema migration...

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:50:11.552Z] [DEBUG] [Provisioning] Recording schema hash...

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:50:11.552Z] [INFO] [Provisioning] Database schema provisioned successfully

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[buildQuery] Generated SELECT query: SELECT * FROM thread;
[buildQuery] Query vars: {}
[buildQuery] Generated SELECT query: SELECT * FROM thread;
[buildQuery] Query vars: {}
[buildQuery] Generated LIVE SELECT query: LIVE SELECT * FROM thread;
[buildQuery] Query vars: {}
[2025-11-30T13:50:11.599Z] [DEBUG] [QueryManager] Run - Cache miss { queryHash: [33m5287015697723528[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:50:11.599Z] [DEBUG] [QueryManager] Run - Initialize query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:50:11.599Z] [DEBUG] [QueryManager] Run - Refresh query locally { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:50:11.599Z] [DEBUG] [QueryManager] Local Query Refresh - Starting { queryHash: [33m5287015697723528[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:50:11.600Z] [DEBUG] [Database] Query Local Database - Result { sql: [32m'SELECT * FROM thread;'[39m, vars: [90mundefined[39m, result: [ [] ] }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:50:11.600Z] [DEBUG] [QueryManager] Local Query Refresh - Done { queryHash: [33m5287015697723528[39m, resultLength: [33m0[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:50:11.600Z] [DEBUG] [Database] Query Local Database - Result {
  sql: [32m'RETURN crypto::blake3($data)'[39m,
  vars: { data: [32m'[]'[39m },
  result: [
    [32m'd53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab'[39m
  ]
}

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:50:11.600Z] [DEBUG] [QueryManager] Local Query Refresh - Decoded results { decodedResults: [] }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:50:11.600Z] [DEBUG] [QueryManager] Run - Hydrate remote query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:50:11.600Z] [DEBUG] [QueryManager] Remote Query Hydration - Starting { queryHash: [33m5287015697723528[39m, query: [32m'SELECT * FROM thread;'[39m }
[DEBUG] Fetching remote hash with query: RETURN crypto::blake3(string::json({ SELECT * FROM thread }))

stderr | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[DEBUG] Remote hash fetch failed: RemoteDatabaseError: Failed to execute query on remote database
    at Object.queryRemote [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/database.ts:110:13[90m)[39m
    at QueryManagerService.queryRemoteHydration [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:379:22[90m)[39m
    at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:629:9[90m)[39m {
  cause: [Error: There was a problem with the database: Parse error: Invalid function/constant path, did you maybe mean `string::join`
   --> [1:23]
    |
  1 | RETURN crypto::blake3(string::json({ SELECT * FROM thread }))
    |                       ^^^^^^^^^^^^ 
  ] {
    code: [32m'GenericFailure'[39m
  }
}

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:50:11.600Z] [WARN] [QueryManager] Remote Query Hydration - Failed to get remote hash (falling back to full fetch) RemoteDatabaseError: Failed to execute query on remote database
    at Object.queryRemote [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/database.ts:110:13[90m)[39m
    at QueryManagerService.queryRemoteHydration [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:379:22[90m)[39m
    at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:629:9[90m)[39m {
  cause: [Error: There was a problem with the database: Parse error: Invalid function/constant path, did you maybe mean `string::join`
   --> [1:23]
    |
  1 | RETURN crypto::blake3(string::json({ SELECT * FROM thread }))
    |                       ^^^^^^^^^^^^ 
  ] {
    code: [32m'GenericFailure'[39m
  }
}
[DEBUG] Comparing hashes. Local: d53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab Remote: [90mundefined[39m
[2025-11-30T13:50:11.601Z] [DEBUG] [QueryManager] Remote Query Hydration - Hash mismatch or missing, fetching data {
  queryHash: [33m5287015697723528[39m,
  localHash: [32m'd53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab'[39m,
  remoteHash: [90mundefined[39m
}

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:50:11.601Z] [DEBUG] [Database] Query Remote Database - Result { sql: [32m'SELECT * FROM thread;'[39m, vars: [90mundefined[39m, result: [ [] ] }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:50:11.601Z] [DEBUG] [QueryManager] Remote Query Hydration - Remote query done { queryHash: [33m5287015697723528[39m, resultLength: [33m0[39m }
[2025-11-30T13:50:11.601Z] [DEBUG] [QueryManager] Materialize remote record update - Starting { records: [33m0[39m }
[2025-11-30T13:50:11.601Z] [DEBUG] [QueryManager] Materialize remote record update - Updating local cache { records: [33m0[39m, materializeQuery: [32m''[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:50:11.601Z] [DEBUG] [Database] Query Local Database - Result { sql: [32m''[39m, vars: [90mundefined[39m, result: [] }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:50:11.601Z] [DEBUG] [QueryManager] Materialize remote record update - Done { records: [33m0[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:50:11.601Z] [DEBUG] [QueryManager] Remote Query Hydration - Local cache updated { queryHash: [33m5287015697723528[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:50:11.601Z] [DEBUG] [Database] Query Local Database - Result { sql: [32m'SELECT * FROM thread;'[39m, vars: [90mundefined[39m, result: [ [] ] }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:50:11.601Z] [DEBUG] [QueryManager] Remote Query Hydration - Local cache updated { queryHash: [33m5287015697723528[39m, resultLength: [33m0[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:50:11.601Z] [DEBUG] [QueryManager] Run - Subscribe to remote query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:50:11.601Z] [DEBUG] [QueryManager] Subscribe Remote Query - Starting { queryHash: [33m5287015697723528[39m, query: [32m'LIVE SELECT * FROM thread;'[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:50:11.601Z] [DEBUG] [Database] Query Remote Database - Result {
  sql: [32m'LIVE SELECT * FROM thread;'[39m,
  vars: [90mundefined[39m,
  result: [ Uuid {} ]
}

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:50:11.601Z] [DEBUG] [QueryManager] Subscribe Remote Query - Created Live UUID { queryHash: [33m5287015697723528[39m, liveUuid: Uuid {} }

stderr | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[Database] liveQuery method not found on Surreal instance. Live updates will not work.

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:50:11.602Z] [DEBUG] [QueryManager] Subscribe Remote Query - Subscribed to Live UUID { queryHash: [33m5287015697723528[39m, liveUuid: Uuid {} }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:50:11.602Z] [DEBUG] [QueryManager] Run - Initialize subqueries [33m5287015697723528[39m

 â¯ test/sync.test.ts (2 tests | 2 failed) 20005ms
   Ã— Sync Protocol > should fetch data on initial sync (hash mismatch) 10003ms
     â†’ Test timed out in 10000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".
   Ã— Sync Protocol > should NOT fetch data if hashes match 10001ms
     â†’ Test timed out in 10000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".

â¯â¯â¯â¯â¯â¯â¯ Failed Tests 2 â¯â¯â¯â¯â¯â¯â¯

 FAIL  test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
Error: Test timed out in 10000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".
 â¯ test/sync.test.ts:22:5
     20| 
     21| describe("Sync Protocol", () => {
     22|     it("should fetch data on initial sync (hash mismatch)", async () =â€¦
       |     ^
     23|         const { spooky, dbContext } = await createMockSpooky(mockConfiâ€¦
     24|         try {

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[1/2]â¯

 FAIL  test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
Error: Test timed out in 10000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".
 â¯ test/sync.test.ts:79:5
     77|     }, 10000);
     78| 
     79|     it("should NOT fetch data if hashes match", async () => {
       |     ^
     80|         const { spooky, dbContext } = await createMockSpooky(mockConfiâ€¦
     81|         try {

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[2/2]â¯


 Test Files  1 failed (1)
      Tests  2 failed (2)
   Start at  14:50:01
   Duration  20.18s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  test/sync.test.ts x6 
        Filename pattern: test/sync.test.ts

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:50:27.555Z] [INFO] [Provisioning] Starting provision check...

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:50:27.557Z] [DEBUG] [Provisioning] Schema hash: 36219f6c156e8612442cf558e26fc4750fa5daf8
[2025-11-30T13:50:27.557Z] [DEBUG] [Provisioning] Schema up to date: false
[2025-11-30T13:50:27.557Z] [DEBUG] [Provisioning] Should migrate: true
[2025-11-30T13:50:27.557Z] [INFO] [Provisioning] Initializing internal database schema...

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:50:27.558Z] [INFO] [Provisioning] Starting schema migration...

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:50:27.563Z] [DEBUG] [Provisioning] Recording schema hash...

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:50:27.564Z] [INFO] [Provisioning] Database schema provisioned successfully

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
Create Result: [
  []
]

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
Thread Check: [
  []
]

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[buildQuery] Generated SELECT query: SELECT * FROM thread;
[buildQuery] Query vars: {}
[buildQuery] Generated SELECT query: SELECT * FROM thread;
[buildQuery] Query vars: {}
[buildQuery] Generated LIVE SELECT query: LIVE SELECT * FROM thread;
[buildQuery] Query vars: {}
[2025-11-30T13:50:27.606Z] [DEBUG] [QueryManager] Run - Cache miss { queryHash: [33m5287015697723528[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:50:27.607Z] [DEBUG] [QueryManager] Run - Initialize query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:50:27.607Z] [DEBUG] [QueryManager] Run - Refresh query locally { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:50:27.607Z] [DEBUG] [QueryManager] Local Query Refresh - Starting { queryHash: [33m5287015697723528[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:50:27.607Z] [DEBUG] [Database] Query Local Database - Result { sql: [32m'SELECT * FROM thread;'[39m, vars: [90mundefined[39m, result: [ [] ] }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:50:27.608Z] [DEBUG] [QueryManager] Local Query Refresh - Done { queryHash: [33m5287015697723528[39m, resultLength: [33m0[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:50:27.608Z] [DEBUG] [Database] Query Local Database - Result {
  sql: [32m'RETURN crypto::blake3($data)'[39m,
  vars: { data: [32m'[]'[39m },
  result: [
    [32m'd53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab'[39m
  ]
}

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:50:27.608Z] [DEBUG] [QueryManager] Local Query Refresh - Decoded results { decodedResults: [] }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:50:27.608Z] [DEBUG] [QueryManager] Run - Hydrate remote query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:50:27.608Z] [DEBUG] [QueryManager] Remote Query Hydration - Starting { queryHash: [33m5287015697723528[39m, query: [32m'SELECT * FROM thread;'[39m }
[DEBUG] Fetching remote hash with query: RETURN crypto::blake3(string::json({ SELECT * FROM thread }))

stderr | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[DEBUG] Remote hash fetch failed: RemoteDatabaseError: Failed to execute query on remote database
    at Object.queryRemote [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/database.ts:110:13[90m)[39m
    at QueryManagerService.queryRemoteHydration [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:379:22[90m)[39m
    at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:629:9[90m)[39m {
  cause: [Error: There was a problem with the database: Parse error: Invalid function/constant path, did you maybe mean `string::join`
   --> [1:23]
    |
  1 | RETURN crypto::blake3(string::json({ SELECT * FROM thread }))
    |                       ^^^^^^^^^^^^ 
  ] {
    code: [32m'GenericFailure'[39m
  }
}

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:50:27.610Z] [WARN] [QueryManager] Remote Query Hydration - Failed to get remote hash (falling back to full fetch) RemoteDatabaseError: Failed to execute query on remote database
    at Object.queryRemote [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/database.ts:110:13[90m)[39m
    at QueryManagerService.queryRemoteHydration [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:379:22[90m)[39m
    at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:629:9[90m)[39m {
  cause: [Error: There was a problem with the database: Parse error: Invalid function/constant path, did you maybe mean `string::join`
   --> [1:23]
    |
  1 | RETURN crypto::blake3(string::json({ SELECT * FROM thread }))
    |                       ^^^^^^^^^^^^ 
  ] {
    code: [32m'GenericFailure'[39m
  }
}
[DEBUG] Comparing hashes. Local: d53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab Remote: [90mundefined[39m
[2025-11-30T13:50:27.610Z] [DEBUG] [QueryManager] Remote Query Hydration - Hash mismatch or missing, fetching data {
  queryHash: [33m5287015697723528[39m,
  localHash: [32m'd53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab'[39m,
  remoteHash: [90mundefined[39m
}

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:50:27.610Z] [DEBUG] [Database] Query Remote Database - Result { sql: [32m'SELECT * FROM thread;'[39m, vars: [90mundefined[39m, result: [ [] ] }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:50:27.611Z] [DEBUG] [QueryManager] Remote Query Hydration - Remote query done { queryHash: [33m5287015697723528[39m, resultLength: [33m0[39m }
[2025-11-30T13:50:27.611Z] [DEBUG] [QueryManager] Materialize remote record update - Starting { records: [33m0[39m }
[2025-11-30T13:50:27.611Z] [DEBUG] [QueryManager] Materialize remote record update - Updating local cache { records: [33m0[39m, materializeQuery: [32m''[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:50:27.611Z] [DEBUG] [Database] Query Local Database - Result { sql: [32m''[39m, vars: [90mundefined[39m, result: [] }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:50:27.611Z] [DEBUG] [QueryManager] Materialize remote record update - Done { records: [33m0[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:50:27.611Z] [DEBUG] [QueryManager] Remote Query Hydration - Local cache updated { queryHash: [33m5287015697723528[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:50:27.611Z] [DEBUG] [Database] Query Local Database - Result { sql: [32m'SELECT * FROM thread;'[39m, vars: [90mundefined[39m, result: [ [] ] }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:50:27.611Z] [DEBUG] [QueryManager] Remote Query Hydration - Local cache updated { queryHash: [33m5287015697723528[39m, resultLength: [33m0[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:50:27.611Z] [DEBUG] [QueryManager] Run - Subscribe to remote query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:50:27.611Z] [DEBUG] [QueryManager] Subscribe Remote Query - Starting { queryHash: [33m5287015697723528[39m, query: [32m'LIVE SELECT * FROM thread;'[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:50:27.612Z] [DEBUG] [Database] Query Remote Database - Result {
  sql: [32m'LIVE SELECT * FROM thread;'[39m,
  vars: [90mundefined[39m,
  result: [ Uuid {} ]
}

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:50:27.612Z] [DEBUG] [QueryManager] Subscribe Remote Query - Created Live UUID { queryHash: [33m5287015697723528[39m, liveUuid: Uuid {} }

stderr | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[Database] liveQuery method not found on Surreal instance. Live updates will not work.

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:50:27.612Z] [DEBUG] [QueryManager] Subscribe Remote Query - Subscribed to Live UUID { queryHash: [33m5287015697723528[39m, liveUuid: Uuid {} }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:50:27.612Z] [DEBUG] [QueryManager] Run - Initialize subqueries [33m5287015697723528[39m

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:50:37.548Z] [INFO] [Provisioning] Starting provision check...

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:50:37.548Z] [DEBUG] [Provisioning] Schema hash: 36219f6c156e8612442cf558e26fc4750fa5daf8
[2025-11-30T13:50:37.548Z] [DEBUG] [Provisioning] Schema up to date: false
[2025-11-30T13:50:37.548Z] [DEBUG] [Provisioning] Should migrate: true
[2025-11-30T13:50:37.548Z] [INFO] [Provisioning] Initializing internal database schema...

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:50:37.549Z] [INFO] [Provisioning] Starting schema migration...

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:50:37.553Z] [DEBUG] [Provisioning] Recording schema hash...

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:50:37.553Z] [INFO] [Provisioning] Database schema provisioned successfully

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[buildQuery] Generated SELECT query: SELECT * FROM thread;
[buildQuery] Query vars: {}
[buildQuery] Generated SELECT query: SELECT * FROM thread;
[buildQuery] Query vars: {}
[buildQuery] Generated LIVE SELECT query: LIVE SELECT * FROM thread;
[buildQuery] Query vars: {}
[2025-11-30T13:50:37.601Z] [DEBUG] [QueryManager] Run - Cache miss { queryHash: [33m5287015697723528[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:50:37.601Z] [DEBUG] [QueryManager] Run - Initialize query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:50:37.601Z] [DEBUG] [QueryManager] Run - Refresh query locally { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:50:37.601Z] [DEBUG] [QueryManager] Local Query Refresh - Starting { queryHash: [33m5287015697723528[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:50:37.601Z] [DEBUG] [Database] Query Local Database - Result { sql: [32m'SELECT * FROM thread;'[39m, vars: [90mundefined[39m, result: [ [] ] }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:50:37.601Z] [DEBUG] [QueryManager] Local Query Refresh - Done { queryHash: [33m5287015697723528[39m, resultLength: [33m0[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:50:37.601Z] [DEBUG] [Database] Query Local Database - Result {
  sql: [32m'RETURN crypto::blake3($data)'[39m,
  vars: { data: [32m'[]'[39m },
  result: [
    [32m'd53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab'[39m
  ]
}

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:50:37.601Z] [DEBUG] [QueryManager] Local Query Refresh - Decoded results { decodedResults: [] }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:50:37.602Z] [DEBUG] [QueryManager] Run - Hydrate remote query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:50:37.602Z] [DEBUG] [QueryManager] Remote Query Hydration - Starting { queryHash: [33m5287015697723528[39m, query: [32m'SELECT * FROM thread;'[39m }
[DEBUG] Fetching remote hash with query: RETURN crypto::blake3(string::json({ SELECT * FROM thread }))

stderr | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[DEBUG] Remote hash fetch failed: RemoteDatabaseError: Failed to execute query on remote database
    at Object.queryRemote [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/database.ts:110:13[90m)[39m
    at QueryManagerService.queryRemoteHydration [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:379:22[90m)[39m
    at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:629:9[90m)[39m {
  cause: [Error: There was a problem with the database: Parse error: Invalid function/constant path, did you maybe mean `string::join`
   --> [1:23]
    |
  1 | RETURN crypto::blake3(string::json({ SELECT * FROM thread }))
    |                       ^^^^^^^^^^^^ 
  ] {
    code: [32m'GenericFailure'[39m
  }
}

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:50:37.602Z] [WARN] [QueryManager] Remote Query Hydration - Failed to get remote hash (falling back to full fetch) RemoteDatabaseError: Failed to execute query on remote database
    at Object.queryRemote [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/database.ts:110:13[90m)[39m
    at QueryManagerService.queryRemoteHydration [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:379:22[90m)[39m
    at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:629:9[90m)[39m {
  cause: [Error: There was a problem with the database: Parse error: Invalid function/constant path, did you maybe mean `string::join`
   --> [1:23]
    |
  1 | RETURN crypto::blake3(string::json({ SELECT * FROM thread }))
    |                       ^^^^^^^^^^^^ 
  ] {
    code: [32m'GenericFailure'[39m
  }
}
[DEBUG] Comparing hashes. Local: d53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab Remote: [90mundefined[39m
[2025-11-30T13:50:37.602Z] [DEBUG] [QueryManager] Remote Query Hydration - Hash mismatch or missing, fetching data {
  queryHash: [33m5287015697723528[39m,
  localHash: [32m'd53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab'[39m,
  remoteHash: [90mundefined[39m
}

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:50:37.602Z] [DEBUG] [Database] Query Remote Database - Result { sql: [32m'SELECT * FROM thread;'[39m, vars: [90mundefined[39m, result: [ [] ] }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:50:37.602Z] [DEBUG] [QueryManager] Remote Query Hydration - Remote query done { queryHash: [33m5287015697723528[39m, resultLength: [33m0[39m }
[2025-11-30T13:50:37.602Z] [DEBUG] [QueryManager] Materialize remote record update - Starting { records: [33m0[39m }
[2025-11-30T13:50:37.602Z] [DEBUG] [QueryManager] Materialize remote record update - Updating local cache { records: [33m0[39m, materializeQuery: [32m''[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:50:37.603Z] [DEBUG] [Database] Query Local Database - Result { sql: [32m''[39m, vars: [90mundefined[39m, result: [] }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:50:37.603Z] [DEBUG] [QueryManager] Materialize remote record update - Done { records: [33m0[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:50:37.603Z] [DEBUG] [QueryManager] Remote Query Hydration - Local cache updated { queryHash: [33m5287015697723528[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:50:37.603Z] [DEBUG] [Database] Query Local Database - Result { sql: [32m'SELECT * FROM thread;'[39m, vars: [90mundefined[39m, result: [ [] ] }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:50:37.603Z] [DEBUG] [QueryManager] Remote Query Hydration - Local cache updated { queryHash: [33m5287015697723528[39m, resultLength: [33m0[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:50:37.603Z] [DEBUG] [QueryManager] Run - Subscribe to remote query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:50:37.603Z] [DEBUG] [QueryManager] Subscribe Remote Query - Starting { queryHash: [33m5287015697723528[39m, query: [32m'LIVE SELECT * FROM thread;'[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:50:37.603Z] [DEBUG] [Database] Query Remote Database - Result {
  sql: [32m'LIVE SELECT * FROM thread;'[39m,
  vars: [90mundefined[39m,
  result: [ Uuid {} ]
}

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:50:37.603Z] [DEBUG] [QueryManager] Subscribe Remote Query - Created Live UUID { queryHash: [33m5287015697723528[39m, liveUuid: Uuid {} }

stderr | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[Database] liveQuery method not found on Surreal instance. Live updates will not work.

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:50:37.603Z] [DEBUG] [QueryManager] Subscribe Remote Query - Subscribed to Live UUID { queryHash: [33m5287015697723528[39m, liveUuid: Uuid {} }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:50:37.603Z] [DEBUG] [QueryManager] Run - Initialize subqueries [33m5287015697723528[39m

 â¯ test/sync.test.ts (2 tests | 2 failed) 20005ms
   Ã— Sync Protocol > should fetch data on initial sync (hash mismatch) 10003ms
     â†’ Test timed out in 10000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".
   Ã— Sync Protocol > should NOT fetch data if hashes match 10002ms
     â†’ Test timed out in 10000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".

â¯â¯â¯â¯â¯â¯â¯ Failed Tests 2 â¯â¯â¯â¯â¯â¯â¯

 FAIL  test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
Error: Test timed out in 10000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".
 â¯ test/sync.test.ts:22:5
     20| 
     21| describe("Sync Protocol", () => {
     22|     it("should fetch data on initial sync (hash mismatch)", async () =â€¦
       |     ^
     23|         const { spooky, dbContext } = await createMockSpooky(mockConfiâ€¦
     24|         try {

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[1/2]â¯

 FAIL  test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
Error: Test timed out in 10000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".
 â¯ test/sync.test.ts:79:5
     77|     }, 10000);
     78| 
     79|     it("should NOT fetch data if hashes match", async () => {
       |     ^
     80|         const { spooky, dbContext } = await createMockSpooky(mockConfiâ€¦
     81|         try {

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[2/2]â¯


 Test Files  1 failed (1)
      Tests  2 failed (2)
   Start at  14:50:27
   Duration  20.19s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  test/sync.test.ts x7 
        Filename pattern: test/sync.test.ts

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:52:24.790Z] [INFO] [Provisioning] Starting provision check...

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:52:24.797Z] [DEBUG] [Provisioning] Schema hash: 36219f6c156e8612442cf558e26fc4750fa5daf8
[2025-11-30T13:52:24.798Z] [DEBUG] [Provisioning] Schema up to date: false
[2025-11-30T13:52:24.798Z] [DEBUG] [Provisioning] Should migrate: true
[2025-11-30T13:52:24.798Z] [INFO] [Provisioning] Initializing internal database schema...

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:52:24.800Z] [INFO] [Provisioning] Starting schema migration...

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:52:24.804Z] [DEBUG] [Provisioning] Recording schema hash...

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:52:24.805Z] [INFO] [Provisioning] Database schema provisioned successfully

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
Create Result: [
  []
]

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
Thread Check: [
  []
]

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[buildQuery] Generated SELECT query: SELECT * FROM thread;
[buildQuery] Query vars: {}
[buildQuery] Generated SELECT query: SELECT * FROM thread;
[buildQuery] Query vars: {}
[buildQuery] Generated LIVE SELECT query: LIVE SELECT * FROM thread;
[buildQuery] Query vars: {}
[2025-11-30T13:52:24.849Z] [DEBUG] [QueryManager] Run - Cache miss { queryHash: [33m5287015697723528[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:52:24.850Z] [DEBUG] [QueryManager] Run - Initialize query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:52:24.850Z] [DEBUG] [QueryManager] Run - Refresh query locally { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:52:24.850Z] [DEBUG] [QueryManager] Local Query Refresh - Starting { queryHash: [33m5287015697723528[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:52:24.850Z] [DEBUG] [Database] Query Local Database - Result { sql: [32m'SELECT * FROM thread;'[39m, vars: [90mundefined[39m, result: [ [] ] }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:52:24.851Z] [DEBUG] [QueryManager] Local Query Refresh - Done { queryHash: [33m5287015697723528[39m, resultLength: [33m0[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:52:24.851Z] [DEBUG] [Database] Query Local Database - Result {
  sql: [32m'RETURN crypto::blake3($data)'[39m,
  vars: { data: [32m'[]'[39m },
  result: [
    [32m'd53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab'[39m
  ]
}

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:52:24.851Z] [DEBUG] [QueryManager] Local Query Refresh - Decoded results { decodedResults: [] }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:52:24.851Z] [DEBUG] [QueryManager] Run - Hydrate remote query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:52:24.852Z] [DEBUG] [QueryManager] Remote Query Hydration - Starting { queryHash: [33m5287015697723528[39m, query: [32m'SELECT * FROM thread;'[39m }
[DEBUG] Fetching remote hash with query: RETURN crypto::blake3(string::json({ SELECT * FROM thread }))

stderr | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[DEBUG] Remote hash fetch failed: RemoteDatabaseError: Failed to execute query on remote database
    at Object.queryRemote [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/database.ts:110:13[90m)[39m
    at QueryManagerService.queryRemoteHydration [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:379:22[90m)[39m
    at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:629:9[90m)[39m {
  cause: [Error: There was a problem with the database: Parse error: Invalid function/constant path, did you maybe mean `string::join`
   --> [1:23]
    |
  1 | RETURN crypto::blake3(string::json({ SELECT * FROM thread }))
    |                       ^^^^^^^^^^^^ 
  ] {
    code: [32m'GenericFailure'[39m
  }
}

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:52:24.853Z] [WARN] [QueryManager] Remote Query Hydration - Failed to get remote hash (falling back to full fetch) RemoteDatabaseError: Failed to execute query on remote database
    at Object.queryRemote [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/database.ts:110:13[90m)[39m
    at QueryManagerService.queryRemoteHydration [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:379:22[90m)[39m
    at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:629:9[90m)[39m {
  cause: [Error: There was a problem with the database: Parse error: Invalid function/constant path, did you maybe mean `string::join`
   --> [1:23]
    |
  1 | RETURN crypto::blake3(string::json({ SELECT * FROM thread }))
    |                       ^^^^^^^^^^^^ 
  ] {
    code: [32m'GenericFailure'[39m
  }
}
[DEBUG] Comparing hashes. Local: d53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab Remote: [90mundefined[39m
[2025-11-30T13:52:24.853Z] [DEBUG] [QueryManager] Remote Query Hydration - Hash mismatch or missing, fetching data {
  queryHash: [33m5287015697723528[39m,
  localHash: [32m'd53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab'[39m,
  remoteHash: [90mundefined[39m
}

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:52:24.855Z] [DEBUG] [Database] Query Remote Database - Result { sql: [32m'SELECT * FROM thread;'[39m, vars: [90mundefined[39m, result: [ [] ] }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:52:24.855Z] [DEBUG] [QueryManager] Remote Query Hydration - Remote query done { queryHash: [33m5287015697723528[39m, resultLength: [33m0[39m }
[2025-11-30T13:52:24.855Z] [DEBUG] [QueryManager] Materialize remote record update - Starting { records: [33m0[39m }
[2025-11-30T13:52:24.855Z] [DEBUG] [QueryManager] Materialize remote record update - Updating local cache { records: [33m0[39m, materializeQuery: [32m''[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:52:24.856Z] [DEBUG] [Database] Query Local Database - Result { sql: [32m''[39m, vars: [90mundefined[39m, result: [] }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:52:24.856Z] [DEBUG] [QueryManager] Materialize remote record update - Done { records: [33m0[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:52:24.856Z] [DEBUG] [QueryManager] Remote Query Hydration - Local cache updated { queryHash: [33m5287015697723528[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:52:24.856Z] [DEBUG] [Database] Query Local Database - Result { sql: [32m'SELECT * FROM thread;'[39m, vars: [90mundefined[39m, result: [ [] ] }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:52:24.856Z] [DEBUG] [QueryManager] Remote Query Hydration - Local cache updated { queryHash: [33m5287015697723528[39m, resultLength: [33m0[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:52:24.856Z] [DEBUG] [QueryManager] Run - Subscribe to remote query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:52:24.856Z] [DEBUG] [QueryManager] Subscribe Remote Query - Starting { queryHash: [33m5287015697723528[39m, query: [32m'LIVE SELECT * FROM thread;'[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:52:24.856Z] [DEBUG] [Database] Query Remote Database - Result {
  sql: [32m'LIVE SELECT * FROM thread;'[39m,
  vars: [90mundefined[39m,
  result: [ Uuid {} ]
}

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:52:24.857Z] [DEBUG] [QueryManager] Subscribe Remote Query - Created Live UUID { queryHash: [33m5287015697723528[39m, liveUuid: Uuid {} }

stderr | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[Database] liveQuery method not found on Surreal instance. Live updates will not work.

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:52:24.857Z] [DEBUG] [QueryManager] Subscribe Remote Query - Subscribed to Live UUID { queryHash: [33m5287015697723528[39m, liveUuid: Uuid {} }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:52:24.857Z] [DEBUG] [QueryManager] Run - Initialize subqueries [33m5287015697723528[39m

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:52:34.780Z] [INFO] [Provisioning] Starting provision check...

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:52:34.781Z] [DEBUG] [Provisioning] Schema hash: 36219f6c156e8612442cf558e26fc4750fa5daf8
[2025-11-30T13:52:34.781Z] [DEBUG] [Provisioning] Schema up to date: false
[2025-11-30T13:52:34.781Z] [DEBUG] [Provisioning] Should migrate: true
[2025-11-30T13:52:34.781Z] [INFO] [Provisioning] Initializing internal database schema...

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:52:34.781Z] [INFO] [Provisioning] Starting schema migration...

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:52:34.785Z] [DEBUG] [Provisioning] Recording schema hash...

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:52:34.786Z] [INFO] [Provisioning] Database schema provisioned successfully

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[buildQuery] Generated SELECT query: SELECT * FROM thread;
[buildQuery] Query vars: {}
[buildQuery] Generated SELECT query: SELECT * FROM thread;
[buildQuery] Query vars: {}
[buildQuery] Generated LIVE SELECT query: LIVE SELECT * FROM thread;
[buildQuery] Query vars: {}
[2025-11-30T13:52:34.834Z] [DEBUG] [QueryManager] Run - Cache miss { queryHash: [33m5287015697723528[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:52:34.834Z] [DEBUG] [QueryManager] Run - Initialize query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:52:34.834Z] [DEBUG] [QueryManager] Run - Refresh query locally { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:52:34.835Z] [DEBUG] [QueryManager] Local Query Refresh - Starting { queryHash: [33m5287015697723528[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:52:34.835Z] [DEBUG] [Database] Query Local Database - Result { sql: [32m'SELECT * FROM thread;'[39m, vars: [90mundefined[39m, result: [ [] ] }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:52:34.835Z] [DEBUG] [QueryManager] Local Query Refresh - Done { queryHash: [33m5287015697723528[39m, resultLength: [33m0[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:52:34.835Z] [DEBUG] [Database] Query Local Database - Result {
  sql: [32m'RETURN crypto::blake3($data)'[39m,
  vars: { data: [32m'[]'[39m },
  result: [
    [32m'd53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab'[39m
  ]
}

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:52:34.835Z] [DEBUG] [QueryManager] Local Query Refresh - Decoded results { decodedResults: [] }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:52:34.835Z] [DEBUG] [QueryManager] Run - Hydrate remote query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:52:34.835Z] [DEBUG] [QueryManager] Remote Query Hydration - Starting { queryHash: [33m5287015697723528[39m, query: [32m'SELECT * FROM thread;'[39m }
[DEBUG] Fetching remote hash with query: RETURN crypto::blake3(string::json({ SELECT * FROM thread }))

stderr | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[DEBUG] Remote hash fetch failed: RemoteDatabaseError: Failed to execute query on remote database
    at Object.queryRemote [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/database.ts:110:13[90m)[39m
    at QueryManagerService.queryRemoteHydration [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:379:22[90m)[39m
    at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:629:9[90m)[39m {
  cause: [Error: There was a problem with the database: Parse error: Invalid function/constant path, did you maybe mean `string::join`
   --> [1:23]
    |
  1 | RETURN crypto::blake3(string::json({ SELECT * FROM thread }))
    |                       ^^^^^^^^^^^^ 
  ] {
    code: [32m'GenericFailure'[39m
  }
}

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:52:34.836Z] [WARN] [QueryManager] Remote Query Hydration - Failed to get remote hash (falling back to full fetch) RemoteDatabaseError: Failed to execute query on remote database
    at Object.queryRemote [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/database.ts:110:13[90m)[39m
    at QueryManagerService.queryRemoteHydration [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:379:22[90m)[39m
    at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:629:9[90m)[39m {
  cause: [Error: There was a problem with the database: Parse error: Invalid function/constant path, did you maybe mean `string::join`
   --> [1:23]
    |
  1 | RETURN crypto::blake3(string::json({ SELECT * FROM thread }))
    |                       ^^^^^^^^^^^^ 
  ] {
    code: [32m'GenericFailure'[39m
  }
}
[DEBUG] Comparing hashes. Local: d53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab Remote: [90mundefined[39m
[2025-11-30T13:52:34.836Z] [DEBUG] [QueryManager] Remote Query Hydration - Hash mismatch or missing, fetching data {
  queryHash: [33m5287015697723528[39m,
  localHash: [32m'd53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab'[39m,
  remoteHash: [90mundefined[39m
}

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:52:34.836Z] [DEBUG] [Database] Query Remote Database - Result { sql: [32m'SELECT * FROM thread;'[39m, vars: [90mundefined[39m, result: [ [] ] }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:52:34.836Z] [DEBUG] [QueryManager] Remote Query Hydration - Remote query done { queryHash: [33m5287015697723528[39m, resultLength: [33m0[39m }
[2025-11-30T13:52:34.836Z] [DEBUG] [QueryManager] Materialize remote record update - Starting { records: [33m0[39m }
[2025-11-30T13:52:34.836Z] [DEBUG] [QueryManager] Materialize remote record update - Updating local cache { records: [33m0[39m, materializeQuery: [32m''[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:52:34.836Z] [DEBUG] [Database] Query Local Database - Result { sql: [32m''[39m, vars: [90mundefined[39m, result: [] }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:52:34.837Z] [DEBUG] [QueryManager] Materialize remote record update - Done { records: [33m0[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:52:34.837Z] [DEBUG] [QueryManager] Remote Query Hydration - Local cache updated { queryHash: [33m5287015697723528[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:52:34.837Z] [DEBUG] [Database] Query Local Database - Result { sql: [32m'SELECT * FROM thread;'[39m, vars: [90mundefined[39m, result: [ [] ] }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:52:34.837Z] [DEBUG] [QueryManager] Remote Query Hydration - Local cache updated { queryHash: [33m5287015697723528[39m, resultLength: [33m0[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:52:34.837Z] [DEBUG] [QueryManager] Run - Subscribe to remote query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:52:34.837Z] [DEBUG] [QueryManager] Subscribe Remote Query - Starting { queryHash: [33m5287015697723528[39m, query: [32m'LIVE SELECT * FROM thread;'[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:52:34.837Z] [DEBUG] [Database] Query Remote Database - Result {
  sql: [32m'LIVE SELECT * FROM thread;'[39m,
  vars: [90mundefined[39m,
  result: [ Uuid {} ]
}

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:52:34.837Z] [DEBUG] [QueryManager] Subscribe Remote Query - Created Live UUID { queryHash: [33m5287015697723528[39m, liveUuid: Uuid {} }

stderr | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[Database] liveQuery method not found on Surreal instance. Live updates will not work.

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:52:34.837Z] [DEBUG] [QueryManager] Subscribe Remote Query - Subscribed to Live UUID { queryHash: [33m5287015697723528[39m, liveUuid: Uuid {} }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:52:34.837Z] [DEBUG] [QueryManager] Run - Initialize subqueries [33m5287015697723528[39m

 â¯ test/sync.test.ts (2 tests | 2 failed) 20006ms
   Ã— Sync Protocol > should fetch data on initial sync (hash mismatch) 10004ms
     â†’ Test timed out in 10000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".
   Ã— Sync Protocol > should NOT fetch data if hashes match 10001ms
     â†’ Test timed out in 10000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".

â¯â¯â¯â¯â¯â¯â¯ Failed Tests 2 â¯â¯â¯â¯â¯â¯â¯

 FAIL  test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
Error: Test timed out in 10000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".
 â¯ test/sync.test.ts:22:5
     20| 
     21| describe("Sync Protocol", () => {
     22|     it("should fetch data on initial sync (hash mismatch)", async () =â€¦
       |     ^
     23|         const { spooky, dbContext } = await createMockSpooky(mockConfiâ€¦
     24|         try {

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[1/2]â¯

 FAIL  test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
Error: Test timed out in 10000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".
 â¯ test/sync.test.ts:79:5
     77|     }, 10000);
     78| 
     79|     it("should NOT fetch data if hashes match", async () => {
       |     ^
     80|         const { spooky, dbContext } = await createMockSpooky(mockConfiâ€¦
     81|         try {

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[2/2]â¯


 Test Files  1 failed (1)
      Tests  2 failed (2)
   Start at  14:52:24
   Duration  20.21s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  test/sync.test.ts x8 
        Filename pattern: test/sync.test.ts

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:59:14.746Z] [INFO] [Provisioning] Starting provision check...

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:59:14.754Z] [DEBUG] [Provisioning] Schema hash: 36219f6c156e8612442cf558e26fc4750fa5daf8
[2025-11-30T13:59:14.754Z] [DEBUG] [Provisioning] Schema up to date: false
[2025-11-30T13:59:14.754Z] [DEBUG] [Provisioning] Should migrate: true
[2025-11-30T13:59:14.754Z] [INFO] [Provisioning] Initializing internal database schema...

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:59:14.756Z] [INFO] [Provisioning] Starting schema migration...

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:59:14.760Z] [DEBUG] [Provisioning] Recording schema hash...

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:59:14.762Z] [INFO] [Provisioning] Database schema provisioned successfully

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
Create Result: [
  [
    {
      "author": "user:userA",
      "content": "content",
      "created_at": "2025-11-30T13:59:14.801635Z",
      "id": "thread:sync1",
      "title": "sync1"
    }
  ]
]

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
Thread Check: [
  [
    {
      "author": "user:userA",
      "content": "content",
      "created_at": "2025-11-30T13:59:14.801635Z",
      "id": "thread:sync1",
      "title": "sync1"
    }
  ]
]

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[buildQuery] Generated SELECT query: SELECT * FROM thread;
[buildQuery] Query vars: {}
[buildQuery] Generated SELECT query: SELECT * FROM thread;
[buildQuery] Query vars: {}
[buildQuery] Generated LIVE SELECT query: LIVE SELECT * FROM thread;
[buildQuery] Query vars: {}
[2025-11-30T13:59:14.803Z] [DEBUG] [QueryManager] Run - Cache miss { queryHash: [33m5287015697723528[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:59:14.804Z] [DEBUG] [QueryManager] Run - Initialize query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:59:14.804Z] [DEBUG] [QueryManager] Run - Refresh query locally { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:59:14.804Z] [DEBUG] [QueryManager] Local Query Refresh - Starting { queryHash: [33m5287015697723528[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:59:14.804Z] [DEBUG] [Database] Query Local Database - Result { sql: [32m'SELECT * FROM thread;'[39m, vars: [90mundefined[39m, result: [ [] ] }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:59:14.804Z] [DEBUG] [QueryManager] Local Query Refresh - Done { queryHash: [33m5287015697723528[39m, resultLength: [33m0[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:59:14.805Z] [DEBUG] [Database] Query Local Database - Result {
  sql: [32m'RETURN crypto::blake3($data)'[39m,
  vars: { data: [32m'[]'[39m },
  result: [
    [32m'd53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab'[39m
  ]
}

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:59:14.805Z] [DEBUG] [QueryManager] Local Query Refresh - Decoded results { decodedResults: [] }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:59:14.805Z] [DEBUG] [QueryManager] Run - Hydrate remote query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:59:14.805Z] [DEBUG] [QueryManager] Remote Query Hydration - Starting { queryHash: [33m5287015697723528[39m, query: [32m'SELECT * FROM thread;'[39m }
[DEBUG] Fetching remote hash with query: RETURN crypto::blake3(string::json({ SELECT * FROM thread }))

stderr | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[DEBUG] Remote hash fetch failed: RemoteDatabaseError: Failed to execute query on remote database
    at Object.queryRemote [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/database.ts:110:13[90m)[39m
    at QueryManagerService.queryRemoteHydration [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:379:22[90m)[39m
    at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:629:9[90m)[39m {
  cause: [Error: There was a problem with the database: Parse error: Invalid function/constant path, did you maybe mean `string::join`
   --> [1:23]
    |
  1 | RETURN crypto::blake3(string::json({ SELECT * FROM thread }))
    |                       ^^^^^^^^^^^^ 
  ] {
    code: [32m'GenericFailure'[39m
  }
}

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:59:14.807Z] [WARN] [QueryManager] Remote Query Hydration - Failed to get remote hash (falling back to full fetch) RemoteDatabaseError: Failed to execute query on remote database
    at Object.queryRemote [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/database.ts:110:13[90m)[39m
    at QueryManagerService.queryRemoteHydration [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:379:22[90m)[39m
    at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:629:9[90m)[39m {
  cause: [Error: There was a problem with the database: Parse error: Invalid function/constant path, did you maybe mean `string::join`
   --> [1:23]
    |
  1 | RETURN crypto::blake3(string::json({ SELECT * FROM thread }))
    |                       ^^^^^^^^^^^^ 
  ] {
    code: [32m'GenericFailure'[39m
  }
}
[DEBUG] Comparing hashes. Local: d53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab Remote: [90mundefined[39m
[2025-11-30T13:59:14.807Z] [DEBUG] [QueryManager] Remote Query Hydration - Hash mismatch or missing, fetching data {
  queryHash: [33m5287015697723528[39m,
  localHash: [32m'd53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab'[39m,
  remoteHash: [90mundefined[39m
}

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:59:14.807Z] [DEBUG] [Database] Query Remote Database - Result {
  sql: [32m'SELECT * FROM thread;'[39m,
  vars: [90mundefined[39m,
  result: [ [ [36m[Object][39m ] ]
}

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:59:14.807Z] [DEBUG] [QueryManager] Remote Query Hydration - Remote query done { queryHash: [33m5287015697723528[39m, resultLength: [33m1[39m }
[2025-11-30T13:59:14.807Z] [DEBUG] [QueryManager] Materialize remote record update - Starting { records: [33m1[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:59:14.808Z] [WARN] [QueryManager] Remote hydration failed (continuing with local data) TypeError: Cannot read properties of undefined (reading 'toString')
    at [90m/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:267:28
    at Array.map (<anonymous>)
    at QueryManagerService.materializeRemoteRecordUpdate [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:264:8[90m)[39m
    at QueryManagerService.queryRemoteHydration [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:427:16[90m)[39m
    at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:629:9[90m)[39m
[2025-11-30T13:59:14.808Z] [DEBUG] [QueryManager] Run - Subscribe to remote query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:59:14.808Z] [DEBUG] [QueryManager] Subscribe Remote Query - Starting { queryHash: [33m5287015697723528[39m, query: [32m'LIVE SELECT * FROM thread;'[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:59:14.808Z] [DEBUG] [Database] Query Remote Database - Result {
  sql: [32m'LIVE SELECT * FROM thread;'[39m,
  vars: [90mundefined[39m,
  result: [ Uuid {} ]
}

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:59:14.808Z] [DEBUG] [QueryManager] Subscribe Remote Query - Created Live UUID { queryHash: [33m5287015697723528[39m, liveUuid: Uuid {} }

stderr | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[Database] liveQuery method not found on Surreal instance. Live updates will not work.

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:59:14.809Z] [DEBUG] [QueryManager] Subscribe Remote Query - Subscribed to Live UUID { queryHash: [33m5287015697723528[39m, liveUuid: Uuid {} }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:59:14.809Z] [DEBUG] [QueryManager] Run - Initialize subqueries [33m5287015697723528[39m

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:59:24.739Z] [INFO] [Provisioning] Starting provision check...

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:59:24.740Z] [DEBUG] [Provisioning] Schema hash: 36219f6c156e8612442cf558e26fc4750fa5daf8
[2025-11-30T13:59:24.740Z] [DEBUG] [Provisioning] Schema up to date: false
[2025-11-30T13:59:24.740Z] [DEBUG] [Provisioning] Should migrate: true
[2025-11-30T13:59:24.740Z] [INFO] [Provisioning] Initializing internal database schema...

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:59:24.740Z] [INFO] [Provisioning] Starting schema migration...

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:59:24.746Z] [DEBUG] [Provisioning] Recording schema hash...

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:59:24.746Z] [INFO] [Provisioning] Database schema provisioned successfully

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[buildQuery] Generated SELECT query: SELECT * FROM thread;
[buildQuery] Query vars: {}
[buildQuery] Generated SELECT query: SELECT * FROM thread;
[buildQuery] Query vars: {}
[buildQuery] Generated LIVE SELECT query: LIVE SELECT * FROM thread;
[buildQuery] Query vars: {}
[2025-11-30T13:59:24.798Z] [DEBUG] [QueryManager] Run - Cache miss { queryHash: [33m5287015697723528[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:59:24.798Z] [DEBUG] [QueryManager] Run - Initialize query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:59:24.798Z] [DEBUG] [QueryManager] Run - Refresh query locally { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:59:24.798Z] [DEBUG] [QueryManager] Local Query Refresh - Starting { queryHash: [33m5287015697723528[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:59:24.798Z] [DEBUG] [Database] Query Local Database - Result { sql: [32m'SELECT * FROM thread;'[39m, vars: [90mundefined[39m, result: [ [] ] }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:59:24.798Z] [DEBUG] [QueryManager] Local Query Refresh - Done { queryHash: [33m5287015697723528[39m, resultLength: [33m0[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:59:24.798Z] [DEBUG] [Database] Query Local Database - Result {
  sql: [32m'RETURN crypto::blake3($data)'[39m,
  vars: { data: [32m'[]'[39m },
  result: [
    [32m'd53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab'[39m
  ]
}

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:59:24.799Z] [DEBUG] [QueryManager] Local Query Refresh - Decoded results { decodedResults: [] }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:59:24.799Z] [DEBUG] [QueryManager] Run - Hydrate remote query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:59:24.799Z] [DEBUG] [QueryManager] Remote Query Hydration - Starting { queryHash: [33m5287015697723528[39m, query: [32m'SELECT * FROM thread;'[39m }
[DEBUG] Fetching remote hash with query: RETURN crypto::blake3(string::json({ SELECT * FROM thread }))

stderr | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[DEBUG] Remote hash fetch failed: RemoteDatabaseError: Failed to execute query on remote database
    at Object.queryRemote [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/database.ts:110:13[90m)[39m
    at QueryManagerService.queryRemoteHydration [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:379:22[90m)[39m
    at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:629:9[90m)[39m {
  cause: [Error: There was a problem with the database: Parse error: Invalid function/constant path, did you maybe mean `string::join`
   --> [1:23]
    |
  1 | RETURN crypto::blake3(string::json({ SELECT * FROM thread }))
    |                       ^^^^^^^^^^^^ 
  ] {
    code: [32m'GenericFailure'[39m
  }
}

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:59:24.799Z] [WARN] [QueryManager] Remote Query Hydration - Failed to get remote hash (falling back to full fetch) RemoteDatabaseError: Failed to execute query on remote database
    at Object.queryRemote [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/database.ts:110:13[90m)[39m
    at QueryManagerService.queryRemoteHydration [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:379:22[90m)[39m
    at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:629:9[90m)[39m {
  cause: [Error: There was a problem with the database: Parse error: Invalid function/constant path, did you maybe mean `string::join`
   --> [1:23]
    |
  1 | RETURN crypto::blake3(string::json({ SELECT * FROM thread }))
    |                       ^^^^^^^^^^^^ 
  ] {
    code: [32m'GenericFailure'[39m
  }
}
[DEBUG] Comparing hashes. Local: d53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab Remote: [90mundefined[39m
[2025-11-30T13:59:24.799Z] [DEBUG] [QueryManager] Remote Query Hydration - Hash mismatch or missing, fetching data {
  queryHash: [33m5287015697723528[39m,
  localHash: [32m'd53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab'[39m,
  remoteHash: [90mundefined[39m
}

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:59:24.799Z] [DEBUG] [Database] Query Remote Database - Result {
  sql: [32m'SELECT * FROM thread;'[39m,
  vars: [90mundefined[39m,
  result: [ [ [36m[Object][39m, [36m[Object][39m ] ]
}

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:59:24.799Z] [DEBUG] [QueryManager] Remote Query Hydration - Remote query done { queryHash: [33m5287015697723528[39m, resultLength: [33m2[39m }
[2025-11-30T13:59:24.799Z] [DEBUG] [QueryManager] Materialize remote record update - Starting { records: [33m2[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:59:24.800Z] [WARN] [QueryManager] Remote hydration failed (continuing with local data) TypeError: Cannot read properties of undefined (reading 'toString')
    at [90m/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:267:28
    at Array.map (<anonymous>)
    at QueryManagerService.materializeRemoteRecordUpdate [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:264:8[90m)[39m
    at QueryManagerService.queryRemoteHydration [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:427:16[90m)[39m
    at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:629:9[90m)[39m
[2025-11-30T13:59:24.800Z] [DEBUG] [QueryManager] Run - Subscribe to remote query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:59:24.800Z] [DEBUG] [QueryManager] Subscribe Remote Query - Starting { queryHash: [33m5287015697723528[39m, query: [32m'LIVE SELECT * FROM thread;'[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:59:24.800Z] [DEBUG] [Database] Query Remote Database - Result {
  sql: [32m'LIVE SELECT * FROM thread;'[39m,
  vars: [90mundefined[39m,
  result: [ Uuid {} ]
}

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:59:24.800Z] [DEBUG] [QueryManager] Subscribe Remote Query - Created Live UUID { queryHash: [33m5287015697723528[39m, liveUuid: Uuid {} }

stderr | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[Database] liveQuery method not found on Surreal instance. Live updates will not work.

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:59:24.800Z] [DEBUG] [QueryManager] Subscribe Remote Query - Subscribed to Live UUID { queryHash: [33m5287015697723528[39m, liveUuid: Uuid {} }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:59:24.800Z] [DEBUG] [QueryManager] Run - Initialize subqueries [33m5287015697723528[39m

 â¯ test/sync.test.ts (2 tests | 2 failed) 20008ms
   Ã— Sync Protocol > should fetch data on initial sync (hash mismatch) 10003ms
     â†’ Test timed out in 10000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".
   Ã— Sync Protocol > should NOT fetch data if hashes match 10003ms
     â†’ Test timed out in 10000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".

â¯â¯â¯â¯â¯â¯â¯ Failed Tests 2 â¯â¯â¯â¯â¯â¯â¯

 FAIL  test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
Error: Test timed out in 10000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".
 â¯ test/sync.test.ts:22:5
     20| 
     21| describe("Sync Protocol", () => {
     22|     it("should fetch data on initial sync (hash mismatch)", async () =â€¦
       |     ^
     23|         const { spooky, dbContext } = await createMockSpooky(mockConfiâ€¦
     24|         try {

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[1/2]â¯

 FAIL  test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
Error: Test timed out in 10000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".
 â¯ test/sync.test.ts:79:5
     77|     }, 10000);
     78| 
     79|     it("should NOT fetch data if hashes match", async () => {
       |     ^
     80|         const { spooky, dbContext } = await createMockSpooky(mockConfiâ€¦
     81|         try {

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[2/2]â¯


 Test Files  1 failed (1)
      Tests  2 failed (2)
   Start at  14:59:14
   Duration  20.20s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  src/services/query-manager.ts x9 
        Filename pattern: test/sync.test.ts

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:59:35.094Z] [INFO] [Provisioning] Starting provision check...

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:59:35.096Z] [DEBUG] [Provisioning] Schema hash: 36219f6c156e8612442cf558e26fc4750fa5daf8
[2025-11-30T13:59:35.096Z] [DEBUG] [Provisioning] Schema up to date: false
[2025-11-30T13:59:35.096Z] [DEBUG] [Provisioning] Should migrate: true
[2025-11-30T13:59:35.096Z] [INFO] [Provisioning] Initializing internal database schema...

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:59:35.097Z] [INFO] [Provisioning] Starting schema migration...

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:59:35.107Z] [DEBUG] [Provisioning] Recording schema hash...

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:59:35.108Z] [INFO] [Provisioning] Database schema provisioned successfully

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
Create Result: [
  [
    {
      "author": "user:userA",
      "content": "content",
      "created_at": "2025-11-30T13:59:35.151409Z",
      "id": "thread:sync1",
      "title": "sync1"
    }
  ]
]

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
Thread Check: [
  [
    {
      "author": "user:userA",
      "content": "content",
      "created_at": "2025-11-30T13:59:35.151409Z",
      "id": "thread:sync1",
      "title": "sync1"
    }
  ]
]

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[buildQuery] Generated SELECT query: SELECT * FROM thread;
[buildQuery] Query vars: {}
[buildQuery] Generated SELECT query: SELECT * FROM thread;
[buildQuery] Query vars: {}
[buildQuery] Generated LIVE SELECT query: LIVE SELECT * FROM thread;
[buildQuery] Query vars: {}
[2025-11-30T13:59:35.153Z] [DEBUG] [QueryManager] Run - Cache miss { queryHash: [33m5287015697723528[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:59:35.154Z] [DEBUG] [QueryManager] Run - Initialize query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:59:35.154Z] [DEBUG] [QueryManager] Run - Refresh query locally { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:59:35.154Z] [DEBUG] [QueryManager] Local Query Refresh - Starting { queryHash: [33m5287015697723528[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:59:35.154Z] [DEBUG] [Database] Query Local Database - Result { sql: [32m'SELECT * FROM thread;'[39m, vars: [90mundefined[39m, result: [ [] ] }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:59:35.154Z] [DEBUG] [QueryManager] Local Query Refresh - Done { queryHash: [33m5287015697723528[39m, resultLength: [33m0[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:59:35.155Z] [DEBUG] [Database] Query Local Database - Result {
  sql: [32m'RETURN crypto::blake3($data)'[39m,
  vars: { data: [32m'[]'[39m },
  result: [
    [32m'd53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab'[39m
  ]
}

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:59:35.155Z] [DEBUG] [QueryManager] Local Query Refresh - Decoded results { decodedResults: [] }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:59:35.155Z] [DEBUG] [QueryManager] Run - Hydrate remote query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:59:35.155Z] [DEBUG] [QueryManager] Remote Query Hydration - Starting { queryHash: [33m5287015697723528[39m, query: [32m'SELECT * FROM thread;'[39m }
[DEBUG] Fetching remote hash with query: RETURN crypto::blake3({ SELECT * FROM thread })

stderr | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[DEBUG] Remote hash fetch failed: RemoteDatabaseError: Failed to execute query on remote database
    at Object.queryRemote [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/database.ts:110:13[90m)[39m
    at QueryManagerService.queryRemoteHydration [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:379:22[90m)[39m
    at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:629:9[90m)[39m {
  cause: ResponseError: Incorrect arguments for function crypto::blake3(). Argument 1 was the wrong type. Expected a string but found NONE
      at Query.collect (file:///Users/khadim/dev/spooky/node_modules/[4m.pnpm[24m/surrealdb@2.0.0-alpha.14_tslib@2.8.1_typescript@5.9.3/node_modules/[4msurrealdb[24m/dist/surrealdb.mjs:3135:27)
      at Object.queryRemote [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/database.ts:89:11[90m)[39m
      at QueryManagerService.queryRemoteHydration [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:379:22[90m)[39m
      at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:629:9[90m)[39m {
    code: [33m0[39m
  }
}

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:59:35.158Z] [WARN] [QueryManager] Remote Query Hydration - Failed to get remote hash (falling back to full fetch) RemoteDatabaseError: Failed to execute query on remote database
    at Object.queryRemote [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/database.ts:110:13[90m)[39m
    at QueryManagerService.queryRemoteHydration [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:379:22[90m)[39m
    at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:629:9[90m)[39m {
  cause: ResponseError: Incorrect arguments for function crypto::blake3(). Argument 1 was the wrong type. Expected a string but found NONE
      at Query.collect (file:///Users/khadim/dev/spooky/node_modules/[4m.pnpm[24m/surrealdb@2.0.0-alpha.14_tslib@2.8.1_typescript@5.9.3/node_modules/[4msurrealdb[24m/dist/surrealdb.mjs:3135:27)
      at Object.queryRemote [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/database.ts:89:11[90m)[39m
      at QueryManagerService.queryRemoteHydration [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:379:22[90m)[39m
      at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:629:9[90m)[39m {
    code: [33m0[39m
  }
}
[DEBUG] Comparing hashes. Local: d53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab Remote: [90mundefined[39m
[2025-11-30T13:59:35.158Z] [DEBUG] [QueryManager] Remote Query Hydration - Hash mismatch or missing, fetching data {
  queryHash: [33m5287015697723528[39m,
  localHash: [32m'd53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab'[39m,
  remoteHash: [90mundefined[39m
}

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:59:35.158Z] [DEBUG] [Database] Query Remote Database - Result {
  sql: [32m'SELECT * FROM thread;'[39m,
  vars: [90mundefined[39m,
  result: [ [ [36m[Object][39m ] ]
}

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:59:35.158Z] [DEBUG] [QueryManager] Remote Query Hydration - Remote query done { queryHash: [33m5287015697723528[39m, resultLength: [33m1[39m }
[2025-11-30T13:59:35.158Z] [DEBUG] [QueryManager] Materialize remote record update - Starting { records: [33m1[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:59:35.158Z] [WARN] [QueryManager] Remote hydration failed (continuing with local data) TypeError: Cannot read properties of undefined (reading 'toString')
    at [90m/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:267:28
    at Array.map (<anonymous>)
    at QueryManagerService.materializeRemoteRecordUpdate [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:264:8[90m)[39m
    at QueryManagerService.queryRemoteHydration [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:427:16[90m)[39m
    at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:629:9[90m)[39m
[2025-11-30T13:59:35.159Z] [DEBUG] [QueryManager] Run - Subscribe to remote query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:59:35.159Z] [DEBUG] [QueryManager] Subscribe Remote Query - Starting { queryHash: [33m5287015697723528[39m, query: [32m'LIVE SELECT * FROM thread;'[39m }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:59:35.159Z] [DEBUG] [Database] Query Remote Database - Result {
  sql: [32m'LIVE SELECT * FROM thread;'[39m,
  vars: [90mundefined[39m,
  result: [ Uuid {} ]
}

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:59:35.159Z] [DEBUG] [QueryManager] Subscribe Remote Query - Created Live UUID { queryHash: [33m5287015697723528[39m, liveUuid: Uuid {} }

stderr | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[Database] liveQuery method not found on Surreal instance. Live updates will not work.

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:59:35.159Z] [DEBUG] [QueryManager] Subscribe Remote Query - Subscribed to Live UUID { queryHash: [33m5287015697723528[39m, liveUuid: Uuid {} }

stdout | test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
[2025-11-30T13:59:35.159Z] [DEBUG] [QueryManager] Run - Initialize subqueries [33m5287015697723528[39m

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:59:45.089Z] [INFO] [Provisioning] Starting provision check...

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:59:45.089Z] [DEBUG] [Provisioning] Schema hash: 36219f6c156e8612442cf558e26fc4750fa5daf8
[2025-11-30T13:59:45.090Z] [DEBUG] [Provisioning] Schema up to date: false
[2025-11-30T13:59:45.090Z] [DEBUG] [Provisioning] Should migrate: true
[2025-11-30T13:59:45.090Z] [INFO] [Provisioning] Initializing internal database schema...

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:59:45.090Z] [INFO] [Provisioning] Starting schema migration...

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:59:45.096Z] [DEBUG] [Provisioning] Recording schema hash...

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:59:45.097Z] [INFO] [Provisioning] Database schema provisioned successfully

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[buildQuery] Generated SELECT query: SELECT * FROM thread;
[buildQuery] Query vars: {}
[buildQuery] Generated SELECT query: SELECT * FROM thread;
[buildQuery] Query vars: {}
[buildQuery] Generated LIVE SELECT query: LIVE SELECT * FROM thread;
[buildQuery] Query vars: {}
[2025-11-30T13:59:45.150Z] [DEBUG] [QueryManager] Run - Cache miss { queryHash: [33m5287015697723528[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:59:45.150Z] [DEBUG] [QueryManager] Run - Initialize query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:59:45.150Z] [DEBUG] [QueryManager] Run - Refresh query locally { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:59:45.150Z] [DEBUG] [QueryManager] Local Query Refresh - Starting { queryHash: [33m5287015697723528[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:59:45.150Z] [DEBUG] [Database] Query Local Database - Result { sql: [32m'SELECT * FROM thread;'[39m, vars: [90mundefined[39m, result: [ [] ] }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:59:45.150Z] [DEBUG] [QueryManager] Local Query Refresh - Done { queryHash: [33m5287015697723528[39m, resultLength: [33m0[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:59:45.150Z] [DEBUG] [Database] Query Local Database - Result {
  sql: [32m'RETURN crypto::blake3($data)'[39m,
  vars: { data: [32m'[]'[39m },
  result: [
    [32m'd53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab'[39m
  ]
}

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:59:45.151Z] [DEBUG] [QueryManager] Local Query Refresh - Decoded results { decodedResults: [] }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:59:45.151Z] [DEBUG] [QueryManager] Run - Hydrate remote query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:59:45.151Z] [DEBUG] [QueryManager] Remote Query Hydration - Starting { queryHash: [33m5287015697723528[39m, query: [32m'SELECT * FROM thread;'[39m }
[DEBUG] Fetching remote hash with query: RETURN crypto::blake3({ SELECT * FROM thread })

stderr | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[DEBUG] Remote hash fetch failed: RemoteDatabaseError: Failed to execute query on remote database
    at Object.queryRemote [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/database.ts:110:13[90m)[39m
    at QueryManagerService.queryRemoteHydration [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:379:22[90m)[39m
    at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:629:9[90m)[39m {
  cause: ResponseError: Incorrect arguments for function crypto::blake3(). Argument 1 was the wrong type. Expected a string but found NONE
      at Query.collect (file:///Users/khadim/dev/spooky/node_modules/[4m.pnpm[24m/surrealdb@2.0.0-alpha.14_tslib@2.8.1_typescript@5.9.3/node_modules/[4msurrealdb[24m/dist/surrealdb.mjs:3135:27)
      at Object.queryRemote [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/database.ts:89:11[90m)[39m
      at QueryManagerService.queryRemoteHydration [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:379:22[90m)[39m
      at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:629:9[90m)[39m {
    code: [33m0[39m
  }
}

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:59:45.151Z] [WARN] [QueryManager] Remote Query Hydration - Failed to get remote hash (falling back to full fetch) RemoteDatabaseError: Failed to execute query on remote database
    at Object.queryRemote [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/database.ts:110:13[90m)[39m
    at QueryManagerService.queryRemoteHydration [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:379:22[90m)[39m
    at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:629:9[90m)[39m {
  cause: ResponseError: Incorrect arguments for function crypto::blake3(). Argument 1 was the wrong type. Expected a string but found NONE
      at Query.collect (file:///Users/khadim/dev/spooky/node_modules/[4m.pnpm[24m/surrealdb@2.0.0-alpha.14_tslib@2.8.1_typescript@5.9.3/node_modules/[4msurrealdb[24m/dist/surrealdb.mjs:3135:27)
      at Object.queryRemote [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/database.ts:89:11[90m)[39m
      at QueryManagerService.queryRemoteHydration [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:379:22[90m)[39m
      at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:629:9[90m)[39m {
    code: [33m0[39m
  }
}
[DEBUG] Comparing hashes. Local: d53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab Remote: [90mundefined[39m
[2025-11-30T13:59:45.151Z] [DEBUG] [QueryManager] Remote Query Hydration - Hash mismatch or missing, fetching data {
  queryHash: [33m5287015697723528[39m,
  localHash: [32m'd53d18c23212ea7b6300594bb89bce60218f6eff2b9d628b8cc42d3e79bbd5ab'[39m,
  remoteHash: [90mundefined[39m
}

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:59:45.152Z] [DEBUG] [Database] Query Remote Database - Result {
  sql: [32m'SELECT * FROM thread;'[39m,
  vars: [90mundefined[39m,
  result: [ [ [36m[Object][39m, [36m[Object][39m ] ]
}

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:59:45.152Z] [DEBUG] [QueryManager] Remote Query Hydration - Remote query done { queryHash: [33m5287015697723528[39m, resultLength: [33m2[39m }
[2025-11-30T13:59:45.152Z] [DEBUG] [QueryManager] Materialize remote record update - Starting { records: [33m2[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:59:45.152Z] [WARN] [QueryManager] Remote hydration failed (continuing with local data) TypeError: Cannot read properties of undefined (reading 'toString')
    at [90m/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:267:28
    at Array.map (<anonymous>)
    at QueryManagerService.materializeRemoteRecordUpdate [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:264:8[90m)[39m
    at QueryManagerService.queryRemoteHydration [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:427:16[90m)[39m
    at QueryManagerService.initQuery [90m(/Users/khadim/dev/spooky/packages/spooky-ts/[39msrc/services/query-manager.ts:629:9[90m)[39m
[2025-11-30T13:59:45.152Z] [DEBUG] [QueryManager] Run - Subscribe to remote query { queryHash: [33m5287015697723528[39m }
[2025-11-30T13:59:45.152Z] [DEBUG] [QueryManager] Subscribe Remote Query - Starting { queryHash: [33m5287015697723528[39m, query: [32m'LIVE SELECT * FROM thread;'[39m }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:59:45.152Z] [DEBUG] [Database] Query Remote Database - Result {
  sql: [32m'LIVE SELECT * FROM thread;'[39m,
  vars: [90mundefined[39m,
  result: [ Uuid {} ]
}

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:59:45.152Z] [DEBUG] [QueryManager] Subscribe Remote Query - Created Live UUID { queryHash: [33m5287015697723528[39m, liveUuid: Uuid {} }

stderr | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[Database] liveQuery method not found on Surreal instance. Live updates will not work.

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:59:45.152Z] [DEBUG] [QueryManager] Subscribe Remote Query - Subscribed to Live UUID { queryHash: [33m5287015697723528[39m, liveUuid: Uuid {} }

stdout | test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
[2025-11-30T13:59:45.152Z] [DEBUG] [QueryManager] Run - Initialize subqueries [33m5287015697723528[39m

 â¯ test/sync.test.ts (2 tests | 2 failed) 20008ms
   Ã— Sync Protocol > should fetch data on initial sync (hash mismatch) 10003ms
     â†’ Test timed out in 10000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".
   Ã— Sync Protocol > should NOT fetch data if hashes match 10004ms
     â†’ Test timed out in 10000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".

â¯â¯â¯â¯â¯â¯â¯ Failed Tests 2 â¯â¯â¯â¯â¯â¯â¯

 FAIL  test/sync.test.ts > Sync Protocol > should fetch data on initial sync (hash mismatch)
Error: Test timed out in 10000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".
 â¯ test/sync.test.ts:22:5
     20| 
     21| describe("Sync Protocol", () => {
     22|     it("should fetch data on initial sync (hash mismatch)", async () =â€¦
       |     ^
     23|         const { spooky, dbContext } = await createMockSpooky(mockConfiâ€¦
     24|         try {

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[1/2]â¯

 FAIL  test/sync.test.ts > Sync Protocol > should NOT fetch data if hashes match
Error: Test timed out in 10000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".
 â¯ test/sync.test.ts:79:5
     77|     }, 10000);
     78| 
     79|     it("should NOT fetch data if hashes match", async () => {
       |     ^
     80|         const { spooky, dbContext } = await createMockSpooky(mockConfiâ€¦
     81|         try {

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[2/2]â¯


 Test Files  1 failed (1)
      Tests  2 failed (2)
   Start at  14:59:34
   Duration  20.18s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
