services:
  surrealdb:
    image: surrealdb/surrealdb:latest
    ports:
      - "8000:8000"
    environment:
      - SURREAL_USER=root
      - SURREAL_PASS=root
      - SURREAL_CAPS_ALLOW_EXPERIMENTAL=record_references
    volumes:
      - ./schema.surql:/schema.surql:ro
    command: start --log info --user root --pass root --allow-experimental=record_references memory
    healthcheck:
      test: ["CMD", "/surreal", "isready", "--conn", "http://localhost:8000"]
      interval: 10s
      timeout: 5s
      retries: 5git
    restart: unless-stopped

  schema-migration:
    image: curlimages/curl:latest
    depends_on:
      surrealdb:
        condition: service_healthy
    volumes:
      - ./schema.surql:/schema.surql:ro
    command: >
      sh -c "curl -X POST http://surrealdb:8000/sql
      -H 'Accept: application/json'
      -H 'surreal-ns: main'
      -H 'surreal-db: main'
      -u root:root
      --data-binary @/schema.surql && echo 'Schema migration completed successfully'"
    restart: "no"
