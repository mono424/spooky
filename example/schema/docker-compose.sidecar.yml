x-bake:
  default:
    args:
      DOCKER_BUILDKIT: 1

services:
  aspire-dashboard:
    image: mcr.microsoft.com/dotnet/aspire-dashboard:latest
    container_name: aspire-dashboard
    environment:
      - DOTNET_DASHBOARD_UNSECURED_ALLOW_ANONYMOUS=true
      - DOTNET_DASHBOARD_OTLP_AUTH_MODE=Unsecured
      - ASPNETCORE_ENVIRONMENT=Development
      - DOTNET_DASHBOARD_OTLP_CORS_ALLOWED_ORIGINS=http://localhost:3006,http://localhost:3000,http://127.0.0.1:3006,http://127.0.0.1:3000,https://localhost:3006,https://localhost:3000
      - DOTNET_DASHBOARD_OTLP_CORS_ALLOWED_HEADERS=*
      - DASHBOARD__OTLP__CORS__ALLOWEDORIGINS=http://localhost:3006,http://localhost:3000,http://127.0.0.1:3006,http://127.0.0.1:3000,https://localhost:3006,https://localhost:3000
      - DASHBOARD__OTLP__CORS__ALLOWEDHEADERS=*
    ports:
      - '18888:18888'
      - '4317:18889'
      - '4318:18890'
    restart: unless-stopped

  surrealdb:
    image: surrealdb/surrealdb:v3.0.0-beta.1
    ports:
      - '8666:8000'
    environment:
      - SURREAL_USER=root
      - SURREAL_PASS=root
      - SURREAL_CAPS_ALLOW_EXPERIMENTAL=surrealism,files
      - SURREAL_BUCKET_FOLDER_ALLOWLIST=/modules
      # --- OTLP KONFIGURATION ---
      # Aktiviert OTLP Export für Tracing
      - SURREAL_TELEMETRY_PROVIDER=otlp
      - SURREAL_TELEMETRY_SERVICE_NAME=surrealdb
      #- SURREAL_TELEMETRY_DISABLE_METRICS=true # Stop metrics collection (often source of 'collect' spans)
      #- SURREAL_TELEMETRY_DISABLE_TRACING=true
      # Ziel: Aspire Dashboard
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://aspire-dashboard:18889
      # Reduziert Terminal-Logs (optional, da wir jetzt traces haben)
      - SURREAL_LOG=info
      #- RUST_LOG=debug # Force DEBUG globally to verify ssp package logs appear
    command:
      - start
      - --bind
      - 0.0.0.0:8000
      - --allow-all
      - --user
      - root
      - --pass
      - root
      - memory
    volumes:
      - ./.spooky/xor_module.surli:/modules/xor_module.surli:ro
      - ./.spooky/dbsp_module.surli:/modules/dbsp_module.surli:ro
    depends_on:
      - aspire-dashboard
    healthcheck:
      test: ['CMD', '/surreal', 'isready', '--conn', 'http://localhost:8000']
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  ssp:
    build:
      context: ../../
      dockerfile: apps/ssp/Dockerfile
    ports:
      - '8667:8667'
    environment:
      - RUST_LOG=info,ssp=debug
      # --- OTLP KONFIGURATION ---
      # Ziel für Rust Tracing
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://aspire-dashboard:18889
      - OTEL_SERVICE_NAME=spooky-sidecar
      # DB Connection
      - SURREALDB_ADDR=surrealdb:8000/rpc
      - SURREALDB_NS=main
      - SURREALDB_DB=main
      - SURREALDB_USER=root
      - SURREALDB_PASS=root
      - SPOOKY_AUTH_SECRET=mysecret
      - SPOOKY_PERSISTENCE_FILE=/data/spooky_state.json
      # Job Runner Config
      - SPOOKY_CONFIG_PATH=/config/spooky.yml
    volumes:
      - ./.spooky/sidecar_data:/data
      - ./spooky.yml:/config/spooky.yml:ro
    depends_on:
      surrealdb:
        condition: service_healthy
      aspire-dashboard:
        condition: service_started
      schema-migration:
        condition: service_completed_successfully
    restart: unless-stopped

  schema-migration:
    image: curlimages/curl:latest
    depends_on:
      surrealdb:
        condition: service_healthy
    volumes:
      - ./.spooky/remote-sidecar.gen.surql:/remote.gen.surql:ro
      - ./migrate.sh:/migrate.sh:ro
    command: ['sh', '/migrate.sh']
    restart: 'no'
