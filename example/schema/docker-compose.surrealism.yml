services:
  surrealdb:
    image: surrealdb/surrealdb:v3.0.0-beta.1
    ports:
      - '8666:8000'
    environment:
      - SURREAL_USER=root
      - SURREAL_PASS=root
      - SURREAL_CAPS_ALLOW_EXPERIMENTAL=surrealism,files
      - SURREAL_BUCKET_FOLDER_ALLOWLIST=/modules
    command:
      - start
      - --allow-all
      - --log
      - info
      - --user
      - root
      - --pass
      - root
      - memory
    volumes:
      - ./.spooky/xor_module.surli:/modules/xor_module.surli:ro
      - ./.spooky/dbsp_module.surli:/modules/dbsp_module.surli:ro
    healthcheck:
      test: ['CMD', '/surreal', 'isready', '--conn', 'http://localhost:8000']
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  schema-migration:
    image: curlimages/curl:latest
    depends_on:
      surrealdb:
        condition: service_healthy
    volumes:
      - ./.spooky/remote-surrealism.gen.surql:/remote.gen.surql:ro
      - ./migrate.sh:/migrate.sh:ro
    command: ['sh', '/migrate.sh']
    restart: 'no'
