// This file is auto-generated. Do not edit manually.
// Generated by syncgen - any changes will be overwritten.

export const schema = {
  tables: [
    {
      name: 'comment' as const,
      columns: {
        id: { type: 'string' as const, recordId: true, optional: false },
        author: { type: 'string' as const, recordId: true, optional: false },
        content: { type: 'string' as const, optional: false },
        created_at: { type: 'string' as const, dateTime: true, optional: true },
        thread: { type: 'string' as const, recordId: true, optional: false },
      },
      primaryKey: ['id'] as const
    },
    {
      name: 'commented_on' as const,
      columns: {
        id: { type: 'string' as const, recordId: true, optional: false },
      },
      primaryKey: ['id'] as const
    },
    {
      name: 'job' as const,
      columns: {
        id: { type: 'string' as const, recordId: true, optional: false },
        assigned_to: { type: 'string' as const, recordId: true, optional: false },
        created_at: { type: 'string' as const, dateTime: true, optional: true },
        max_retries: { type: 'number' as const, optional: false },
        path: { type: 'string' as const, optional: false },
        payload: { type: 'string' as const, optional: false },
        retries: { type: 'number' as const, optional: false },
        retry_strategy: { type: 'string' as const, optional: false },
        status: { type: 'string' as const, optional: false },
        updated_at: { type: 'string' as const, dateTime: true, optional: true },
      },
      primaryKey: ['id'] as const
    },
    {
      name: 'thread' as const,
      columns: {
        id: { type: 'string' as const, recordId: true, optional: false },
        active: { type: 'boolean' as const, optional: true },
        author: { type: 'string' as const, recordId: true, optional: false },
        content: { type: 'string' as const, optional: false },
        content_suggestion: { type: 'string' as const, optional: true },
        created_at: { type: 'string' as const, dateTime: true, optional: true },
        title: { type: 'string' as const, optional: false },
        title_suggestion: { type: 'string' as const, optional: true },
        comments: { type: 'string' as const, optional: true },
        jobs: { type: 'string' as const, optional: true },
      },
      primaryKey: ['id'] as const
    },
    {
      name: 'user' as const,
      columns: {
        id: { type: 'string' as const, recordId: true, optional: false },
        username: { type: 'string' as const, optional: false },
        comments: { type: 'string' as const, optional: true },
        threads: { type: 'string' as const, optional: true },
      },
      primaryKey: ['id'] as const
    },
  ],
  relationships: [
    {
      from: 'comment' as const,
      field: 'author' as const,
      to: 'user' as const,
      cardinality: 'one' as const
    },
    {
      from: 'comment' as const,
      field: 'thread' as const,
      to: 'thread' as const,
      cardinality: 'one' as const
    },
    {
      from: 'job' as const,
      field: 'assigned_to' as const,
      to: 'thread' as const,
      cardinality: 'one' as const
    },
    {
      from: 'thread' as const,
      field: 'author' as const,
      to: 'user' as const,
      cardinality: 'one' as const
    },
    {
      from: 'thread' as const,
      field: 'comments' as const,
      to: 'comment' as const,
      cardinality: 'many' as const
    },
    {
      from: 'thread' as const,
      field: 'jobs' as const,
      to: 'job' as const,
      cardinality: 'many' as const
    },
    {
      from: 'user' as const,
      field: 'comments' as const,
      to: 'comment' as const,
      cardinality: 'many' as const
    },
    {
      from: 'user' as const,
      field: 'threads' as const,
      to: 'thread' as const,
      cardinality: 'many' as const
    },
  ],
  access: {
    account: {"signIn":{"params":{"password":{"type":"string","optional":false},"username":{"type":"string","optional":false}}},"signup":{"params":{"password":{"type":"string","optional":false},"username":{"type":"string","optional":false}}}},
  },
  backends: {
    "api": {
      outboxTable: 'job' as const,
      routes: {
        "/spookify": {
          args: {
            "id": {
              type: 'string' as const,
              optional: false as const
            },
          }
        },
      }
    },
  },
} as const;

export type SchemaDefinition = typeof schema;


/**
 * The complete SurrealDB schema definition.
 * This constant contains the raw .surql schema file content.
 */
export const SURQL_SCHEMA = `-- ##################################################################
-- SCOPES & AUTHENTICATION
-- ##################################################################

DEFINE FUNCTION fn::polyfill::createAccount($username: string, $password: string) {
  IF string::len($username) <= 3 { THROW "Username must be longer than 3 characters" };
  IF string::len($password) == 0 { THROW "Password cannot be empty" };

  LET $existing = (SELECT value id FROM user WHERE username = $username LIMIT 1)[0];
  IF $existing != NONE { THROW "Username '" + <string>$username + "' is already taken" };

  LET $u = (CREATE user SET username = $username, password = crypto::argon2::generate($password))[0];
  RETURN $u;
};

-- ##################################################################
-- USER TABLE
-- ##################################################################

DEFINE TABLE user SCHEMAFULL
PERMISSIONS FOR select, create, update, delete WHERE true;

DEFINE FIELD username ON TABLE user TYPE option<string>
ASSERT $value != NONE AND string::len($value) > 3
PERMISSIONS FOR select, create, update WHERE true;
    
DEFINE INDEX unique_username ON TABLE user FIELDS username UNIQUE;



-- ##################################################################
-- THREAD TABLE
-- ##################################################################

DEFINE TABLE thread SCHEMAFULL
PERMISSIONS FOR select, create, update, delete WHERE true
;

DEFINE FIELD title ON TABLE thread TYPE option<string>
    ASSERT $value != NONE AND string::len($value) > 0 AND string::len($value) <= 200;

DEFINE FIELD content ON TABLE thread TYPE option<string>
    ASSERT $value != NONE AND string::len($value) > 0;

DEFINE FIELD title_suggestion ON TABLE thread TYPE option<string>;

DEFINE FIELD content_suggestion ON TABLE thread TYPE option<string>;

DEFINE FIELD author ON TABLE thread TYPE option<record<user>>; -- @parent

DEFINE FIELD created_at ON TABLE thread TYPE option<datetime>
    VALUE time::now();

DEFINE FIELD active ON TABLE thread TYPE option<bool> VALUE $value OR false;

-- ##################################################################
-- COMMENT TABLE
-- ##################################################################

DEFINE TABLE comment SCHEMAFULL
PERMISSIONS FOR select, create, update, delete WHERE true
;

DEFINE FIELD thread ON TABLE comment TYPE option<record<thread>>; -- @parent

DEFINE FIELD content ON TABLE comment TYPE option<string>
    ASSERT $value != NONE AND string::len($value) > 0;

DEFINE FIELD author ON TABLE comment TYPE option<record<user>>;

DEFINE FIELD created_at ON TABLE comment TYPE option<datetime>
    VALUE time::now();

-- ##################################################################
-- RELATION TABLES
-- ##################################################################

DEFINE TABLE commented_on SCHEMAFULL TYPE RELATION
  FROM comment TO thread
PERMISSIONS FOR select, create, update, delete WHERE true;

DEFINE EVENT comment_created ON TABLE comment WHEN $event = "CREATE" THEN
  RELATE ($after.id)->commented_on->($after.thread)
;

-- Backend Schema: api
-- ##################################################################
-- API OUTBOX TABLE
-- ##################################################################

DEFINE TABLE job SCHEMAFULL
PERMISSIONS FOR select, create, update, delete WHERE true;

DEFINE FIELD assigned_to ON TABLE job TYPE option<record<thread>>;

DEFINE FIELD path ON TABLE job TYPE option<string>;

DEFINE FIELD payload ON TABLE job TYPE any;

DEFINE FIELD retries ON TABLE job TYPE option<int> DEFAULT 0;

DEFINE FIELD max_retries ON TABLE job TYPE option<int> DEFAULT 3;

DEFINE FIELD retry_strategy ON TABLE job TYPE option<string> DEFAULT "linear"
ASSERT $value IN ["linear", "exponential"];

DEFINE FIELD status ON TABLE job TYPE option<string> DEFAULT "pending"
ASSERT $value IN ["pending", "processing", "success", "failed"];

DEFINE FIELD updated_at ON TABLE job TYPE option<datetime>
VALUE time::now();

DEFINE FIELD created_at ON TABLE job TYPE option<datetime>
VALUE time::now();

-- ==================================================
-- SPOOKY INCANTATION
-- The Registry of active Live Queries (Incantations).
-- Moved to meta_tables_client.surql and meta_tables_remote.surql
-- ==================================================

-- ==================================================
-- SPOOKY SCHEMA
-- The provisioned schema state for the database. Currently only used in local cache.
-- Used in local-migrator.ts
-- ==================================================

DEFINE TABLE IF NOT EXISTS _spooky_schema SCHEMAFULL;
DEFINE FIELD IF NOT EXISTS id ON _spooky_schema TYPE string;
DEFINE FIELD IF NOT EXISTS hash ON _spooky_schema TYPE string;
DEFINE FIELD IF NOT EXISTS created_at ON _spooky_schema TYPE datetime VALUE time::now();
DEFINE INDEX IF NOT EXISTS unique_hash ON _spooky_schema FIELDS hash UNIQUE;

-- ==================================================
-- SPOOKY STREAM PROCESSOR STATE
-- Stores the local state of the stream processor (DBSP)
-- ==================================================

DEFINE TABLE IF NOT EXISTS _spooky_stream_processor_state SCHEMALESS
PERMISSIONS FOR select, create, update, delete WHERE true;

DEFINE FIELD IF NOT EXISTS id ON _spooky_stream_processor_state TYPE string;
DEFINE FIELD IF NOT EXISTS state ON _spooky_stream_processor_state TYPE string;
DEFINE FIELD IF NOT EXISTS updated_at ON _spooky_stream_processor_state TYPE datetime VALUE time::now();

-- ==================================================
-- SPOOKY INCANTATION
-- The Registry of active Live Queries (Incantations).
-- ==================================================

DEFINE TABLE _spooky_query SCHEMALESS
PERMISSIONS FOR select, create, update, delete WHERE true;

DEFINE FIELD surql ON TABLE _spooky_query TYPE option<string>
PERMISSIONS FOR select, create, update WHERE true;

DEFINE FIELD localArray ON TABLE _spooky_query TYPE any
PERMISSIONS FOR select, create, update WHERE true;

DEFINE FIELD remoteArray ON TABLE _spooky_query TYPE any
PERMISSIONS FOR select, create, update WHERE true;

DEFINE FIELD lastActiveAt ON TABLE _spooky_query TYPE option<datetime> DEFAULT time::now()
PERMISSIONS FOR select, create, update WHERE true;

DEFINE FIELD ttl ON TABLE _spooky_query TYPE option<string>
PERMISSIONS FOR select, create, update WHERE true;

DEFINE FIELD tableName ON TABLE _spooky_query TYPE option<string>
PERMISSIONS FOR select, create, update WHERE true;

-- ==================================================
-- SPOOKY EVENTS
-- Stores create, update, and delete events
-- ==================================================

DEFINE TABLE _spooky_pending_mutations SCHEMAFULL
PERMISSIONS FOR select, create, update, delete WHERE true;

DEFINE FIELD IF NOT EXISTS id ON _spooky_pending_mutations TYPE string;

DEFINE FIELD IF NOT EXISTS mutationType ON _spooky_pending_mutations TYPE string
PERMISSIONS FOR select, create, update WHERE true;

-- The target record ID (for update/delete) - maps to 'id' in the event object
DEFINE FIELD IF NOT EXISTS recordId ON _spooky_pending_mutations TYPE option<record>
PERMISSIONS FOR select, create, update WHERE true;

-- The data payload (for create/update)
DEFINE FIELD IF NOT EXISTS data ON _spooky_pending_mutations TYPE option<object> FLEXIBLE
PERMISSIONS FOR select, create, update WHERE true;
DEFINE FIELD spooky_rv ON TABLE _spooky_pending_mutations TYPE int DEFAULT 0 PERMISSIONS FOR select, create, update, delete WHERE true;
DEFINE FIELD spooky_rv ON TABLE _spooky_query TYPE int DEFAULT 0 PERMISSIONS FOR select, create, update, delete WHERE true;
DEFINE FIELD spooky_rv ON TABLE _spooky_schema TYPE int DEFAULT 0 PERMISSIONS FOR select, create, update, delete WHERE true;
DEFINE FIELD spooky_rv ON TABLE _spooky_stream_processor_state TYPE int DEFAULT 0 PERMISSIONS FOR select, create, update, delete WHERE true;
DEFINE FIELD spooky_rv ON TABLE comment TYPE int DEFAULT 0 PERMISSIONS FOR select, create, update, delete WHERE true;
DEFINE FIELD spooky_rv ON TABLE commented_on TYPE int DEFAULT 0 PERMISSIONS FOR select, create, update, delete WHERE true;
DEFINE FIELD spooky_rv ON TABLE job TYPE int DEFAULT 0 PERMISSIONS FOR select, create, update, delete WHERE true;
DEFINE FIELD spooky_rv ON TABLE thread TYPE int DEFAULT 0 PERMISSIONS FOR select, create, update, delete WHERE true;
DEFINE FIELD spooky_rv ON TABLE user TYPE int DEFAULT 0 PERMISSIONS FOR select, create, update, delete WHERE true;


-- ==================================================
-- AUTO-GENERATED SPOOKY EVENTS
-- ==================================================

-- Table: comment Client Mutation
DEFINE EVENT OVERWRITE _spooky_comment_client_mutation ON TABLE comment
WHEN $before != $after AND $event != "DELETE"
THEN {
    -- No-op for now. Client mutation sync logic moved to DBSP.
};

-- Table: comment Client Deletion
DEFINE EVENT OVERWRITE _spooky_comment_client_delete ON TABLE comment
WHEN $event = "DELETE"
THEN {
    -- No-op for now.
};

-- Table: job Client Mutation
DEFINE EVENT OVERWRITE _spooky_job_client_mutation ON TABLE job
WHEN $before != $after AND $event != "DELETE"
THEN {
    -- No-op for now. Client mutation sync logic moved to DBSP.
};

-- Table: job Client Deletion
DEFINE EVENT OVERWRITE _spooky_job_client_delete ON TABLE job
WHEN $event = "DELETE"
THEN {
    -- No-op for now.
};

-- Table: thread Client Mutation
DEFINE EVENT OVERWRITE _spooky_thread_client_mutation ON TABLE thread
WHEN $before != $after AND $event != "DELETE"
THEN {
    -- No-op for now. Client mutation sync logic moved to DBSP.
};

-- Table: thread Client Deletion
DEFINE EVENT OVERWRITE _spooky_thread_client_delete ON TABLE thread
WHEN $event = "DELETE"
THEN {
    -- No-op for now.
};

-- Table: user Client Mutation
DEFINE EVENT OVERWRITE _spooky_user_client_mutation ON TABLE user
WHEN $before != $after AND $event != "DELETE"
THEN {
    -- No-op for now. Client mutation sync logic moved to DBSP.
};

-- Table: user Client Deletion
DEFINE EVENT OVERWRITE _spooky_user_client_delete ON TABLE user
WHEN $event = "DELETE"
THEN {
    -- No-op for now.
};
`;
