
> @spooky/tests@0.0.0 test /Users/khadim/dev/spooky/tests
> jest --runInBand surrealdb/dbsp.test.ts

  console.log
    Starting SurrealDB container...

      at getContainer (surrealdb/setup.ts:17:11)


 .d8888b.                                             888 8888888b.  888888b.
d88P  Y88b                                            888 888  'Y88b 888  '88b
Y88b.                                                 888 888    888 888  .88P
 'Y888b.   888  888 888d888 888d888  .d88b.   8888b.  888 888    888 8888888K.
    'Y88b. 888  888 888P'   888P'   d8P  Y8b     '88b 888 888    888 888  'Y88b
      '888 888  888 888     888     88888888 .d888888 888 888    888 888    888
Y88b  d88P Y88b 888 888     888     Y8b.     888  888 888 888  .d88P 888   d88P
 'Y8888P'   'Y88888 888     888      'Y8888  'Y888888 888 8888888P'  8888888P'


[2m2025-12-30T20:23:55.263006Z[0m [32m INFO[0m [2msurrealdb_server::env[0m[2m:[0m Running 3.0.0-alpha.17 for linux on aarch64
[2m2025-12-30T20:23:55.287063Z[0m [34mDEBUG[0m [1minit[0m: [2msurrealdb_server::dbs[0m[2m:[0m Server capabilities: scripting=true, guest_access=true, live_query_notifications=true, allow_funcs=all, deny_funcs=none, allow_net=all, deny_net=none, allow_rpc=all, deny_rpc=none, allow_http=all, deny_http=none, allow_experimental=all, deny_experimental=none, allow_arbitrary_query=all, deny_arbitrary_query=none
[2m2025-12-30T20:23:55.287083Z[0m [32m INFO[0m [1minit[0m: [2msurrealdb::core::kvs::ds[0m[2m:[0m Starting kvs store in memory
[2m2025-12-30T20:23:55.288018Z[0m [32m INFO[0m [1minit[0m: [2msurrealdb::core::kvs::ds[0m[2m:[0m Started kvs store in memory
[2m2025-12-30T20:23:55.296350Z[0m [32m INFO[0m [1minit[0m: [2msurreal::dbs[0m[2m:[0m Operation succeeded [3moperation[0m[2m=[0m"check_version" [3mattempts[0m[2m=[0m1
[2m2025-12-30T20:23:55.296359Z[0m [32m INFO[0m [1minit[0m:[1minitialise_defaults[0m: [2msurrealdb::core::kvs::ds[0m[2m:[0m This is a new SurrealDB instance. Initialising default namespace 'main' and database 'main'
[2m2025-12-30T20:23:55.296373Z[0m [35mTRACE[0m [1minit[0m:[1minitialise_defaults[0m:[1mexecute[0m:[1mparse_with_capabilities[0m: [2msurrealdb::core::syn[0m[2m:[0m Parsing SurrealQL query [2m[3minput[0m[2m=[0m"\n\t\t\tDEFINE NAMESPACE $namespace COMMENT 'Default namespace generated by SurrealDB'; \n\t\t\tUSE NS $namespace;\n\t\t\tDEFINE DATABASE $database COMMENT 'Default database generated by SurrealDB'; \n\t\t\tDEFINE CONFIG DEFAULT NAMESPACE $namespace DATABASE $database;\n\t\t" [3mcapabilities[0m[2m=[0mCapabilities { scripting: true, guest_access: true, live_query_notifications: true, allow_funcs: All, deny_funcs: None, allow_net: All, deny_net: None, allow_rpc: All, deny_rpc: None, allow_http: All, deny_http: None, allow_experimental: All, deny_experimental: None, allow_arbitrary_query: All, deny_arbitrary_query: None } [3mlength[0m[2m=[0m256[0m
[2m2025-12-30T20:23:55.296690Z[0m [32m INFO[0m [1minit[0m: [2msurreal::dbs[0m[2m:[0m Operation succeeded [3moperation[0m[2m=[0m"initialise_defaults" [3mattempts[0m[2m=[0m1
[2m2025-12-30T20:23:55.296701Z[0m [32m INFO[0m [1minit[0m: [2msurreal::dbs[0m[2m:[0m Initialising credentials [3muser[0m[2m=[0mroot
[2m2025-12-30T20:23:55.296714Z[0m [32m INFO[0m [1minit[0m:[1minitialise_credentials[0m: [2msurrealdb::core::kvs::ds[0m[2m:[0m Credentials were provided, and no root users were found. The root user 'root' will be created
[2m2025-12-30T20:23:55.309947Z[0m [32m INFO[0m [1minit[0m: [2msurreal::dbs[0m[2m:[0m Operation succeeded [3moperation[0m[2m=[0m"initialise_credentials" [3mattempts[0m[2m=[0m1
[2m2025-12-30T20:23:55.309961Z[0m [35mTRACE[0m [1minit[0m:[1minsert_node[0m: [2msurrealdb::core::kvs::ds[0m[2m:[0m Inserting node in the cluster [3mid[0m[2m=[0m0567fe29-261d-4ff1-88ba-a444704c1ab8
[2m2025-12-30T20:23:55.313576Z[0m [32m INFO[0m [1minit[0m: [2msurreal::dbs[0m[2m:[0m Operation succeeded [3moperation[0m[2m=[0m"Insert node" [3mattempts[0m[2m=[0m1
[2m2025-12-30T20:23:55.313588Z[0m [35mTRACE[0m [1minit[0m:[1mexpire_nodes[0m: [2msurrealdb::core::kvs::ds[0m[2m:[0m Archiving expired nodes in the cluster
[2m2025-12-30T20:23:55.313615Z[0m [32m INFO[0m [1minit[0m: [2msurreal::dbs[0m[2m:[0m Operation succeeded [3moperation[0m[2m=[0m"Expire nodes" [3mattempts[0m[2m=[0m1
[2m2025-12-30T20:23:55.313623Z[0m [35mTRACE[0m [1minit[0m:[1mremove_nodes[0m: [2msurrealdb::core::kvs::ds[0m[2m:[0m Cleaning up archived nodes in the cluster
[2m2025-12-30T20:23:55.313637Z[0m [32m INFO[0m [1minit[0m: [2msurreal::dbs[0m[2m:[0m Operation succeeded [3moperation[0m[2m=[0m"Remove nodes" [3mattempts[0m[2m=[0m1
[2m2025-12-30T20:23:55.313671Z[0m [35mTRACE[0m [2msurrealdb::engine::tasks[0m[2m:[0m Updating node registration information every 3s
[2m2025-12-30T20:23:55.313688Z[0m [35mTRACE[0m [2msurrealdb::engine::tasks[0m[2m:[0m Processing and cleaning archived nodes every 300s
[2m2025-12-30T20:23:55.313690Z[0m [35mTRACE[0m [2msurrealdb::engine::tasks[0m[2m:[0m Processing and archiving inactive nodes every 15s
[2m2025-12-30T20:23:55.313694Z[0m [35mTRACE[0m [2msurrealdb::engine::tasks[0m[2m:[0m Running changefeed garbage collection every 30s
[2m2025-12-30T20:23:55.313696Z[0m [35mTRACE[0m [2msurrealdb::engine::tasks[0m[2m:[0m Running index compaction every 5s
  console.log
    SurrealDB started on port 56419

      at getContainer (surrealdb/setup.ts:62:11)

[2m2025-12-30T20:23:55.313737Z[0m [33m WARN[0m [2msurrealdb_server::ntw[0m[2m:[0m ‚ùåüîíIMPORTANT: GraphQL is a pre-release feature with known security flaws. This is not recommended for production use.üîí‚ùå
[2m2025-12-30T20:23:55.313808Z[0m [32m INFO[0m [2msurrealdb::net[0m[2m:[0m Started web server on 0.0.0.0:8000
[2m2025-12-30T20:23:55.313813Z[0m [32m INFO[0m [2msurrealdb::net[0m[2m:[0m Listening for a system shutdown signal.
[2m2025-12-30T20:23:55.332020Z[0m [34mDEBUG[0m [1mrequest[0m: [2msurrealdb_server::ntw::tracer[0m[2m:[0m Started processing request [2m[3motel.kind[0m[2m=[0m"server" [3mhttp.request.method[0m[2m=[0m"POST" [3murl.path[0m[2m=[0m"/rpc" [3mnetwork.protocol.name[0m[2m=[0m"http" [3mnetwork.protocol.version[0m[2m=[0m"1.1" [3mhttp.request.body.size[0m[2m=[0m"21" [3muser_agent.original[0m[2m=[0m"node" [3motel.name[0m[2m=[0m"POST /rpc" [3mhttp.route[0m[2m=[0m"/rpc" [3mhttp.request.id[0m[2m=[0m"732b1097-d97b-4b51-b625-9f9f3fc529f1" [3mclient.address[0m[2m=[0m"192.168.65.1"[0m
[2m2025-12-30T20:23:55.332127Z[0m [34mDEBUG[0m [1mrequest[0m: [2msurrealdb_server::ntw::tracer[0m[2m:[0m Finished processing request [2m[3motel.kind[0m[2m=[0m"server" [3mhttp.request.method[0m[2m=[0m"POST" [3murl.path[0m[2m=[0m"/rpc" [3mnetwork.protocol.name[0m[2m=[0m"http" [3mnetwork.protocol.version[0m[2m=[0m"1.1" [3mhttp.request.body.size[0m[2m=[0m"21" [3muser_agent.original[0m[2m=[0m"node" [3motel.name[0m[2m=[0m"POST /rpc" [3mhttp.route[0m[2m=[0m"/rpc" [3mhttp.request.id[0m[2m=[0m"732b1097-d97b-4b51-b625-9f9f3fc529f1" [3mclient.address[0m[2m=[0m"192.168.65.1" [3mhttp.response.status_code[0m[2m=[0m200 [3mhttp.latency.ms[0m[2m=[0m0[0m
[2m2025-12-30T20:23:55.340753Z[0m [34mDEBUG[0m [1mrequest[0m: [2msurrealdb_server::ntw::tracer[0m[2m:[0m Started processing request [2m[3motel.kind[0m[2m=[0m"server" [3mhttp.request.method[0m[2m=[0m"POST" [3murl.path[0m[2m=[0m"/rpc" [3mnetwork.protocol.name[0m[2m=[0m"http" [3mnetwork.protocol.version[0m[2m=[0m"1.1" [3mhttp.request.body.size[0m[2m=[0m"59" [3muser_agent.original[0m[2m=[0m"node" [3motel.name[0m[2m=[0m"POST /rpc" [3mhttp.route[0m[2m=[0m"/rpc" [3mhttp.request.id[0m[2m=[0m"2e0d74f6-48ab-4f8d-b64d-08686c2ae526" [3mclient.address[0m[2m=[0m"192.168.65.1"[0m
[2m2025-12-30T20:23:55.356711Z[0m [35mTRACE[0m [1mrequest[0m: [2msurrealdb_core::iam::signin[0m[2m:[0m Signing in as root [2m[3motel.kind[0m[2m=[0m"server" [3mhttp.request.method[0m[2m=[0m"POST" [3murl.path[0m[2m=[0m"/rpc" [3mnetwork.protocol.name[0m[2m=[0m"http" [3mnetwork.protocol.version[0m[2m=[0m"1.1" [3mhttp.request.body.size[0m[2m=[0m"59" [3muser_agent.original[0m[2m=[0m"node" [3motel.name[0m[2m=[0m"POST /rpc" [3mhttp.route[0m[2m=[0m"/rpc" [3mhttp.request.id[0m[2m=[0m"2e0d74f6-48ab-4f8d-b64d-08686c2ae526" [3mclient.address[0m[2m=[0m"192.168.65.1"[0m
[2m2025-12-30T20:23:55.356758Z[0m [34mDEBUG[0m [1mrequest[0m: [2msurrealdb_server::ntw::tracer[0m[2m:[0m Finished processing request [2m[3motel.kind[0m[2m=[0m"server" [3mhttp.request.method[0m[2m=[0m"POST" [3murl.path[0m[2m=[0m"/rpc" [3mnetwork.protocol.name[0m[2m=[0m"http" [3mnetwork.protocol.version[0m[2m=[0m"1.1" [3mhttp.request.body.size[0m[2m=[0m"59" [3muser_agent.original[0m[2m=[0m"node" [3motel.name[0m[2m=[0m"POST /rpc" [3mhttp.route[0m[2m=[0m"/rpc" [3mhttp.request.id[0m[2m=[0m"2e0d74f6-48ab-4f8d-b64d-08686c2ae526" [3mclient.address[0m[2m=[0m"192.168.65.1" [3mhttp.response.status_code[0m[2m=[0m200 [3mhttp.latency.ms[0m[2m=[0m16[0m
[2m2025-12-30T20:23:55.359637Z[0m [34mDEBUG[0m [1mrequest[0m: [2msurrealdb_server::ntw::tracer[0m[2m:[0m Started processing request [2m[3motel.kind[0m[2m=[0m"server" [3mhttp.request.method[0m[2m=[0m"POST" [3murl.path[0m[2m=[0m"/rpc" [3mnetwork.protocol.name[0m[2m=[0m"http" [3mnetwork.protocol.version[0m[2m=[0m"1.1" [3mhttp.request.body.size[0m[2m=[0m"70" [3muser_agent.original[0m[2m=[0m"node" [3motel.name[0m[2m=[0m"POST /rpc" [3mhttp.route[0m[2m=[0m"/rpc" [3mhttp.request.id[0m[2m=[0m"12bcb666-8b23-4ad5-9277-04053cb6ee61" [3mclient.address[0m[2m=[0m"192.168.65.1"[0m
[2m2025-12-30T20:23:55.359671Z[0m [35mTRACE[0m [1mrequest[0m: [2msurrealdb_core::iam::verify[0m[2m:[0m Attempting token authentication [2m[3motel.kind[0m[2m=[0m"server" [3mhttp.request.method[0m[2m=[0m"POST" [3murl.path[0m[2m=[0m"/rpc" [3mnetwork.protocol.name[0m[2m=[0m"http" [3mnetwork.protocol.version[0m[2m=[0m"1.1" [3mhttp.request.body.size[0m[2m=[0m"70" [3muser_agent.original[0m[2m=[0m"node" [3motel.name[0m[2m=[0m"POST /rpc" [3mhttp.route[0m[2m=[0m"/rpc" [3mhttp.request.id[0m[2m=[0m"12bcb666-8b23-4ad5-9277-04053cb6ee61" [3mclient.address[0m[2m=[0m"192.168.65.1"[0m
[2m2025-12-30T20:23:55.359696Z[0m [35mTRACE[0m [1mrequest[0m: [2msurrealdb_core::iam::verify[0m[2m:[0m Authenticating to root level with user `root` [2m[3motel.kind[0m[2m=[0m"server" [3mhttp.request.method[0m[2m=[0m"POST" [3murl.path[0m[2m=[0m"/rpc" [3mnetwork.protocol.name[0m[2m=[0m"http" [3mnetwork.protocol.version[0m[2m=[0m"1.1" [3mhttp.request.body.size[0m[2m=[0m"70" [3muser_agent.original[0m[2m=[0m"node" [3motel.name[0m[2m=[0m"POST /rpc" [3mhttp.route[0m[2m=[0m"/rpc" [3mhttp.request.id[0m[2m=[0m"12bcb666-8b23-4ad5-9277-04053cb6ee61" [3mclient.address[0m[2m=[0m"192.168.65.1"[0m
[2m2025-12-30T20:23:55.359757Z[0m [34mDEBUG[0m [1mrequest[0m: [2msurrealdb_core::iam::verify[0m[2m:[0m Authenticated to root level with user `root` using token [2m[3motel.kind[0m[2m=[0m"server" [3mhttp.request.method[0m[2m=[0m"POST" [3murl.path[0m[2m=[0m"/rpc" [3mnetwork.protocol.name[0m[2m=[0m"http" [3mnetwork.protocol.version[0m[2m=[0m"1.1" [3mhttp.request.body.size[0m[2m=[0m"70" [3muser_agent.original[0m[2m=[0m"node" [3motel.name[0m[2m=[0m"POST /rpc" [3mhttp.route[0m[2m=[0m"/rpc" [3mhttp.request.id[0m[2m=[0m"12bcb666-8b23-4ad5-9277-04053cb6ee61" [3mclient.address[0m[2m=[0m"192.168.65.1"[0m
[2m2025-12-30T20:23:55.359808Z[0m [35mTRACE[0m [1mrequest[0m:[1mexecute[0m:[1mparse_with_capabilities[0m: [2msurrealdb::core::syn[0m[2m:[0m Parsing SurrealQL query [2m[3motel.kind[0m[2m=[0m"server" [3mhttp.request.method[0m[2m=[0m"POST" [3murl.path[0m[2m=[0m"/rpc" [3mnetwork.protocol.name[0m[2m=[0m"http" [3mnetwork.protocol.version[0m[2m=[0m"1.1" [3mhttp.request.body.size[0m[2m=[0m"70" [3muser_agent.original[0m[2m=[0m"node" [3motel.name[0m[2m=[0m"POST /rpc" [3mhttp.route[0m[2m=[0m"/rpc" [3mhttp.request.id[0m[2m=[0m"12bcb666-8b23-4ad5-9277-04053cb6ee61" [3mclient.address[0m[2m=[0m"192.168.65.1"[0m [2m[3minput[0m[2m=[0m"REMOVE DATABASE test_db;" [3mcapabilities[0m[2m=[0mCapabilities { scripting: true, guest_access: true, live_query_notifications: true, allow_funcs: All, deny_funcs: None, allow_net: All, deny_net: None, allow_rpc: All, deny_rpc: None, allow_http: All, deny_http: None, allow_experimental: All, deny_experimental: None, allow_arbitrary_query: All, deny_arbitrary_query: None } [3mlength[0m[2m=[0m24[0m
[2m2025-12-30T20:23:55.359902Z[0m [34mDEBUG[0m [1mrequest[0m: [2msurrealdb_server::ntw::tracer[0m[2m:[0m Finished processing request [2m[3motel.kind[0m[2m=[0m"server" [3mhttp.request.method[0m[2m=[0m"POST" [3murl.path[0m[2m=[0m"/rpc" [3mnetwork.protocol.name[0m[2m=[0m"http" [3mnetwork.protocol.version[0m[2m=[0m"1.1" [3mhttp.request.body.size[0m[2m=[0m"70" [3muser_agent.original[0m[2m=[0m"node" [3motel.name[0m[2m=[0m"POST /rpc" [3mhttp.route[0m[2m=[0m"/rpc" [3mhttp.request.id[0m[2m=[0m"12bcb666-8b23-4ad5-9277-04053cb6ee61" [3mclient.address[0m[2m=[0m"192.168.65.1" [3mhttp.response.status_code[0m[2m=[0m200 [3mhttp.latency.ms[0m[2m=[0m0[0m
[2m2025-12-30T20:23:55.361709Z[0m [34mDEBUG[0m [1mrequest[0m: [2msurrealdb_server::ntw::tracer[0m[2m:[0m Started processing request [2m[3motel.kind[0m[2m=[0m"server" [3mhttp.request.method[0m[2m=[0m"POST" [3murl.path[0m[2m=[0m"/rpc" [3mnetwork.protocol.name[0m[2m=[0m"http" [3mnetwork.protocol.version[0m[2m=[0m"1.1" [3mhttp.request.body.size[0m[2m=[0m"70" [3muser_agent.original[0m[2m=[0m"node" [3motel.name[0m[2m=[0m"POST /rpc" [3mhttp.route[0m[2m=[0m"/rpc" [3mhttp.request.id[0m[2m=[0m"64c89cac-aa6a-449a-9cbd-6eccb420531b" [3mclient.address[0m[2m=[0m"192.168.65.1"[0m
[2m2025-12-30T20:23:55.361722Z[0m [35mTRACE[0m [1mrequest[0m: [2msurrealdb_core::iam::verify[0m[2m:[0m Attempting token authentication [2m[3motel.kind[0m[2m=[0m"server" [3mhttp.request.method[0m[2m=[0m"POST" [3murl.path[0m[2m=[0m"/rpc" [3mnetwork.protocol.name[0m[2m=[0m"http" [3mnetwork.protocol.version[0m[2m=[0m"1.1" [3mhttp.request.body.size[0m[2m=[0m"70" [3muser_agent.original[0m[2m=[0m"node" [3motel.name[0m[2m=[0m"POST /rpc" [3mhttp.route[0m[2m=[0m"/rpc" [3mhttp.request.id[0m[2m=[0m"64c89cac-aa6a-449a-9cbd-6eccb420531b" [3mclient.address[0m[2m=[0m"192.168.65.1"[0m
[2m2025-12-30T20:23:55.361735Z[0m [35mTRACE[0m [1mrequest[0m: [2msurrealdb_core::iam::verify[0m[2m:[0m Authenticating to root level with user `root` [2m[3motel.kind[0m[2m=[0m"server" [3mhttp.request.method[0m[2m=[0m"POST" [3murl.path[0m[2m=[0m"/rpc" [3mnetwork.protocol.name[0m[2m=[0m"http" [3mnetwork.protocol.version[0m[2m=[0m"1.1" [3mhttp.request.body.size[0m[2m=[0m"70" [3muser_agent.original[0m[2m=[0m"node" [3motel.name[0m[2m=[0m"POST /rpc" [3mhttp.route[0m[2m=[0m"/rpc" [3mhttp.request.id[0m[2m=[0m"64c89cac-aa6a-449a-9cbd-6eccb420531b" [3mclient.address[0m[2m=[0m"192.168.65.1"[0m
[2m2025-12-30T20:23:55.361761Z[0m [34mDEBUG[0m [1mrequest[0m: [2msurrealdb_core::iam::verify[0m[2m:[0m Authenticated to root level with user `root` using token [2m[3motel.kind[0m[2m=[0m"server" [3mhttp.request.method[0m[2m=[0m"POST" [3murl.path[0m[2m=[0m"/rpc" [3mnetwork.protocol.name[0m[2m=[0m"http" [3mnetwork.protocol.version[0m[2m=[0m"1.1" [3mhttp.request.body.size[0m[2m=[0m"70" [3muser_agent.original[0m[2m=[0m"node" [3motel.name[0m[2m=[0m"POST /rpc" [3mhttp.route[0m[2m=[0m"/rpc" [3mhttp.request.id[0m[2m=[0m"64c89cac-aa6a-449a-9cbd-6eccb420531b" [3mclient.address[0m[2m=[0m"192.168.65.1"[0m
[2m2025-12-30T20:23:55.361796Z[0m [35mTRACE[0m [1mrequest[0m:[1mexecute[0m:[1mparse_with_capabilities[0m: [2msurrealdb::core::syn[0m[2m:[0m Parsing SurrealQL query [2m[3motel.kind[0m[2m=[0m"server" [3mhttp.request.method[0m[2m=[0m"POST" [3murl.path[0m[2m=[0m"/rpc" [3mnetwork.protocol.name[0m[2m=[0m"http" [3mnetwork.protocol.version[0m[2m=[0m"1.1" [3mhttp.request.body.size[0m[2m=[0m"70" [3muser_agent.original[0m[2m=[0m"node" [3motel.name[0m[2m=[0m"POST /rpc" [3mhttp.route[0m[2m=[0m"/rpc" [3mhttp.request.id[0m[2m=[0m"64c89cac-aa6a-449a-9cbd-6eccb420531b" [3mclient.address[0m[2m=[0m"192.168.65.1"[0m [2m[3minput[0m[2m=[0m"DEFINE DATABASE test_db;" [3mcapabilities[0m[2m=[0mCapabilities { scripting: true, guest_access: true, live_query_notifications: true, allow_funcs: All, deny_funcs: None, allow_net: All, deny_net: None, allow_rpc: All, deny_rpc: None, allow_http: All, deny_http: None, allow_experimental: All, deny_experimental: None, allow_arbitrary_query: All, deny_arbitrary_query: None } [3mlength[0m[2m=[0m24[0m
[2m2025-12-30T20:23:55.361983Z[0m [34mDEBUG[0m [1mrequest[0m: [2msurrealdb_server::ntw::tracer[0m[2m:[0m Finished processing request [2m[3motel.kind[0m[2m=[0m"server" [3mhttp.request.method[0m[2m=[0m"POST" [3murl.path[0m[2m=[0m"/rpc" [3mnetwork.protocol.name[0m[2m=[0m"http" [3mnetwork.protocol.version[0m[2m=[0m"1.1" [3mhttp.request.body.size[0m[2m=[0m"70" [3muser_agent.original[0m[2m=[0m"node" [3motel.name[0m[2m=[0m"POST /rpc" [3mhttp.route[0m[2m=[0m"/rpc" [3mhttp.request.id[0m[2m=[0m"64c89cac-aa6a-449a-9cbd-6eccb420531b" [3mclient.address[0m[2m=[0m"192.168.65.1" [3mhttp.response.status_code[0m[2m=[0m200 [3mhttp.latency.ms[0m[2m=[0m0[0m
  console.log
    Loading generated schema from: /Users/khadim/dev/spooky/tests/.spooky/schema.gen.surql

      at createTestDb (surrealdb/setup.ts:100:13)

[2m2025-12-30T20:23:55.365875Z[0m [34mDEBUG[0m [1mrequest[0m: [2msurrealdb_server::ntw::tracer[0m[2m:[0m Started processing request [2m[3motel.kind[0m[2m=[0m"server" [3mhttp.request.method[0m[2m=[0m"POST" [3murl.path[0m[2m=[0m"/rpc" [3mnetwork.protocol.name[0m[2m=[0m"http" [3mnetwork.protocol.version[0m[2m=[0m"1.1" [3mhttp.request.body.size[0m[2m=[0m"25408" [3muser_agent.original[0m[2m=[0m"node" [3motel.name[0m[2m=[0m"POST /rpc" [3mhttp.route[0m[2m=[0m"/rpc" [3mhttp.request.id[0m[2m=[0m"1d9da004-dd48-40b1-b422-f5b80fac856c" [3mclient.address[0m[2m=[0m"192.168.65.1"[0m
[2m2025-12-30T20:23:55.365893Z[0m [35mTRACE[0m [1mrequest[0m: [2msurrealdb_core::iam::verify[0m[2m:[0m Attempting token authentication [2m[3motel.kind[0m[2m=[0m"server" [3mhttp.request.method[0m[2m=[0m"POST" [3murl.path[0m[2m=[0m"/rpc" [3mnetwork.protocol.name[0m[2m=[0m"http" [3mnetwork.protocol.version[0m[2m=[0m"1.1" [3mhttp.request.body.size[0m[2m=[0m"25408" [3muser_agent.original[0m[2m=[0m"node" [3motel.name[0m[2m=[0m"POST /rpc" [3mhttp.route[0m[2m=[0m"/rpc" [3mhttp.request.id[0m[2m=[0m"1d9da004-dd48-40b1-b422-f5b80fac856c" [3mclient.address[0m[2m=[0m"192.168.65.1"[0m
[2m2025-12-30T20:23:55.365906Z[0m [35mTRACE[0m [1mrequest[0m: [2msurrealdb_core::iam::verify[0m[2m:[0m Authenticating to root level with user `root` [2m[3motel.kind[0m[2m=[0m"server" [3mhttp.request.method[0m[2m=[0m"POST" [3murl.path[0m[2m=[0m"/rpc" [3mnetwork.protocol.name[0m[2m=[0m"http" [3mnetwork.protocol.version[0m[2m=[0m"1.1" [3mhttp.request.body.size[0m[2m=[0m"25408" [3muser_agent.original[0m[2m=[0m"node" [3motel.name[0m[2m=[0m"POST /rpc" [3mhttp.route[0m[2m=[0m"/rpc" [3mhttp.request.id[0m[2m=[0m"1d9da004-dd48-40b1-b422-f5b80fac856c" [3mclient.address[0m[2m=[0m"192.168.65.1"[0m
[2m2025-12-30T20:23:55.365940Z[0m [34mDEBUG[0m [1mrequest[0m: [2msurrealdb_core::iam::verify[0m[2m:[0m Authenticated to root level with user `root` using token [2m[3motel.kind[0m[2m=[0m"server" [3mhttp.request.method[0m[2m=[0m"POST" [3murl.path[0m[2m=[0m"/rpc" [3mnetwork.protocol.name[0m[2m=[0m"http" [3mnetwork.protocol.version[0m[2m=[0m"1.1" [3mhttp.request.body.size[0m[2m=[0m"25408" [3muser_agent.original[0m[2m=[0m"node" [3motel.name[0m[2m=[0m"POST /rpc" [3mhttp.route[0m[2m=[0m"/rpc" [3mhttp.request.id[0m[2m=[0m"1d9da004-dd48-40b1-b422-f5b80fac856c" [3mclient.address[0m[2m=[0m"192.168.65.1"[0m
[2m2025-12-30T20:23:55.366073Z[0m [35mTRACE[0m [1mrequest[0m:[1mexecute[0m:[1mparse_with_capabilities[0m: [2msurrealdb::core::syn[0m[2m:[0m Parsing SurrealQL query [2m[3motel.kind[0m[2m=[0m"server" [3mhttp.request.method[0m[2m=[0m"POST" [3murl.path[0m[2m=[0m"/rpc" [3mnetwork.protocol.name[0m[2m=[0m"http" [3mnetwork.protocol.version[0m[2m=[0m"1.1" [3mhttp.request.body.size[0m[2m=[0m"25408" [3muser_agent.original[0m[2m=[0m"node" [3motel.name[0m[2m=[0m"POST /rpc" [3mhttp.route[0m[2m=[0m"/rpc" [3mhttp.request.id[0m[2m=[0m"1d9da004-dd48-40b1-b422-f5b80fac856c" [3mclient.address[0m[2m=[0m"192.168.65.1"[0m [2m[3minput[0m[2m=[0m"-- This file is auto-generated. Do not edit manually.\n-- Generated by syncgen - any changes will be overwritten.\n\n\n-- ==================================================\n-- SURREALISM MODULES\n-- ==================================================\n\n-- Define bucket for module files\nDEFINE BUCKET IF NOT EXISTS modules BACKEND \"file:///modules\";\n\n-- Define the XOR module\nDEFINE MODULE mod::xor AS f\"modules:/xor_module.surli\";\n\n-- Define the DBSP module\nDEFINE MODULE mod::dbsp AS f\"modules:/dbsp_module.surli\";\n\n-- ##################################################################\n-- SCOPES & AUTHENTICATION\n-- ##################################################################\nDEFINE ACCESS account ON DATABASE TYPE RECORD\nSIGNUP {\n  IF string::len($username) <= 3 { THROW \"Username must be longer than 3 characters\" };\n  IF string::len($password) == 0 { THROW \"Password cannot be empty\" };\n\n  LET $existing = (SELECT value id FROM user WHERE username = $username LIMIT 1)[0];\n  IF $existing != NONE { THROW \"Username '\" + <string>$username + \"' is already taken\" };\n\n  LET $u = CREATE user SET username = $username, password = crypto::argon2::generate($password);\n  RETURN $u;\n}\nSIGNIN ( SELECT * FROM user WHERE username = $username AND crypto::argon2::compare(password, $password) )\nDURATION FOR TOKEN 365d, FOR SESSION 365d\n;\n\nDEFINE FUNCTION fn::polyfill::createAccount($username: string, $password: string) {\n  IF string::len($username) <= 3 { THROW \"Username must be longer than 3 characters\" };\n  IF string::len($password) == 0 { THROW \"Password cannot be empty\" };\n\n  LET $existing = (SELECT value id FROM user WHERE username = $username LIMIT 1)[0];\n  IF $existing != NONE { THROW \"Username '\" + <string>$username + \"' is already taken\" };\n\n  LET $u = CREATE user SET username = $username, password = crypto::argon2::generate($password);\n  RETURN $u;\n};\n\n-- ##################################################################\n-- USER TABLE\n-- ##################################################################\n\nDEFINE TABLE user SCHEMAFULL\nPERMISSIONS\n  FOR update, delete WHERE $access = \"account\" AND id = $auth.id\n  FOR create, select WHERE true;\n\nDEFINE FIELD username ON TABLE user TYPE string\nASSERT $value != NONE AND string::len($value) > 3\nPERMISSIONS\n    FOR select WHERE true\n    FOR create WHERE true\n    FOR update WHERE $access = \"account\" AND id = $auth.id;\n    \nDEFINE INDEX unique_username ON TABLE user FIELDS username UNIQUE;\n\nDEFINE FIELD password ON TABLE user TYPE string\nASSERT $value != NONE AND string::len($value) > 0\nPERMISSIONS\n    FOR select WHERE false\n    FOR create WHERE true\n    FOR update WHERE $access = \"account\" AND id = $auth.id;\n\nDEFINE FIELD created_at ON TABLE user TYPE datetime\nVALUE time::now()\nPERMISSIONS\n    FOR select WHERE false\n    FOR create WHERE true\n    FOR update WHERE $access = \"account\" AND id = $auth.id;\n\n-- ##################################################################\n-- THREAD TABLE\n-- ##################################################################\n\nDEFINE TABLE thread SCHEMAFULL\n  PERMISSIONS\n    FOR select WHERE true\n    FOR update, delete, create WHERE $access = \"account\" AND author.id = $auth.id\n;\n\n\nDEFINE FIELD title ON TABLE thread TYPE string\n    ASSERT $value != NONE AND string::len($value) > 0 AND string::len($value) <= 200;\n\nDEFINE FIELD content ON TABLE thread TYPE string\n    ASSERT $value != NONE AND string::len($value) > 0;\n\nDEFINE FIELD author ON TABLE thread TYPE record<user>; -- @parent\n\nDEFINE FIELD created_at ON TABLE thread TYPE datetime\n    VALUE time::now();\n\nDEFINE FIELD active ON TABLE thread TYPE bool VALUE $value OR false;\n\n-- ##################################################################\n-- COMMENT TABLE\n-- ##################################################################\n\nDEFINE TABLE comment SCHEMAFULL\n  PERMISSIONS\n    FOR select WHERE true\n    FOR update, delete, create WHERE $access = \"account\" AND author.id = $auth.id\n;\n\nDEFINE FIELD thread ON TABLE comment TYPE record<thread>; -- @parent\n\nDEFINE FIELD content ON TABLE comment TYPE string\n    ASSERT $value != NONE AND string::len($value) > 0;\n\nDEFINE FIELD author ON TABLE comment TYPE record<user>;\n\nDEFINE FIELD created_at ON TABLE comment TYPE datetime\n    VALUE time::now();\n\n-- ##################################################################\n-- RELATION TABLES\n-- ##################################################################\n\nDEFINE TABLE commented_on SCHEMAFULL TYPE RELATION\n  FROM comment TO thread\n  PERMISSIONS FOR select WHERE true;\n\nDEFINE EVENT comment_created ON TABLE comment WHEN $event = \"CREATE\" THEN\n  RELATE ($after.id)->commented_on->($after.thread)\n;\n-- ==================================================\n-- SPOOKY INCANTATION\n-- The Registry of active Live Queries (Incantations).\n-- ==================================================\n\nDEFINE TABLE _spooky_incantation SCHEMALESS\n    PERMISSIONS FOR select, create, update WHERE $_spooky_client_id = $clientId;\n\n-- The raw query string (for re-hydration/debugging)\n-- The raw query string (for re-hydration/debugging)\nDEFINE FIELD surrealQL ON TABLE _spooky_incantation TYPE option<string>\n    PERMISSIONS FOR select, create, update WHERE $_spooky_client_id = $clientId;\n\n-- The raw query string (for re-hydration/debugging)\nDEFINE FIELD clientId ON TABLE _spooky_incantation TYPE option<string>\n    PERMISSIONS FOR select, create, update WHERE $_spooky_client_id = $clientId;\n\n-- The current XOR sum of all results in this query\nDEFINE FIELD hash ON TABLE _spooky_incantation TYPE option<string>\n    PERMISSIONS FOR select, create, update WHERE $_spooky_client_id = $clientId;\n\n-- The Radix Tree of Result IDs for efficient sync\nDEFINE FIELD tree ON TABLE _spooky_incantation TYPE any\n    PERMISSIONS FOR select, create, update WHERE $_spooky_client_id = $clientId;\n\n-- For garbage collection (Heartbeat)\nDEFINE FIELD lastActiveAt ON TABLE _spooky_incantation TYPE datetime DEFAULT time::now()\n    PERMISSIONS FOR select, create, update WHERE $_spooky_client_id = $clientId;\n\n-- How long this Incantation stays alive without activity\nDEFINE FIELD ttl ON TABLE _spooky_incantation TYPE duration\n    PERMISSIONS FOR select, create, update WHERE $_spooky_client_id = $clientId;\n\n\n-- Remote-only meta tables (not synced to client)\nDEFINE TABLE _spooky_module_state SCHEMALESS PERMISSIONS FULL;\n\n-- Unregister from DBSP on deletion\nDEFINE EVENT _spooky_dbsp_cleanup ON TABLE _spooky_incantation WHEN $event = \"DELETE\" THEN {\n    let $result = mod::dbsp::unregister_query(<string>$before.id);\n};\n\n-- Register with DBSP on creation or update\n-- Register with DBSP on creation or update\nDEFINE EVENT _spooky_dbsp_register ON TABLE _spooky_incantation WHEN $event = \"CREATE\" OR ($event = \"UPDATE\" AND ($after.surrealQL != $before.surrealQL OR $after.params != $before.params)) THEN {\n    LET $res = mod::dbsp::register_view(<string>$after.id, $after.surrealQL, <string>($after.params OR {}));\n    -- Update the incantation with the initial hash computed by DBSP\n    IF $res.result_hash != NONE THEN {\n        UPDATE _spooky_incantation SET hash = $res.result_hash, tree = $res.tree WHERE id = $after.id; \n    } END;\n};\n-- ==================================================\n-- FUNCTION: CALCULATE VIEW HASH\n-- Usage: fn::spooky::view_hash(thread:123, ['comments'])\n-- ==================================================\nDEFINE FUNCTION fn::spooky::view_hash($rid: record, $paths: array<string>) {\n    LET $shadow = (SELECT * FROM ONLY _spooky_data_hash WHERE recordId = $rid);\n    IF $shadow.recordId == NONE { RETURN crypto::blake3(\"\"); };\n\n    -- 1. Start with the Intrinsic Hash\n    LET $parts = [$shadow.intrinsicHash];\n\n    -- 2. Collect requested Composition Hashes (if they exist)\n    -- We use a subquery to map the $paths array to values safely\n    LET $extras = (\n        SELECT VALUE $shadow.compositionHash[$this] \n        FROM $paths \n        WHERE $shadow.compositionHash[$this] != NONE\n    );\n\n    -- 3. Combine and Aggregate\n    LET $all_parts = array::concat($parts, $extras);\n    \n    RETURN mod::xor::blake3_xor_multi($all_parts);\n};\n\n-- ==================================================\n-- FUNCTION: REGISTER INCANTATION (With Sorting)\n-- Usage: fn::incantation::register({ ... sort_field: 'created_at' ... })\n-- ==================================================\nDEFINE FUNCTION fn::incantation::register($config: object) {\n    -- UNPACK CONFIG\n    LET $id         = $config.id;\n    LET $client_id   = $config.client_id;\n    LET $items      = $config.items;\n    LET $paths      = $config.paths;\n    LET $table      = $config.table;\n    LET $filter     = $config.filter;\n    LET $query      = $config.query; -- Optional DBSP Plan (SQL String)\n    \n    -- Sorting Params (Default to created_at if missing)\n    LET $sort_field = $config.sort_field OR 'created_at';\n    LET $tree_init = {}; \n    \n    -- 1. CALCULATE AGGREGATE HASH\n    LET $hashes = (\n        SELECT VALUE fn::spooky::view_hash(id, $paths) \n        FROM $items\n    );\n    LET $query_hash = mod::xor::blake3_xor_multi($hashes);\n\n    -- 2. UPDATE INCANTATION REGISTRY\n    -- Use String Cast for ID to avoid type::thing issues during schema load\n    LET $rid_str = \"_spooky_incantation:\" + $id;\n    LET $rid = <record>$rid_str;\n    \n    INSERT INTO _spooky_incantation {\n        id:           $rid,\n        hash:         $query_hash,\n        clientId:     $client_id,\n        surrealQL:    $query,\n        tree:         <object>{},\n        lastActiveAt: time::now(),\n        ttl:          1h\n    };\n\n\n\n    -- 5. REGISTER WITH DBSP (If plan provided)\n    IF $query != NONE THEN {\n        LET $state = fn::dbsp::get_state();\n        LET $dbsp_res = mod::dbsp::register_query($id, $query, $state);\n        fn::dbsp::save_state($dbsp_res.new_state);\n        \n        LET $init_res = $dbsp_res.result;\n        IF $init_res != NONE THEN {\n            -- Update using the explicit ID\n            UPDATE $rid SET hash = $init_res.hash, tree = $init_res.tree;\n        } END;\n        \n        -- DEBUG: Return the entire result to inspect state\n        RETURN $dbsp_res;\n    } END;\n\n    RETURN $query_hash;\n};\n\nDEFINE FUNCTION fn::incantation::heartbeat($id: record) {\n    UPDATE $id SET lastActiveAt = time::now();\n};\n-- ==================================================\n-- AUTO-GENERATED SPOOKY EVENTS\n-- ==================================================\n\n-- Meta Table: _spooky_data_hash Mutation\n-- Automatically recalculates TotalHash when IntrinsicHash or CompositionHash changes\nDEFINE EVENT OVERWRITE _spooky_data_hash_mutation ON TABLE _spooky_data_hash\nWHEN $before != $after AND $event != \"DELETE\"\nTHEN {\n    LET $new_total = mod::xor::blake3_xor($after.intrinsicHash, $after.compositionHash._xor);\n    IF $new_total != $after.totalHash THEN {\n        UPDATE $after.id SET totalHash = $new_total;\n    } END;\n};\n\nDEFINE FIELD _spooky_touch ON TABLE comment TYPE any PERMISSIONS FOR select, create, update WHERE false;\n\n-- Table: comment Cascade Down (Reference Propagation)\n-- Table: comment Mutation\nDEFINE EVENT OVERWRITE _spooky_comment_mutation ON TABLE comment\nWHEN $before != $after AND $event != \"DELETE\"\nTHEN {\n    LET $xor_intrinsic = crypto::blake3(\"\");\n    LET $xor_composition = crypto::blake3(\"\");\n    LET $empty_hash = crypto::blake3(\"\");\n    LET $new_composition = {};\n    LET $ref_hash_author = IF $after.author != NONE THEN (SELECT totalHash FROM <record>(\"_spooky_data_hash:\" + crypto::blake3(<string>$after.author)))[0].totalHash ELSE crypto::blake3(\"\") END;\n    LET $ref_hash_author = IF $ref_hash_author != NONE THEN $ref_hash_author ELSE crypto::blake3(\"\") END;\n    LET $xor_composition = mod::xor::blake3_xor($xor_composition, $ref_hash_author);\n    LET $h_content = crypto::blake3(<string>$after.content OR \"\");\n    LET $xor_intrinsic = mod::xor::blake3_xor($xor_intrinsic, $h_content);\n    LET $record_id = $before.id OR $after.id;\n    LET $old_hash_data = (SELECT * FROM <record>(\"_spooky_data_hash:\" + crypto::blake3(<string>$record_id)))[0];\n    LET $new_composition = {\n        author: $ref_hash_author,\n        _xor: $xor_composition,\n    };\n\n    LET $new_total_calculated = mod::xor::blake3_xor($xor_intrinsic, $xor_composition);\n    LET $plain_after = {\n        id: <string>($after.id OR \"\"),\n        author: <string>($after.author OR \"\"),\n        content: $after.content,\n        created_at: <string>($after.created_at OR \"\"),\n        thread: <string>($after.thread OR \"\"),\n        IntrinsicHash: $new_total_calculated,\n        _hash: $new_total_calculated,\n        totalHash: $new_total_calculated,\n    };\n    LET $dbsp_ok = mod::dbsp::ingest('comment', $event, <string>($after.id OR \"\"), $plain_after);\n    FOR $u IN $dbsp_ok.updates {\n        UPDATE _spooky_incantation SET hash = $u.result_hash, tree = $u.tree WHERE id = $u.query_id;\n    };\n    LET $saved = mod::dbsp::save_state(NONE);\n\n    LET $hash_id = <record>(\"_spooky_data_hash:\" + crypto::blake3(<string>$after.id));\n    UPSERT $hash_id CONTENT {\n        recordId: $after.id,\n        intrinsicHash: $xor_intrinsic,\n        compositionHash: $new_composition,\n        totalHash: NONE -- Placeholder, will be recalculated by event\n    };\n\n    LET $new_total = mod::xor::blake3_xor($xor_intrinsic, $xor_composition);\n    LET $old_total = IF $old_hash_data.recordId != NONE THEN $old_hash_data.totalHash ELSE $new_total END;\n    LET $old_total_for_delta = IF $old_hash_data.recordId != NONE THEN $old_hash_data.totalHash ELSE crypto::blake3(\"\") END;\n    -- BUBBLE UP to Parent (thread)\n    IF $before.thread = $after.thread THEN {\n        LET $delta = mod::xor::blake3_xor($old_total_for_delta, $new_total_calculated);\n        UPDATE _spooky_data_hash SET\n            compositionHash.comment = mod::xor::blake3_xor((compositionHash.comment OR $empty_hash), $delta),\n            compositionHash._xor = mod::xor::blake3_xor(compositionHash._xor, $delta)\n        WHERE id = <record>(\"_spooky_data_hash:\" + crypto::blake3(<string>$after.thread));\n    } ELSE {\n        UPDATE _spooky_data_hash SET\n            compositionHash.comment = mod::xor::blake3_xor((compositionHash.comment OR $empty_hash), $old_total_for_delta),\n            compositionHash._xor = mod::xor::blake3_xor(compositionHash._xor, $old_total_for_delta)\n        WHERE id = <record>(\"_spooky_data_hash:\" + crypto::blake3(<string>$before.thread)) AND id != NONE;\n\n        UPDATE _spooky_data_hash SET\n            compositionHash.comment = mod::xor::blake3_xor((compositionHash.comment OR $empty_hash), $new_total_calculated),\n            compositionHash._xor = mod::xor::blake3_xor(compositionHash._xor, $new_total_calculated)\n        WHERE id = <record>(\"_spooky_data_hash:\" + crypto::blake3(<string>$after.thread)) AND id != NONE;\n    } END;\n\n};\n\n-- Table: comment Deletion\nDEFINE EVENT OVERWRITE _spooky_comment_delete ON TABLE comment\nWHEN $event = \"DELETE\"\nTHEN {\n    LET $empty_hash = crypto::blake3(\"\");\n    LET $plain_before = {\n        id: <string>($before.id OR \"\"),\n        author: <string>($before.author OR \"\"),\n        content: $before.content,\n        created_at: <string>($before.created_at OR \"\"),\n        thread: <string>($before.thread OR \"\"),\n    };\n    LET $dbsp_ok = mod::dbsp::ingest('comment', \"DELETE\", <string>($before.id OR \"\"), $plain_before);\n    FOR $u IN $dbsp_ok.updates {\n        UPDATE _spooky_incantation SET hash = $u.result_hash, tree = $u.tree WHERE id = $u.query_id;\n    };\n    LET $saved = mod::dbsp::save_state(NONE);\n\n    LET $old_hash_data = (SELECT * FROM <record>(\"_spooky_data_hash:\" + crypto::blake3(<string>$before.id)))[0];\n    LET $old_total = $old_hash_data.totalHash;\n\n    -- BUBBLE UP Delete to Parent\n    IF $old_total != NONE AND $before.thread != NONE THEN {\n        UPDATE _spooky_data_hash SET\n            compositionHash.comment = mod::xor::blake3_xor((compositionHash.comment OR $empty_hash), $old_total),\n            compositionHash._xor = mod::xor::blake3_xor(compositionHash._xor, $old_total)\n        WHERE id = <record>(\"_spooky_data_hash:\" + crypto::blake3(<string>$before.thread));\n    } END;\n\n    LET $hash_id = <record>(\"_spooky_data_hash:\" + crypto::blake3(<string>$before.id));\n    DELETE $hash_id;\n};\n\nDEFINE FIELD _spooky_touch ON TABLE thread TYPE any PERMISSIONS FOR select, create, update WHERE false;\n\n-- Table: thread Cascade Down (Reference Propagation)\nDEFINE EVENT _spooky_z_cascade_comment_thread ON TABLE thread\nWHEN $event != \"DELETE\"\nTHEN {\n    UPDATE comment SET _spooky_touch = time::now() WHERE thread = $after.id;\n};\n\n-- Table: thread Mutation\nDEFINE EVENT OVERWRITE _spooky_thread_mutation ON TABLE thread\nWHEN $before != $after AND $event != \"DELETE\"\nTHEN {\n    LET $xor_intrinsic = crypto::blake3(\"\");\n    LET $xor_composition = crypto::blake3(\"\");\n    LET $empty_hash = crypto::blake3(\"\");\n    LET $new_composition = {};\n    LET $h_active = crypto::blake3(<string>$after.active OR \"\");\n    LET $xor_intrinsic = mod::xor::blake3_xor($xor_intrinsic, $h_active);\n    LET $h_content = crypto::blake3(<string>$after.content OR \"\");\n    LET $xor_intrinsic = mod::xor::blake3_xor($xor_intrinsic, $h_content);\n    LET $h_title = crypto::blake3(<string>$after.title OR \"\");\n    LET $xor_intrinsic = mod::xor::blake3_xor($xor_intrinsic, $h_title);\n    LET $record_id = $before.id OR $after.id;\n    LET $old_hash_data = (SELECT * FROM <record>(\"_spooky_data_hash:\" + crypto::blake3(<string>$record_id)))[0];\n    LET $h_comment = IF $old_hash_data.recordId != NONE THEN $old_hash_data.compositionHash.comment ELSE crypto::blake3(\"\") END;\n    LET $xor_composition = mod::xor::blake3_xor($xor_composition, $h_comment);\n    LET $new_composition = {\n        comment: $h_comment,\n        _xor: $xor_composition,\n    };\n\n    LET $new_total_calculated = mod::xor::blake3_xor($xor_intrinsic, $xor_composition);\n    LET $plain_after = {\n        id: <string>($after.id OR \"\"),\n        active: $after.active,\n        author: <string>($after.author OR \"\"),\n        content: $after.content,\n        created_at: <string>($after.created_at OR \"\"),\n        title: $after.title,\n        IntrinsicHash: $new_total_calculated,\n        _hash: $new_total_calculated,\n        totalHash: $new_total_calculated,\n    };\n    LET $dbsp_ok = mod::dbsp::ingest('thread', $event, <string>($after.id OR \"\"), $plain_after);\n    FOR $u IN $dbsp_ok.updates {\n        UPDATE _spooky_incantation SET hash = $u.result_hash, tree = $u.tree WHERE id = $u.query_id;\n    };\n    LET $saved = mod::dbsp::save_state(NONE);\n\n    LET $hash_id = <record>(\"_spooky_data_hash:\" + crypto::blake3(<string>$after.id));\n    UPSERT $hash_id CONTENT {\n        recordId: $after.id,\n        intrinsicHash: $xor_intrinsic,\n        compositionHash: $new_composition,\n        totalHash: NONE -- Placeholder, will be recalculated by event\n    };\n\n    LET $new_total = mod::xor::blake3_xor($xor_intrinsic, $xor_composition);\n    LET $old_total = IF $old_hash_data.recordId != NONE THEN $old_hash_data.totalHash ELSE $new_total END;\n    LET $old_total_for_delta = IF $old_hash_data.recordId != NONE THEN $old_hash_data.totalHash ELSE crypto::blake3(\"\") END;\n    -- BUBBLE UP to Parent (author)\n    IF $before.author = $after.author THEN {\n        LET $delta = mod::xor::blake3_xor($old_total_for_delta, $new_total_calculated);\n        UPDATE _spooky_data_hash SET\n            compositionHash.thread = mod::xor::blake3_xor((compositionHash.thread OR $empty_hash), $delta),\n            compositionHash._xor = mod::xor::blake3_xor(compositionHash._xor, $delta)\n        WHERE id = <record>(\"_spooky_data_hash:\" + crypto::blake3(<string>$after.author));\n    } ELSE {\n        UPDATE _spooky_data_hash SET\n            compositionHash.thread = mod::xor::blake3_xor((compositionHash.thread OR $empty_hash), $old_total_for_delta),\n            compositionHash._xor = mod::xor::blake3_xor(compositionHash._xor, $old_total_for_delta)\n        WHERE id = <record>(\"_spooky_data_hash:\" + crypto::blake3(<string>$before.author)) AND id != NONE;\n\n        UPDATE _spooky_data_hash SET\n            compositionHash.thread = mod::xor::blake3_xor((compositionHash.thread OR $empty_hash), $new_total_calculated),\n            compositionHash._xor = mod::xor::blake3_xor(compositionHash._xor, $new_total_calculated)\n        WHERE id = <record>(\"_spooky_data_hash:\" + crypto::blake3(<string>$after.author)) AND id != NONE;\n    } END;\n\n};\n\n-- Table: thread Deletion\nDEFINE EVENT OVERWRITE _spooky_thread_delete ON TABLE thread\nWHEN $event = \"DELETE\"\nTHEN {\n    LET $empty_hash = crypto::blake3(\"\");\n    LET $plain_before = {\n        id: <string>($before.id OR \"\"),\n        active: $before.active,\n        author: <string>($before.author OR \"\"),\n        content: $before.content,\n        created_at: <string>($before.created_at OR \"\"),\n        title: $before.title,\n    };\n    LET $dbsp_ok = mod::dbsp::ingest('thread', \"DELETE\", <string>($before.id OR \"\"), $plain_before);\n    FOR $u IN $dbsp_ok.updates {\n        UPDATE _spooky_incantation SET hash = $u.result_hash, tree = $u.tree WHERE id = $u.query_id;\n    };\n    LET $saved = mod::dbsp::save_state(NONE);\n\n    LET $old_hash_data = (SELECT * FROM <record>(\"_spooky_data_hash:\" + crypto::blake3(<string>$before.id)))[0];\n    LET $old_total = $old_hash_data.totalHash;\n\n    -- BUBBLE UP Delete to Parent\n    IF $old_total != NONE AND $before.author != NONE THEN {\n        UPDATE _spooky_data_hash SET\n            compositionHash.thread = mod::xor::blake3_xor((compositionHash.thread OR $empty_hash), $old_total),\n            compositionHash._xor = mod::xor::blake3_xor(compositionHash._xor, $old_total)\n        WHERE id = <record>(\"_spooky_data_hash:\" + crypto::blake3(<string>$before.author));\n    } END;\n\n    LET $hash_id = <record>(\"_spooky_data_hash:\" + crypto::blake3(<string>$before.id));\n    DELETE $hash_id;\n};\n\nDEFINE FIELD _spooky_touch ON TABLE user TYPE any PERMISSIONS FOR select, create, update WHERE false;\n\n-- Table: user Cascade Down (Reference Propagation)\nDEFINE EVENT _spooky_z_cascade_comment_author ON TABLE user\nWHEN $event != \"DELETE\"\nTHEN {\n    UPDATE comment SET _spooky_touch = time::now() WHERE author = $after.id;\n};\n\nDEFINE EVENT _spooky_z_cascade_thread_author ON TABLE user\nWHEN $event != \"DELETE\"\nTHEN {\n    UPDATE thread SET _spooky_touch = time::now() WHERE author = $after.id;\n};\n\n-- Table: user Mutation\nDEFINE EVENT OVERWRITE _spooky_user_mutation ON TABLE user\nWHEN $before != $after AND $event != \"DELETE\"\nTHEN {\n    LET $xor_intrinsic = crypto::blake3(\"\");\n    LET $xor_composition = crypto::blake3(\"\");\n    LET $empty_hash = crypto::blake3(\"\");\n    LET $new_composition = {};\n    LET $h_username = crypto::blake3(<string>$after.username OR \"\");\n    LET $xor_intrinsic = mod::xor::blake3_xor($xor_intrinsic, $h_username);\n    LET $record_id = $before.id OR $after.id;\n    LET $old_hash_data = (SELECT * FROM <record>(\"_spooky_data_hash:\" + crypto::blake3(<string>$record_id)))[0];\n    LET $h_thread = IF $old_hash_data.recordId != NONE THEN $old_hash_data.compositionHash.thread ELSE crypto::blake3(\"\") END;\n    LET $xor_composition = mod::xor::blake3_xor($xor_composition, $h_thread);\n    LET $new_composition = {\n        thread: $h_thread,\n        _xor: $xor_composition,\n    };\n\n    LET $new_total_calculated = mod::xor::blake3_xor($xor_intrinsic, $xor_composition);\n    LET $plain_after = {\n        id: <string>($after.id OR \"\"),\n        created_at: <string>($after.created_at OR \"\"),\n        password: $after.password,\n        username: $after.username,\n        IntrinsicHash: $new_total_calculated,\n        _hash: $new_total_calculated,\n        totalHash: $new_total_calculated,\n    };\n    LET $dbsp_ok = mod::dbsp::ingest('user', $event, <string>($after.id OR \"\"), $plain_after);\n    FOR $u IN $dbsp_ok.updates {\n        UPDATE _spooky_incantation SET hash = $u.result_hash, tree = $u.tree WHERE id = $u.query_id;\n    };\n    LET $saved = mod::dbsp::save_state(NONE);\n\n    LET $hash_id = <record>(\"_spooky_data_hash:\" + crypto::blake3(<string>$after.id));\n    UPSERT $hash_id CONTENT {\n        recordId: $after.id,\n        intrinsicHash: $xor_intrinsic,\n        compositionHash: $new_composition,\n        totalHash: NONE -- Placeholder, will be recalculated by event\n    };\n\n    -- ==================================================\n    -- CASCADE DOWN (Disabled for Object Hash for now)\n    -- Logic: {} Change -> Updates Dependent INTRINSIC Hash\n    -- ==================================================\n    -- (Skipped implementation for object hash)\n\n};\n\n-- Table: user Deletion\nDEFINE EVENT OVERWRITE _spooky_user_delete ON TABLE user\nWHEN $event = \"DELETE\"\nTHEN {\n    LET $empty_hash = crypto::blake3(\"\");\n    LET $plain_before = {\n        id: <string>($before.id OR \"\"),\n        created_at: <string>($before.created_at OR \"\"),\n        password: $before.password,\n        username: $before.username,\n    };\n    LET $dbsp_ok = mod::dbsp::ingest('user', \"DELETE\", <string>($before.id OR \"\"), $plain_before);\n    FOR $u IN $dbsp_ok.updates {\n        UPDATE _spooky_incantation SET hash = $u.result_hash, tree = $u.tree WHERE id = $u.query_id;\n    };\n    LET $saved = mod::dbsp::save_state(NONE);\n\n    LET $old_hash_data = (SELECT * FROM <record>(\"_spooky_data_hash:\" + crypto::blake3(<string>$before.id)))[0];\n    LET $old_total = $old_hash_data.totalHash;\n\n    LET $hash_id = <record>(\"_spooky_data_hash:\" + crypto::blake3(<string>$before.id));\n    DELETE $hash_id;\n};\n\n" [3mcapabilities[0m[2m=[0mCapabilities { scripting: true, guest_access: true, live_query_notifications: true, allow_funcs: All, deny_funcs: None, allow_net: All, deny_net: None, allow_rpc: All, deny_rpc: None, allow_http: All, deny_http: None, allow_experimental: All, deny_experimental: None, allow_arbitrary_query: All, deny_arbitrary_query: None } [3mlength[0m[2m=[0m25361[0m
[2m2025-12-30T20:23:55.366844Z[0m [34mDEBUG[0m [1mrequest[0m:[1mexecute[0m:[1mprocess[0m:[1mexecutor[0m:[1mexecutor[0m:[1mexecutor[0m: [2msurrealdb_core::iam::file[0m[2m:[0m Allowed bucket folder path: /modules [2m[3motel.kind[0m[2m=[0m"server" [3mhttp.request.method[0m[2m=[0m"POST" [3murl.path[0m[2m=[0m"/rpc" [3mnetwork.protocol.name[0m[2m=[0m"http" [3mnetwork.protocol.version[0m[2m=[0m"1.1" [3mhttp.request.body.size[0m[2m=[0m"25408" [3muser_agent.original[0m[2m=[0m"node" [3motel.name[0m[2m=[0m"POST /rpc" [3mhttp.route[0m[2m=[0m"/rpc" [3mhttp.request.id[0m[2m=[0m"1d9da004-dd48-40b1-b422-f5b80fac856c" [3mclient.address[0m[2m=[0m"192.168.65.1"[0m
[2m2025-12-30T20:23:55.369938Z[0m [34mDEBUG[0m [1mrequest[0m: [2msurrealdb_server::ntw::tracer[0m[2m:[0m Finished processing request [2m[3motel.kind[0m[2m=[0m"server" [3mhttp.request.method[0m[2m=[0m"POST" [3murl.path[0m[2m=[0m"/rpc" [3mnetwork.protocol.name[0m[2m=[0m"http" [3mnetwork.protocol.version[0m[2m=[0m"1.1" [3mhttp.request.body.size[0m[2m=[0m"25408" [3muser_agent.original[0m[2m=[0m"node" [3motel.name[0m[2m=[0m"POST /rpc" [3mhttp.route[0m[2m=[0m"/rpc" [3mhttp.request.id[0m[2m=[0m"1d9da004-dd48-40b1-b422-f5b80fac856c" [3mclient.address[0m[2m=[0m"192.168.65.1" [3mhttp.response.status_code[0m[2m=[0m200 [3mhttp.latency.ms[0m[2m=[0m4[0m
[2m2025-12-30T20:23:55.374021Z[0m [34mDEBUG[0m [1mrequest[0m: [2msurrealdb_server::ntw::tracer[0m[2m:[0m Started processing request [2m[3motel.kind[0m[2m=[0m"server" [3mhttp.request.method[0m[2m=[0m"POST" [3murl.path[0m[2m=[0m"/rpc" [3mnetwork.protocol.name[0m[2m=[0m"http" [3mnetwork.protocol.version[0m[2m=[0m"1.1" [3mhttp.request.body.size[0m[2m=[0m"73" [3muser_agent.original[0m[2m=[0m"node" [3motel.name[0m[2m=[0m"POST /rpc" [3mhttp.route[0m[2m=[0m"/rpc" [3mhttp.request.id[0m[2m=[0m"d3a1cc4c-dc72-4fb6-870e-f22b40002841" [3mclient.address[0m[2m=[0m"192.168.65.1"[0m
[2m2025-12-30T20:23:55.374039Z[0m [35mTRACE[0m [1mrequest[0m: [2msurrealdb_core::iam::verify[0m[2m:[0m Attempting token authentication [2m[3motel.kind[0m[2m=[0m"server" [3mhttp.request.method[0m[2m=[0m"POST" [3murl.path[0m[2m=[0m"/rpc" [3mnetwork.protocol.name[0m[2m=[0m"http" [3mnetwork.protocol.version[0m[2m=[0m"1.1" [3mhttp.request.body.size[0m[2m=[0m"73" [3muser_agent.original[0m[2m=[0m"node" [3motel.name[0m[2m=[0m"POST /rpc" [3mhttp.route[0m[2m=[0m"/rpc" [3mhttp.request.id[0m[2m=[0m"d3a1cc4c-dc72-4fb6-870e-f22b40002841" [3mclient.address[0m[2m=[0m"192.168.65.1"[0m
[2m2025-12-30T20:23:55.374051Z[0m [35mTRACE[0m [1mrequest[0m: [2msurrealdb_core::iam::verify[0m[2m:[0m Authenticating to root level with user `root` [2m[3motel.kind[0m[2m=[0m"server" [3mhttp.request.method[0m[2m=[0m"POST" [3murl.path[0m[2m=[0m"/rpc" [3mnetwork.protocol.name[0m[2m=[0m"http" [3mnetwork.protocol.version[0m[2m=[0m"1.1" [3mhttp.request.body.size[0m[2m=[0m"73" [3muser_agent.original[0m[2m=[0m"node" [3motel.name[0m[2m=[0m"POST /rpc" [3mhttp.route[0m[2m=[0m"/rpc" [3mhttp.request.id[0m[2m=[0m"d3a1cc4c-dc72-4fb6-870e-f22b40002841" [3mclient.address[0m[2m=[0m"192.168.65.1"[0m
[2m2025-12-30T20:23:55.374097Z[0m [34mDEBUG[0m [1mrequest[0m: [2msurrealdb_core::iam::verify[0m[2m:[0m Authenticated to root level with user `root` using token [2m[3motel.kind[0m[2m=[0m"server" [3mhttp.request.method[0m[2m=[0m"POST" [3murl.path[0m[2m=[0m"/rpc" [3mnetwork.protocol.name[0m[2m=[0m"http" [3mnetwork.protocol.version[0m[2m=[0m"1.1" [3mhttp.request.body.size[0m[2m=[0m"73" [3muser_agent.original[0m[2m=[0m"node" [3motel.name[0m[2m=[0m"POST /rpc" [3mhttp.route[0m[2m=[0m"/rpc" [3mhttp.request.id[0m[2m=[0m"d3a1cc4c-dc72-4fb6-870e-f22b40002841" [3mclient.address[0m[2m=[0m"192.168.65.1"[0m
[2m2025-12-30T20:23:55.374134Z[0m [35mTRACE[0m [1mrequest[0m:[1mexecute[0m:[1mparse_with_capabilities[0m: [2msurrealdb::core::syn[0m[2m:[0m Parsing SurrealQL query [2m[3motel.kind[0m[2m=[0m"server" [3mhttp.request.method[0m[2m=[0m"POST" [3murl.path[0m[2m=[0m"/rpc" [3mnetwork.protocol.name[0m[2m=[0m"http" [3mnetwork.protocol.version[0m[2m=[0m"1.1" [3mhttp.request.body.size[0m[2m=[0m"73" [3muser_agent.original[0m[2m=[0m"node" [3motel.name[0m[2m=[0m"POST /rpc" [3mhttp.route[0m[2m=[0m"/rpc" [3mhttp.request.id[0m[2m=[0m"d3a1cc4c-dc72-4fb6-870e-f22b40002841" [3mclient.address[0m[2m=[0m"192.168.65.1"[0m [2m[3minput[0m[2m=[0m"RETURN mod::dbsp::reset({})" [3mcapabilities[0m[2m=[0mCapabilities { scripting: true, guest_access: true, live_query_notifications: true, allow_funcs: All, deny_funcs: None, allow_net: All, deny_net: None, allow_rpc: All, deny_rpc: None, allow_http: All, deny_http: None, allow_experimental: All, deny_experimental: None, allow_arbitrary_query: All, deny_arbitrary_query: None } [3mlength[0m[2m=[0m27[0m
[2m2025-12-30T20:23:55.374169Z[0m [35mTRACE[0m [1mrequest[0m:[1mexecute[0m:[1mprocess[0m:[1mexecutor[0m:[1mexecutor[0m:[1mexecutor[0m: [2msurrealdb_core::ctx::context[0m[2m:[0m Capabilities allowed function execution, target: 'mod::dbsp::reset' [2m[3motel.kind[0m[2m=[0m"server" [3mhttp.request.method[0m[2m=[0m"POST" [3murl.path[0m[2m=[0m"/rpc" [3mnetwork.protocol.name[0m[2m=[0m"http" [3mnetwork.protocol.version[0m[2m=[0m"1.1" [3mhttp.request.body.size[0m[2m=[0m"73" [3muser_agent.original[0m[2m=[0m"node" [3motel.name[0m[2m=[0m"POST /rpc" [3mhttp.route[0m[2m=[0m"/rpc" [3mhttp.request.id[0m[2m=[0m"d3a1cc4c-dc72-4fb6-870e-f22b40002841" [3mclient.address[0m[2m=[0m"192.168.65.1"[0m
  console.error
    Reset Failed: ResponseError: Failed to read config file from archive: stream did not contain valid UTF-8
        at Query.collect (/Users/khadim/dev/spooky/node_modules/.pnpm/surrealdb@2.0.0-alpha.14_tslib@2.8.1_typescript@5.9.3/node_modules/surrealdb/dist/surrealdb.cjs:3136:27)
        at processTicksAndRejections (node:internal/process/task_queues:95:5)
        at runQuery (/Users/khadim/dev/spooky/tests/surrealdb/dbsp.test.ts:9:12)
        at Object.<anonymous> (/Users/khadim/dev/spooky/tests/surrealdb/dbsp.test.ts:17:7) {
      code: 0
    }

      17 |       await runQuery('RETURN mod::dbsp::reset({})');
      18 |     } catch (e: any) {
    > 19 |       console.error('Reset Failed:', e);
         |               ^
      20 |       if (e.cause) console.error('Reset Cause:', e.cause);
      21 |       throw e;
      22 |     }

      at Object.<anonymous> (surrealdb/dbsp.test.ts:19:15)

[2m2025-12-30T20:23:55.413530Z[0m [34mDEBUG[0m [1mrequest[0m: [2msurrealdb_server::ntw::tracer[0m[2m:[0m Finished processing request [2m[3motel.kind[0m[2m=[0m"server" [3mhttp.request.method[0m[2m=[0m"POST" [3murl.path[0m[2m=[0m"/rpc" [3mnetwork.protocol.name[0m[2m=[0m"http" [3mnetwork.protocol.version[0m[2m=[0m"1.1" [3mhttp.request.body.size[0m[2m=[0m"73" [3muser_agent.original[0m[2m=[0m"node" [3motel.name[0m[2m=[0m"POST /rpc" [3mhttp.route[0m[2m=[0m"/rpc" [3mhttp.request.id[0m[2m=[0m"d3a1cc4c-dc72-4fb6-870e-f22b40002841" [3mclient.address[0m[2m=[0m"192.168.65.1" [3mhttp.response.status_code[0m[2m=[0m200 [3mhttp.latency.ms[0m[2m=[0m39[0m
[2m2025-12-30T20:23:55.424181Z[0m [34mDEBUG[0m [1mrequest[0m: [2msurrealdb_server::ntw::tracer[0m[2m:[0m Started processing request [2m[3motel.kind[0m[2m=[0m"server" [3mhttp.request.method[0m[2m=[0m"POST" [3murl.path[0m[2m=[0m"/rpc" [3mnetwork.protocol.name[0m[2m=[0m"http" [3mnetwork.protocol.version[0m[2m=[0m"1.1" [3mhttp.request.body.size[0m[2m=[0m"70" [3muser_agent.original[0m[2m=[0m"node" [3motel.name[0m[2m=[0m"POST /rpc" [3mhttp.route[0m[2m=[0m"/rpc" [3mhttp.request.id[0m[2m=[0m"ae3d5395-83eb-4591-bc36-55d3e6fd07ee" [3mclient.address[0m[2m=[0m"192.168.65.1"[0m
[2m2025-12-30T20:23:55.424201Z[0m [35mTRACE[0m [1mrequest[0m: [2msurrealdb_core::iam::verify[0m[2m:[0m Attempting token authentication [2m[3motel.kind[0m[2m=[0m"server" [3mhttp.request.method[0m[2m=[0m"POST" [3murl.path[0m[2m=[0m"/rpc" [3mnetwork.protocol.name[0m[2m=[0m"http" [3mnetwork.protocol.version[0m[2m=[0m"1.1" [3mhttp.request.body.size[0m[2m=[0m"70" [3muser_agent.original[0m[2m=[0m"node" [3motel.name[0m[2m=[0m"POST /rpc" [3mhttp.route[0m[2m=[0m"/rpc" [3mhttp.request.id[0m[2m=[0m"ae3d5395-83eb-4591-bc36-55d3e6fd07ee" [3mclient.address[0m[2m=[0m"192.168.65.1"[0m
[2m2025-12-30T20:23:55.424215Z[0m [35mTRACE[0m [1mrequest[0m: [2msurrealdb_core::iam::verify[0m[2m:[0m Authenticating to root level with user `root` [2m[3motel.kind[0m[2m=[0m"server" [3mhttp.request.method[0m[2m=[0m"POST" [3murl.path[0m[2m=[0m"/rpc" [3mnetwork.protocol.name[0m[2m=[0m"http" [3mnetwork.protocol.version[0m[2m=[0m"1.1" [3mhttp.request.body.size[0m[2m=[0m"70" [3muser_agent.original[0m[2m=[0m"node" [3motel.name[0m[2m=[0m"POST /rpc" [3mhttp.route[0m[2m=[0m"/rpc" [3mhttp.request.id[0m[2m=[0m"ae3d5395-83eb-4591-bc36-55d3e6fd07ee" [3mclient.address[0m[2m=[0m"192.168.65.1"[0m
[2m2025-12-30T20:23:55.424255Z[0m [34mDEBUG[0m [1mrequest[0m: [2msurrealdb_core::iam::verify[0m[2m:[0m Authenticated to root level with user `root` using token [2m[3motel.kind[0m[2m=[0m"server" [3mhttp.request.method[0m[2m=[0m"POST" [3murl.path[0m[2m=[0m"/rpc" [3mnetwork.protocol.name[0m[2m=[0m"http" [3mnetwork.protocol.version[0m[2m=[0m"1.1" [3mhttp.request.body.size[0m[2m=[0m"70" [3muser_agent.original[0m[2m=[0m"node" [3motel.name[0m[2m=[0m"POST /rpc" [3mhttp.route[0m[2m=[0m"/rpc" [3mhttp.request.id[0m[2m=[0m"ae3d5395-83eb-4591-bc36-55d3e6fd07ee" [3mclient.address[0m[2m=[0m"192.168.65.1"[0m
[2m2025-12-30T20:23:55.424301Z[0m [35mTRACE[0m [1mrequest[0m:[1mexecute[0m:[1mparse_with_capabilities[0m: [2msurrealdb::core::syn[0m[2m:[0m Parsing SurrealQL query [2m[3motel.kind[0m[2m=[0m"server" [3mhttp.request.method[0m[2m=[0m"POST" [3murl.path[0m[2m=[0m"/rpc" [3mnetwork.protocol.name[0m[2m=[0m"http" [3mnetwork.protocol.version[0m[2m=[0m"1.1" [3mhttp.request.body.size[0m[2m=[0m"70" [3muser_agent.original[0m[2m=[0m"node" [3motel.name[0m[2m=[0m"POST /rpc" [3mhttp.route[0m[2m=[0m"/rpc" [3mhttp.request.id[0m[2m=[0m"ae3d5395-83eb-4591-bc36-55d3e6fd07ee" [3mclient.address[0m[2m=[0m"192.168.65.1"[0m [2m[3minput[0m[2m=[0m"REMOVE DATABASE test_db;" [3mcapabilities[0m[2m=[0mCapabilities { scripting: true, guest_access: true, live_query_notifications: true, allow_funcs: All, deny_funcs: None, allow_net: All, deny_net: None, allow_rpc: All, deny_rpc: None, allow_http: All, deny_http: None, allow_experimental: All, deny_experimental: None, allow_arbitrary_query: All, deny_arbitrary_query: None } [3mlength[0m[2m=[0m24[0m
[2m2025-12-30T20:23:55.424686Z[0m [34mDEBUG[0m [1mrequest[0m: [2msurrealdb_server::ntw::tracer[0m[2m:[0m Finished processing request [2m[3motel.kind[0m[2m=[0m"server" [3mhttp.request.method[0m[2m=[0m"POST" [3murl.path[0m[2m=[0m"/rpc" [3mnetwork.protocol.name[0m[2m=[0m"http" [3mnetwork.protocol.version[0m[2m=[0m"1.1" [3mhttp.request.body.size[0m[2m=[0m"70" [3muser_agent.original[0m[2m=[0m"node" [3motel.name[0m[2m=[0m"POST /rpc" [3mhttp.route[0m[2m=[0m"/rpc" [3mhttp.request.id[0m[2m=[0m"ae3d5395-83eb-4591-bc36-55d3e6fd07ee" [3mclient.address[0m[2m=[0m"192.168.65.1" [3mhttp.response.status_code[0m[2m=[0m200 [3mhttp.latency.ms[0m[2m=[0m0[0m
FAIL surrealdb/dbsp.test.ts
  DBSP Module Integration
    ‚úï should register a view and ingest data with incremental updates (1 ms)
    ‚úï should support multiple concurrent views
    ‚úï should register a complex join plan (SQL)
    ‚úï should update id tree on data change
    ‚úï should support complex recursive join with subquery via SQL
    ‚úï should handle limit eviction
    ‚úï should handle nested limit via subquery projection (SQL)
    ‚úï Full Scenario: Social Network End-to-End
    ‚úï should handle ORDER BY and OR logic
    ‚úï should handle complex AND/OR and multi-field ORDER BY

  ‚óè DBSP Module Integration ‚Ä∫ should register a view and ingest data with incremental updates

    ResponseError: Failed to read config file from archive: stream did not contain valid UTF-8

       7 |   async function runQuery(query: string) {
       8 |     // Explicitly cast to any to call .collect() which exists on the PendingQuery object in v2-alpha
    >  9 |     return await (db.query(query) as any).collect();
         |            ^
      10 |   }
      11 |
      12 |   beforeAll(async () => {

      at Query.collect (../node_modules/.pnpm/surrealdb@2.0.0-alpha.14_tslib@2.8.1_typescript@5.9.3/node_modules/surrealdb/dist/surrealdb.cjs:3136:27)
      at runQuery (surrealdb/dbsp.test.ts:9:12)
      at Object.<anonymous> (surrealdb/dbsp.test.ts:17:7)

  ‚óè DBSP Module Integration ‚Ä∫ should support multiple concurrent views

    ResponseError: Failed to read config file from archive: stream did not contain valid UTF-8

       7 |   async function runQuery(query: string) {
       8 |     // Explicitly cast to any to call .collect() which exists on the PendingQuery object in v2-alpha
    >  9 |     return await (db.query(query) as any).collect();
         |            ^
      10 |   }
      11 |
      12 |   beforeAll(async () => {

      at Query.collect (../node_modules/.pnpm/surrealdb@2.0.0-alpha.14_tslib@2.8.1_typescript@5.9.3/node_modules/surrealdb/dist/surrealdb.cjs:3136:27)
      at runQuery (surrealdb/dbsp.test.ts:9:12)
      at Object.<anonymous> (surrealdb/dbsp.test.ts:17:7)

  ‚óè DBSP Module Integration ‚Ä∫ should register a complex join plan (SQL)

    ResponseError: Failed to read config file from archive: stream did not contain valid UTF-8

       7 |   async function runQuery(query: string) {
       8 |     // Explicitly cast to any to call .collect() which exists on the PendingQuery object in v2-alpha
    >  9 |     return await (db.query(query) as any).collect();
         |            ^
      10 |   }
      11 |
      12 |   beforeAll(async () => {

      at Query.collect (../node_modules/.pnpm/surrealdb@2.0.0-alpha.14_tslib@2.8.1_typescript@5.9.3/node_modules/surrealdb/dist/surrealdb.cjs:3136:27)
      at runQuery (surrealdb/dbsp.test.ts:9:12)
      at Object.<anonymous> (surrealdb/dbsp.test.ts:17:7)

  ‚óè DBSP Module Integration ‚Ä∫ should update id tree on data change

    ResponseError: Failed to read config file from archive: stream did not contain valid UTF-8

       7 |   async function runQuery(query: string) {
       8 |     // Explicitly cast to any to call .collect() which exists on the PendingQuery object in v2-alpha
    >  9 |     return await (db.query(query) as any).collect();
         |            ^
      10 |   }
      11 |
      12 |   beforeAll(async () => {

      at Query.collect (../node_modules/.pnpm/surrealdb@2.0.0-alpha.14_tslib@2.8.1_typescript@5.9.3/node_modules/surrealdb/dist/surrealdb.cjs:3136:27)
      at runQuery (surrealdb/dbsp.test.ts:9:12)
      at Object.<anonymous> (surrealdb/dbsp.test.ts:17:7)

  ‚óè DBSP Module Integration ‚Ä∫ should support complex recursive join with subquery via SQL

    ResponseError: Failed to read config file from archive: stream did not contain valid UTF-8

       7 |   async function runQuery(query: string) {
       8 |     // Explicitly cast to any to call .collect() which exists on the PendingQuery object in v2-alpha
    >  9 |     return await (db.query(query) as any).collect();
         |            ^
      10 |   }
      11 |
      12 |   beforeAll(async () => {

      at Query.collect (../node_modules/.pnpm/surrealdb@2.0.0-alpha.14_tslib@2.8.1_typescript@5.9.3/node_modules/surrealdb/dist/surrealdb.cjs:3136:27)
      at runQuery (surrealdb/dbsp.test.ts:9:12)
      at Object.<anonymous> (surrealdb/dbsp.test.ts:17:7)

  ‚óè DBSP Module Integration ‚Ä∫ should handle limit eviction

    ResponseError: Failed to read config file from archive: stream did not contain valid UTF-8

       7 |   async function runQuery(query: string) {
       8 |     // Explicitly cast to any to call .collect() which exists on the PendingQuery object in v2-alpha
    >  9 |     return await (db.query(query) as any).collect();
         |            ^
      10 |   }
      11 |
      12 |   beforeAll(async () => {

      at Query.collect (../node_modules/.pnpm/surrealdb@2.0.0-alpha.14_tslib@2.8.1_typescript@5.9.3/node_modules/surrealdb/dist/surrealdb.cjs:3136:27)
      at runQuery (surrealdb/dbsp.test.ts:9:12)
      at Object.<anonymous> (surrealdb/dbsp.test.ts:17:7)

  ‚óè DBSP Module Integration ‚Ä∫ should handle nested limit via subquery projection (SQL)

    ResponseError: Failed to read config file from archive: stream did not contain valid UTF-8

       7 |   async function runQuery(query: string) {
       8 |     // Explicitly cast to any to call .collect() which exists on the PendingQuery object in v2-alpha
    >  9 |     return await (db.query(query) as any).collect();
         |            ^
      10 |   }
      11 |
      12 |   beforeAll(async () => {

      at Query.collect (../node_modules/.pnpm/surrealdb@2.0.0-alpha.14_tslib@2.8.1_typescript@5.9.3/node_modules/surrealdb/dist/surrealdb.cjs:3136:27)
      at runQuery (surrealdb/dbsp.test.ts:9:12)
      at Object.<anonymous> (surrealdb/dbsp.test.ts:17:7)

  ‚óè DBSP Module Integration ‚Ä∫ Full Scenario: Social Network End-to-End

    ResponseError: Failed to read config file from archive: stream did not contain valid UTF-8

       7 |   async function runQuery(query: string) {
       8 |     // Explicitly cast to any to call .collect() which exists on the PendingQuery object in v2-alpha
    >  9 |     return await (db.query(query) as any).collect();
         |            ^
      10 |   }
      11 |
      12 |   beforeAll(async () => {

      at Query.collect (../node_modules/.pnpm/surrealdb@2.0.0-alpha.14_tslib@2.8.1_typescript@5.9.3/node_modules/surrealdb/dist/surrealdb.cjs:3136:27)
      at runQuery (surrealdb/dbsp.test.ts:9:12)
      at Object.<anonymous> (surrealdb/dbsp.test.ts:17:7)

  ‚óè DBSP Module Integration ‚Ä∫ should handle ORDER BY and OR logic

    ResponseError: Failed to read config file from archive: stream did not contain valid UTF-8

       7 |   async function runQuery(query: string) {
       8 |     // Explicitly cast to any to call .collect() which exists on the PendingQuery object in v2-alpha
    >  9 |     return await (db.query(query) as any).collect();
         |            ^
      10 |   }
      11 |
      12 |   beforeAll(async () => {

      at Query.collect (../node_modules/.pnpm/surrealdb@2.0.0-alpha.14_tslib@2.8.1_typescript@5.9.3/node_modules/surrealdb/dist/surrealdb.cjs:3136:27)
      at runQuery (surrealdb/dbsp.test.ts:9:12)
      at Object.<anonymous> (surrealdb/dbsp.test.ts:17:7)

  ‚óè DBSP Module Integration ‚Ä∫ should handle complex AND/OR and multi-field ORDER BY

    ResponseError: Failed to read config file from archive: stream did not contain valid UTF-8

       7 |   async function runQuery(query: string) {
       8 |     // Explicitly cast to any to call .collect() which exists on the PendingQuery object in v2-alpha
    >  9 |     return await (db.query(query) as any).collect();
         |            ^
      10 |   }
      11 |
      12 |   beforeAll(async () => {

      at Query.collect (../node_modules/.pnpm/surrealdb@2.0.0-alpha.14_tslib@2.8.1_typescript@5.9.3/node_modules/surrealdb/dist/surrealdb.cjs:3136:27)
      at runQuery (surrealdb/dbsp.test.ts:9:12)
      at Object.<anonymous> (surrealdb/dbsp.test.ts:17:7)

Test Suites: 1 failed, 1 total
Tests:       10 failed, 10 total
Snapshots:   0 total
Time:        1.424 s, estimated 2 s
Ran all test suites matching /surrealdb\/dbsp.test.ts/i.
Force exiting Jest: Have you considered using `--detectOpenHandles` to detect async operations that kept running after all tests finished?
/Users/khadim/dev/spooky/tests:
‚ÄâERR_PNPM_RECURSIVE_RUN_FIRST_FAIL‚Äâ @spooky/tests@0.0.0 test: `jest --runInBand surrealdb/dbsp.test.ts`
Exit status 1
