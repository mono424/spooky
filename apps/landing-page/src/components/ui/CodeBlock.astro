---
import { Code } from 'astro:components';

interface Props {
  code: string;
  lang?: string;
  fileName?: string;
}

const { code, lang = 'bash', fileName } = Astro.props;

const languageMap: Record<string, string> = {
  typescript: 'TypeScript',
  ts: 'TypeScript',
  javascript: 'JavaScript',
  js: 'JavaScript',
  sql: 'sql',
  bash: 'Bash',
  sh: 'Shell',
  json: 'JSON',
  html: 'HTML',
  css: 'CSS',
};

const displayName = languageMap[lang.toLowerCase()] || lang;
---

<div
  class="code-block-wrapper my-6 rounded-lg border border-border bg-[#0c0c0e] overflow-hidden group"
>
  {/* Header: Only shows if fileName is provided */}
  {
    fileName && (
      <div class="flex items-center justify-between px-4 py-3 border-b border-border bg-[#121212]">
        <span class="text-xs font-mono text-text-muted">{fileName}</span>

        {/* Mac-style window dots */}
        <div class="flex gap-1.5 opacity-50">
          <div class="w-2.5 h-2.5 rounded-full bg-[#27272a]" />
          <div class="w-2.5 h-2.5 rounded-full bg-[#27272a]" />
          <div class="w-2.5 h-2.5 rounded-full bg-[#27272a]" />
        </div>
      </div>
    )
  }

  <div class="relative">
    {/* Language Label */}
    <span
      class="absolute top-3 right-12 px-2 py-1 text-[10px] font-mono font-medium text-text-muted uppercase tracking-wider opacity-0 group-hover:opacity-100 transition-opacity duration-200 select-none"
    >
      {displayName}
    </span>

    {/* Copy Button */}
    <button
      class="copy-btn absolute top-3 right-3 p-2 rounded-md bg-surface/50 border border-border/50 text-text-muted opacity-0 group-hover:opacity-100 transition-all duration-200 hover:bg-surface hover:text-text-main focus:opacity-100 focus:outline-none focus:ring-2 focus:ring-primary/50 backdrop-blur-sm z-10"
      aria-label="Copy to clipboard"
      data-code={code}
    >
      <svg class="copy-icon w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
        ></path>
      </svg>
      <svg
        class="check-icon w-4 h-4 hidden text-green-400"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"
        ></path>
      </svg>
    </button>

    {/* The Actual Code */}
    <div class="p-4 text-sm font-mono leading-relaxed overflow-x-auto custom-scrollbar">
      {
        /* Use 'github-dark' or 'poimandres' for a good dark theme. 
         We wrap it in a div that handles the background color, 
         so we make Shiki transparent below.
      */
      }
      <Code code={code} lang={lang as any} theme="github-dark" />
    </div>
  </div>
</div>

<script>
  const copyButtons = document.querySelectorAll('.copy-btn');

  copyButtons.forEach((btn) => {
    btn.addEventListener('click', async () => {
      const code = btn.getAttribute('data-code');
      const copyIcon = btn.querySelector('.copy-icon');
      const checkIcon = btn.querySelector('.check-icon');

      if (!code || !copyIcon || !checkIcon) return;

      try {
        await navigator.clipboard.writeText(code);
        copyIcon.classList.add('hidden');
        checkIcon.classList.remove('hidden');
        setTimeout(() => {
          copyIcon.classList.remove('hidden');
          checkIcon.classList.add('hidden');
        }, 2000);
      } catch (err) {
        console.error('Failed to copy!', err);
      }
    });
  });
</script>

<style is:global>
  /* Important: We only override the background-color here.
     We removed the 'color' override so the syntax highlighting shows through.
  */
  .astro-code {
    background-color: transparent !important;
    overflow-x: visible !important; /* Let parent handle overflow */
  }

  /* Custom Scrollbar */
  .custom-scrollbar::-webkit-scrollbar {
    height: 8px;
  }
  .custom-scrollbar::-webkit-scrollbar-track {
    background: transparent;
  }
  .custom-scrollbar::-webkit-scrollbar-thumb {
    background-color: #27272a;
    border-radius: 4px;
  }
  .custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background-color: #3f3f46;
  }
</style>
